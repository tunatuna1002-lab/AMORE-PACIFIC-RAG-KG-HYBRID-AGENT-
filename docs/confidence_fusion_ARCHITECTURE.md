# Confidence Fusion 아키텍처

다중 소스 신뢰도 통합 아키텍처 다이어그램

---

## 전체 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────────┐
│                        User Query                               │
│                   "LANEIGE 분석해줘"                            │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
        ┌────────────────────────────────────────┐
        │      HybridRetriever                   │
        │   (retrieve_with_confidence)           │
        └─┬──────────────┬─────────────┬─────────┘
          │              │             │
          ▼              ▼             ▼
    ┌─────────┐   ┌──────────┐   ┌──────────┐
    │ Vector  │   │ Ontology │   │ Entity   │
    │ Search  │   │ Reasoner │   │ Linker   │
    └────┬────┘   └─────┬────┘   └────┬─────┘
         │              │              │
         │ Documents    │ Insights     │ Entities
         │ (0.92)       │ (0.88)       │ (0.90)
         │              │              │
         └──────────────┴──────────────┘
                        │
                        ▼
            ┌───────────────────────┐
            │  ConfidenceFusion     │
            │  • Normalize scores   │
            │  • Apply weights      │
            │  • Detect conflicts   │
            │  • Generate explain   │
            └───────────┬───────────┘
                        │
                        ▼
            ┌───────────────────────┐
            │    FusedResult        │
            │  confidence: 0.85     │
            │  level: HIGH          │
            │  explanation: "..."   │
            │  source_breakdown     │
            └───────────┬───────────┘
                        │
                        ▼
            ┌───────────────────────┐
            │   Chatbot Agent       │
            │  • Decide tone        │
            │  • Generate response  │
            └───────────────────────┘
```

---

## ConfidenceFusion 내부 구조

```
┌─────────────────────────────────────────────────────────────────┐
│                    ConfidenceFusion                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Input:                                                         │
│    • vector_results:    [SearchResult, ...]                    │
│    • ontology_results:  [InferenceResult, ...]                 │
│    • entity_links:      [LinkedEntity, ...]                    │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Step 1: Collect Sources                                       │
│    ┌──────────┐  ┌───────────┐  ┌────────┐                   │
│    │  Vector  │  │ Ontology  │  │ Entity │                   │
│    │  0.92    │  │  0.88     │  │  0.90  │                   │
│    └──────────┘  └───────────┘  └────────┘                   │
│                                                                 │
│  Step 2: Compute Scores (per source)                          │
│    • Vector:    Top-K average (상위 3개 평균)                  │
│    • Ontology:  Max confidence (최고 신뢰도)                   │
│    • Entity:    Mean confidence (평균 연결 강도)               │
│                                                                 │
│  Step 3: Normalize Scores                                     │
│    ┌────────────────────────────────────────┐                 │
│    │  Method: MIN_MAX (default)             │                 │
│    │                                         │                 │
│    │  Before:  0.92  0.88  0.90             │                 │
│    │           ▼     ▼     ▼                │                 │
│    │  After:   1.00  0.00  0.50             │                 │
│    │                                         │                 │
│    │  Formula: (x - min) / (max - min)      │                 │
│    └────────────────────────────────────────┘                 │
│                                                                 │
│  Step 4: Apply Weights                                        │
│    ┌────────────────────────────────────────┐                 │
│    │  Vector:    1.00 × 0.40 = 0.400        │                 │
│    │  Ontology:  0.00 × 0.35 = 0.000        │                 │
│    │  Entity:    0.50 × 0.25 = 0.125        │                 │
│    └────────────────────────────────────────┘                 │
│                                                                 │
│  Step 5: Fusion Strategy (WEIGHTED_SUM)                       │
│    ┌────────────────────────────────────────┐                 │
│    │  confidence = 0.400 + 0.000 + 0.125    │                 │
│    │             = 0.525                     │                 │
│    └────────────────────────────────────────┘                 │
│                                                                 │
│  Step 6: Detect Conflicts                                     │
│    ┌────────────────────────────────────────┐                 │
│    │  Max: 1.00   Min: 0.00                 │                 │
│    │  Diff: 1.00 > 0.3 (threshold)          │                 │
│    │  → Warning: "점수 불일치 감지"          │                 │
│    └────────────────────────────────────────┘                 │
│                                                                 │
│  Step 7: Generate Explanation                                 │
│    ┌────────────────────────────────────────┐                 │
│    │  "중간 수준의 신뢰도 (최종 점수:       │                 │
│    │   0.53)로 관련성이 있습니다.            │                 │
│    │   주요 근거: vector(0.40)"              │                 │
│    └────────────────────────────────────────┘                 │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Output: FusedResult                                           │
│    • confidence:      0.525                                    │
│    • level:          "MEDIUM"                                  │
│    • explanation:    "중간 수준의 신뢰도..."                   │
│    • source_scores:  [SourceScore, ...]                       │
│    • warnings:       ["점수 불일치 감지"]                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 데이터 흐름 (Data Flow)

```
┌─────────────┐
│   Query     │
│ "LANEIGE"   │
└──────┬──────┘
       │
       ├──────────────────────────────────────┐
       │                                      │
       ▼                                      ▼
┌─────────────────┐                  ┌─────────────────┐
│ Vector Search   │                  │ Ontology        │
│ (DocumentRet.)  │                  │ Reasoner        │
├─────────────────┤                  ├─────────────────┤
│ • Keyword       │                  │ • Rules         │
│ • Semantic      │                  │ • Inference     │
│ • BM25          │                  │ • Evidence      │
└────────┬────────┘                  └────────┬────────┘
         │                                    │
         │ List[Dict]                         │ List[Dict]
         │                                    │
         ▼                                    ▼
┌─────────────────┐                  ┌─────────────────┐
│ SearchResult    │                  │ InferenceResult │
├─────────────────┤                  ├─────────────────┤
│ content: str    │                  │ insight: str    │
│ score: 0.92     │                  │ confidence: 0.88│
│ metadata: {...} │                  │ evidence: {...} │
└────────┬────────┘                  └────────┬────────┘
         │                                    │
         └────────────┬───────────────────────┘
                      │
                      │ + entity_links
                      ▼
         ┌────────────────────────┐
         │  ConfidenceFusion      │
         │  .fuse()               │
         └────────────┬───────────┘
                      │
                      ▼
         ┌────────────────────────┐
         │    FusedResult         │
         ├────────────────────────┤
         │ confidence: 0.85       │
         │ documents: [...]       │
         │ source_scores: [...]   │
         │ explanation: "..."     │
         │ warnings: [...]        │
         └────────────────────────┘
```

---

## 융합 전략 비교

```
┌─────────────────────────────────────────────────────────────────┐
│                  Fusion Strategies                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Given scores: Vector=0.9, Ontology=0.7, Entity=0.8            │
│  Weights:      0.40,       0.35,         0.25                  │
│                                                                 │
│  1. WEIGHTED_SUM (기본) ✅                                      │
│     confidence = 0.9×0.4 + 0.7×0.35 + 0.8×0.25                 │
│                = 0.36 + 0.245 + 0.20                            │
│                = 0.805                                          │
│     특징: 균형잡힌 결과, 모든 소스 반영                         │
│                                                                 │
│  2. HARMONIC_MEAN (보수적)                                     │
│     confidence = 1 / (0.4/0.9 + 0.35/0.7 + 0.25/0.8)           │
│                = 1 / (0.444 + 0.500 + 0.313)                    │
│                = 1 / 1.257 = 0.795                              │
│     특징: 낮은 점수가 전체를 끌어내림                           │
│                                                                 │
│  3. GEOMETRIC_MEAN                                             │
│     confidence = (0.9^0.4) × (0.7^0.35) × (0.8^0.25)           │
│                = 0.959 × 0.881 × 0.946                          │
│                = 0.799                                          │
│     특징: Weighted Sum보다 약간 보수적                         │
│                                                                 │
│  4. MAX_SCORE (낙관적)                                         │
│     confidence = max(0.9, 0.7, 0.8)                            │
│                = 0.9                                            │
│     특징: 가장 높은 점수 사용                                   │
│                                                                 │
│  5. MIN_SCORE (매우 보수적)                                    │
│     confidence = min(0.9, 0.7, 0.8)                            │
│                = 0.7                                            │
│     특징: 가장 낮은 점수 사용                                   │
│                                                                 │
│  Ranking: MIN < HARMONIC < GEOMETRIC ≈ WEIGHTED < MAX          │
│           0.7    0.795      0.799       0.805      0.9          │
│           ↑                                            ↑        │
│         보수적                                       낙관적      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 정규화 방법 비교

```
┌─────────────────────────────────────────────────────────────────┐
│               Normalization Methods                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Original Scores: Vector=0.95, Ontology=0.88, Entity=0.90      │
│                                                                 │
│  1. MIN_MAX (기본) ✅                                           │
│     ┌────────────────────────────────────┐                     │
│     │  Vector:   (0.95-0.88)/(0.95-0.88) │                     │
│     │          = 0.07 / 0.07 = 1.00      │                     │
│     │  Ontology: (0.88-0.88)/(0.95-0.88) │                     │
│     │          = 0.00 / 0.07 = 0.00      │                     │
│     │  Entity:   (0.90-0.88)/(0.95-0.88) │                     │
│     │          = 0.02 / 0.07 = 0.29      │                     │
│     └────────────────────────────────────┘                     │
│     문제: 모두 높은 점수인데 상대화되어 0~1로 펼쳐짐          │
│     해결: 정규화 없이 사용 (NONE)                              │
│                                                                 │
│  2. SOFTMAX                                                    │
│     ┌────────────────────────────────────┐                     │
│     │  exp_values = [e^0.95, e^0.88, e^0.90]                  │
│     │             = [2.59, 2.41, 2.46]   │                     │
│     │  sum = 7.46                        │                     │
│     │                                     │                     │
│     │  Vector:   2.59 / 7.46 = 0.347     │                     │
│     │  Ontology: 2.41 / 7.46 = 0.323     │                     │
│     │  Entity:   2.46 / 7.46 = 0.330     │                     │
│     └────────────────────────────────────┘                     │
│     특징: 확률분포 (합=1.0), 상대적 중요도                     │
│                                                                 │
│  3. Z_SCORE                                                    │
│     ┌────────────────────────────────────┐                     │
│     │  mean = 0.91, std = 0.029          │                     │
│     │  Vector:   (0.95-0.91)/0.029       │                     │
│     │          = 1.38 → 0.73 (rescale)   │                     │
│     │  Ontology: (0.88-0.91)/0.029       │                     │
│     │          = -1.03 → 0.33 (rescale)  │                     │
│     │  Entity:   (0.90-0.91)/0.029       │                     │
│     │          = -0.34 → 0.44 (rescale)  │                     │
│     └────────────────────────────────────┘                     │
│     특징: 이상치에 강함, 표준화                                 │
│                                                                 │
│  4. NONE (정규화 없음)                                         │
│     ┌────────────────────────────────────┐                     │
│     │  Vector:   0.95                    │                     │
│     │  Ontology: 0.88                    │                     │
│     │  Entity:   0.90                    │                     │
│     └────────────────────────────────────┘                     │
│     특징: 원본 점수 유지, 모든 점수가 0~1일 때 사용           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 상충 감지 메커니즘

```
┌─────────────────────────────────────────────────────────────────┐
│                  Conflict Detection                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Threshold: 0.3 (기본)                                          │
│                                                                 │
│  Case 1: No Conflict ✅                                         │
│    Scores: [0.85, 0.82, 0.88]                                  │
│    Max - Min = 0.88 - 0.82 = 0.06 < 0.3                        │
│    → No warning                                                 │
│                                                                 │
│  Case 2: Conflict Detected ⚠️                                  │
│    Scores: [0.95, 0.25, 0.80]                                  │
│    Max - Min = 0.95 - 0.25 = 0.70 > 0.3                        │
│    → Warning: "점수 불일치 감지: 최대 0.95 vs 최소 0.25"        │
│                                                                 │
│  Case 3: Extreme Conflict 🚨                                   │
│    Scores: [1.0, 0.1]                                          │
│    Max - Min = 0.9 > 0.3                                        │
│    → Warning + consider using conservative strategy            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 신뢰도 수준 매핑

```
┌─────────────────────────────────────────────────────────────────┐
│              Confidence Level Mapping                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│    1.0 ┬─────────────────────────────────┐                     │
│        │                                 │                     │
│        │          HIGH                   │ • 확신 있는 답변    │
│   0.75 ├─────────────────────────────────┤ • 근거 명확         │
│        │                                 │                     │
│        │          MEDIUM                 │ • 중립적 답변       │
│   0.50 ├─────────────────────────────────┤ • 추가 컨텍스트     │
│        │                                 │                     │
│        │          LOW                    │ • 조심스러운 답변   │
│   0.25 ├─────────────────────────────────┤ • 정보 요청         │
│        │                                 │                     │
│        │          VERY_LOW               │ • 답변 보류         │
│    0.0 └─────────────────────────────────┘ • 정보 부족 명시    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 클래스 다이어그램

```
┌─────────────────────────────────────────────────────────────────┐
│                     Class Diagram                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────────────────┐                      │
│  │   ConfidenceFusion                   │                      │
│  ├──────────────────────────────────────┤                      │
│  │ - weights: Dict[str, float]          │                      │
│  │ - normalization: Method              │                      │
│  │ - strategy: FusionStrategy           │                      │
│  │ - min_sources: int                   │                      │
│  │ - conflict_threshold: float          │                      │
│  ├──────────────────────────────────────┤                      │
│  │ + fuse() -> FusedResult              │                      │
│  │ - _normalize_scores()                │                      │
│  │ - _apply_fusion_strategy()           │                      │
│  │ - _detect_conflicts()                │                      │
│  │ - _generate_explanation()            │                      │
│  └──────────────────────────────────────┘                      │
│                    │                                            │
│                    │ uses                                       │
│                    ▼                                            │
│  ┌──────────────────────────────────────┐                      │
│  │   SearchResult (dataclass)           │                      │
│  ├──────────────────────────────────────┤                      │
│  │ + content: str                       │                      │
│  │ + score: float                       │                      │
│  │ + metadata: Dict                     │                      │
│  │ + source: str                        │                      │
│  └──────────────────────────────────────┘                      │
│                                                                 │
│  ┌──────────────────────────────────────┐                      │
│  │   InferenceResult (dataclass)        │                      │
│  ├──────────────────────────────────────┤                      │
│  │ + insight: str                       │                      │
│  │ + confidence: float                  │                      │
│  │ + evidence: Dict                     │                      │
│  │ + rule_name: Optional[str]           │                      │
│  └──────────────────────────────────────┘                      │
│                                                                 │
│  ┌──────────────────────────────────────┐                      │
│  │   LinkedEntity (dataclass)           │                      │
│  ├──────────────────────────────────────┤                      │
│  │ + entity_id: str                     │                      │
│  │ + entity_name: str                   │                      │
│  │ + entity_type: str                   │                      │
│  │ + link_confidence: float             │                      │
│  └──────────────────────────────────────┘                      │
│                    │                                            │
│                    │ produces                                   │
│                    ▼                                            │
│  ┌──────────────────────────────────────┐                      │
│  │   FusedResult (dataclass)            │                      │
│  ├──────────────────────────────────────┤                      │
│  │ + documents: List[Dict]              │                      │
│  │ + confidence: float                  │                      │
│  │ + explanation: str                   │                      │
│  │ + source_scores: List[SourceScore]   │                      │
│  │ + warnings: List[str]                │                      │
│  ├──────────────────────────────────────┤                      │
│  │ + to_dict() -> Dict                  │                      │
│  └──────────────────────────────────────┘                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

**아키텍처 문서 완료 ✅**
