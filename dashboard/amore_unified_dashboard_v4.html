<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMORE INSIGHT | AI-Powered Beauty Market Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap');

        /*
         * AMOREPACIFIC DESIGN SYSTEM
         * "Harmony of Contrast" - 대비의 조화
         * Amore (부드러움, 감성, 전통) + Pacific (강함, 이성, 미래)
         */
        :root {
            /* === AMOREPACIFIC CI COLORS === */
            --amore-blue: #1F5795;        /* 부드럽고 온화한 - 달 그림자 */
            --pacific-blue: #001C58;      /* 강하고 이지적인 - 깊은 바다 */
            --ap-black: #000000;
            --ap-gray: #7D7D7D;
            --ap-white: #FFFFFF;

            /* === FUNCTIONAL COLORS === */
            --success: #1F5795;           /* Amore Blue로 통일 */
            --warning: #C4A962;           /* 골드 톤 - 프리미엄 */
            --danger: #8B2635;            /* 깊은 레드 - 세련된 경고 */
            --info: #1F5795;

            /* === BACKGROUND === */
            --bg-main: #FAFAFA;
            --bg-card: #FFFFFF;
            --bg-subtle: #F5F5F5;

            /* === TEXT === */
            --text-primary: #001C58;      /* Pacific Blue */
            --text-secondary: #7D7D7D;    /* AP Gray */
            --text-light: #FFFFFF;

            /* === BORDERS & SHADOWS === */
            --border-light: #E8E8E8;
            --border-medium: #D0D0D0;
            --shadow-sm: 0 1px 3px rgba(0, 28, 88, 0.08);
            --shadow-md: 0 4px 12px rgba(0, 28, 88, 0.1);
            --shadow-lg: 0 8px 24px rgba(0, 28, 88, 0.12);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
            position: relative;
            font-weight: 400;
            letter-spacing: -0.02em;
        }

        .app-container { display: flex; height: 100vh; overflow: hidden; }

        /* === SIDEBAR - Pacific Blue (강함, 이성, 미래) === */
        .sidebar {
            width: 240px;
            background: var(--pacific-blue);
            display: flex; flex-direction: column; flex-shrink: 0;
            z-index: 50;
        }
        .logo-section {
            padding: 28px 24px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }
        .logo { display: flex; align-items: center; gap: 14px; }
        .logo-icon {
            width: 36px; height: 36px;
            background: var(--amore-blue);
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
        }
        .logo-text { color: var(--ap-white); }
        .logo-text h1 {
            font-size: 15px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        .logo-text span {
            font-size: 10px;
            opacity: 0.6;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 400;
        }
        .nav-section { padding: 24px 16px; flex: 1; overflow-y: auto; }
        .nav-label {
            font-size: 10px;
            color: rgba(255,255,255,0.4);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 12px;
            padding-left: 12px;
            font-weight: 500;
        }
        .nav-item {
            display: flex; align-items: center; gap: 12px;
            padding: 12px 16px;
            border-radius: 6px;
            color: rgba(255,255,255,0.65);
            cursor: pointer;
            transition: all 0.15s ease;
            margin-bottom: 2px;
            font-size: 13px;
            font-weight: 400;
        }
        .nav-item:hover {
            background: rgba(255,255,255,0.06);
            color: rgba(255,255,255,0.9);
        }
        .nav-item.active {
            background: var(--amore-blue);
            color: var(--ap-white);
            font-weight: 500;
        }
        .nav-divider {
            height: 1px;
            background: rgba(255,255,255,0.06);
            margin: 20px 0;
        }
        .channel-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 16px;
            border-radius: 6px;
            color: rgba(255,255,255,0.7);
            font-size: 13px;
            background: rgba(255,255,255,0.04);
        }
        .channel-badge {
            font-size: 10px;
            background: var(--amore-blue);
            padding: 3px 10px;
            border-radius: 4px;
            color: white;
            font-weight: 500;
        }

        /* === MAIN - Clean & Professional === */
        .main-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            z-index: 1;
            background: var(--bg-main);
        }
        .header {
            height: 64px;
            background: var(--ap-white);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
            flex-shrink: 0;
        }
        .header-left { display: flex; align-items: center; gap: 20px; }
        .page-info h2 {
            font-size: 16px;
            font-weight: 600;
            color: var(--pacific-blue);
        }
        .page-info .breadcrumb {
            font-size: 11px;
            color: var(--ap-gray);
            margin-top: 2px;
        }
        .header-right { display: flex; align-items: center; gap: 12px; }
        .platform-badge {
            display: flex; align-items: center; gap: 6px;
            padding: 6px 14px;
            background: var(--pacific-blue);
            color: var(--ap-white);
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            letter-spacing: 0.3px;
        }
        .export-btn {
            display: flex; align-items: center; gap: 6px;
            padding: 8px 16px;
            background: var(--amore-blue);
            color: var(--ap-white);
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .export-btn:hover {
            background: var(--pacific-blue);
        }
        .date-display {
            font-size: 11px;
            color: var(--ap-gray);
            background: var(--bg-subtle);
            padding: 6px 12px;
            border-radius: 4px;
            font-weight: 400;
        }
        .time-display-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: flex-end;
        }
        .current-time {
            background: rgba(31, 87, 149, 0.08);
            color: var(--amore-blue);
        }

        /* === LOADING STATES === */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border-light);
            border-top-color: var(--amore-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text {
            margin-top: 16px;
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        .skeleton {
            background: linear-gradient(90deg, var(--bg-subtle) 25%, #e8e8e8 50%, var(--bg-subtle) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }

        /* === ERROR STATE === */
        .error-banner {
            background: rgba(139, 38, 53, 0.05);
            border: 1px solid rgba(139, 38, 53, 0.2);
            border-radius: 8px;
            padding: 16px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .error-banner.hidden { display: none; }
        .error-icon {
            width: 36px;
            height: 36px;
            background: rgba(139, 38, 53, 0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .error-content { flex: 1; }
        .error-title { font-size: 13px; font-weight: 600; color: var(--danger); margin-bottom: 4px; }
        .error-message { font-size: 12px; color: var(--text-secondary); }
        .error-action {
            padding: 6px 12px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .error-action:hover { background: #701f2a; }

        /* === CRAWL STATUS - Minimal === */
        .crawl-status {
            display: flex; align-items: center; gap: 8px;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            background: var(--bg-subtle);
            color: var(--ap-gray);
        }
        .crawl-status.running {
            background: rgba(196, 169, 98, 0.1);
            color: var(--warning);
        }
        .crawl-status.completed {
            background: rgba(31, 87, 149, 0.08);
            color: var(--amore-blue);
        }
        .crawl-status.failed {
            background: rgba(139, 38, 53, 0.08);
            color: var(--danger);
        }
        .crawl-indicator {
            width: 6px; height: 6px; border-radius: 50%;
            background: var(--ap-gray);
        }
        .crawl-status.running .crawl-indicator {
            background: var(--warning);
            animation: pulse 1.5s infinite;
        }
        .crawl-status.completed .crawl-indicator { background: var(--amore-blue); }
        .crawl-status.failed .crawl-indicator { background: var(--danger); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

        /* === ANIMATIONS === */
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeSlideIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        .content-wrapper { flex: 1; display: flex; overflow: hidden; }
        .content-area {
            flex: 1;
            padding: 24px 32px;
            overflow-y: auto;
            background: var(--bg-main);
        }
        .page-view { display: none; animation: fadeSlideIn 0.3s ease; }
        .page-view.active { display: block; }

        /* === INSIGHT BANNER - Harmony of Contrast ===
         * Pacific Blue (강함) + Amore Blue (부드러움) 그라데이션
         */
        .insight-banner {
            background: linear-gradient(135deg, var(--pacific-blue) 0%, var(--amore-blue) 100%);
            border-radius: 8px;
            padding: 24px 28px;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
        }
        .insight-banner::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 40%;
            height: 100%;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.05) 100%);
            pointer-events: none;
        }
        .insight-content {
            display: flex;
            align-items: center;
            gap: 20px;
            position: relative;
            z-index: 1;
        }
        .insight-icon {
            width: 48px; height: 48px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .insight-text { flex: 1; }
        .insight-label {
            font-size: 10px;
            color: rgba(255,255,255,0.6);
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 500;
            margin-bottom: 6px;
        }
        .insight-message {
            color: var(--ap-white);
            font-size: 14px;
            font-weight: 400;
            line-height: 1.6;
        }
        .insight-message strong {
            color: var(--ap-white);
            font-weight: 600;
        }

        /* === STATUS CARDS - Clean & Professional === */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        .status-card {
            background: var(--ap-white);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border-light);
            transition: all 0.2s ease;
            cursor: default;
        }
        .status-card:hover {
            border-color: var(--amore-blue);
            box-shadow: var(--shadow-md);
        }
        .status-label {
            font-size: 10px;
            color: var(--ap-gray);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
            margin-bottom: 8px;
        }
        .status-value {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .status-value span {
            font-size: 18px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-card.success .status-value { color: var(--amore-blue); }
        .status-card.info .status-value { color: var(--pacific-blue); }
        .status-card.danger .status-value { color: var(--danger); }
        .status-card.danger {
            border-color: rgba(139, 38, 53, 0.2);
            background: rgba(139, 38, 53, 0.03);
        }

        /* === TOOLTIP === */
        .status-card.danger { position: relative; z-index: 1; }
        .status-card.danger:hover { z-index: 9999; }
        .warning-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--pacific-blue);
            color: var(--ap-white);
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.15s ease;
            z-index: 10000;
            box-shadow: var(--shadow-lg);
            margin-bottom: 8px;
        }
        .warning-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--pacific-blue);
        }
        .warning-tooltip ul {
            list-style: none;
            text-align: left;
            margin: 0;
            padding: 0;
        }
        .warning-tooltip li {
            padding: 3px 0;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
        }
        .warning-tooltip li::before {
            content: '•';
            color: var(--warning);
        }
        .status-card.danger:hover .warning-tooltip {
            opacity: 1;
            visibility: visible;
        }

        /* === EXPOSURE STATUS TOOLTIP === */
        .status-card.success { position: relative; z-index: 1; }
        .status-card.success:hover { z-index: 9999; }
        .exposure-status-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--pacific-blue);
            color: var(--ap-white);
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.15s ease;
            z-index: 10000;
            box-shadow: var(--shadow-lg);
            margin-bottom: 8px;
            min-width: 200px;
        }
        .exposure-status-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--pacific-blue);
        }
        .exposure-status-tooltip ul {
            list-style: none;
            text-align: left;
            margin: 0;
            padding: 0;
        }
        .exposure-status-tooltip li {
            padding: 3px 0;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
        }
        .exposure-status-tooltip li::before {
            content: '•';
            color: #22c55e;
        }
        .status-card.success:hover .exposure-status-tooltip {
            opacity: 1;
            visibility: visible;
        }

        /* === CHART TITLE TOOLTIP === */
        .card-title.has-tooltip {
            position: relative;
            cursor: help;
        }
        .card-title .help-icon {
            cursor: help;
            transition: opacity 0.2s;
        }
        .card-title:hover .help-icon {
            opacity: 1 !important;
        }
        .chart-title-tooltip {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 8px;
            background: var(--pacific-blue);
            color: var(--ap-white);
            padding: 16px;
            border-radius: 8px;
            font-size: 12px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            z-index: 10000;
            box-shadow: var(--shadow-lg);
            min-width: 280px;
            max-width: 320px;
            white-space: normal;
            line-height: 1.5;
        }
        .chart-title-tooltip::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 20px;
            border: 8px solid transparent;
            border-bottom-color: var(--pacific-blue);
        }
        .chart-title-tooltip .tooltip-header {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        .chart-title-tooltip .tooltip-content p {
            margin: 0 0 10px 0;
            font-size: 11px;
        }
        .chart-title-tooltip .tooltip-content p:last-child {
            margin-bottom: 0;
        }
        .chart-title-tooltip .tooltip-content strong {
            color: #60a5fa;
        }
        .card-title.has-tooltip:hover .chart-title-tooltip {
            opacity: 1;
            visibility: visible;
        }

        /* === KPI CARD TOOLTIP === */
        .kpi-card.has-tooltip {
            position: relative;
            cursor: help;
        }
        .kpi-card .kpi-label {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .kpi-card .help-icon {
            width: 12px;
            height: 12px;
            opacity: 0.5;
            cursor: help;
            transition: opacity 0.2s;
        }
        .kpi-card:hover .help-icon {
            opacity: 1;
        }
        .kpi-tooltip {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 8px;
            background: var(--pacific-blue);
            color: var(--ap-white);
            padding: 14px;
            border-radius: 8px;
            font-size: 11px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            z-index: 10000;
            box-shadow: var(--shadow-lg);
            min-width: 220px;
            max-width: 280px;
            white-space: normal;
            line-height: 1.5;
            text-align: left;
        }
        .kpi-tooltip::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-bottom-color: var(--pacific-blue);
        }
        .kpi-tooltip .tooltip-header {
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        .kpi-tooltip .tooltip-content {
            font-size: 11px;
        }
        .kpi-tooltip .tooltip-content p {
            margin: 0 0 6px 0;
        }
        .kpi-tooltip .tooltip-content p:last-child {
            margin-bottom: 0;
        }
        .kpi-tooltip .tooltip-content strong {
            color: #60a5fa;
        }
        .kpi-card.has-tooltip:hover .kpi-tooltip {
            opacity: 1;
            visibility: visible;
        }

        /* === TABLE HEADER TOOLTIP === */
        th.has-tooltip {
            position: relative;
            cursor: help;
        }
        th.has-tooltip .th-content {
            display: flex;
            align-items: center;
            gap: 4px;
            justify-content: inherit;
        }
        th .help-icon {
            width: 12px;
            height: 12px;
            opacity: 0.4;
            cursor: help;
            transition: opacity 0.2s;
        }
        th:hover .help-icon {
            opacity: 1;
        }
        .th-tooltip {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 8px;
            background: var(--pacific-blue);
            color: var(--ap-white);
            padding: 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 400;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            z-index: 10000;
            box-shadow: var(--shadow-lg);
            min-width: 180px;
            max-width: 240px;
            white-space: normal;
            line-height: 1.4;
            text-align: left;
        }
        .th-tooltip::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-bottom-color: var(--pacific-blue);
        }
        th.has-tooltip:hover .th-tooltip {
            opacity: 1;
            visibility: visible;
        }
        /* 왼쪽 끝 열: 툴팁을 오른쪽으로 정렬 */
        th.has-tooltip:first-child .th-tooltip {
            left: 0;
            transform: translateX(0);
        }
        th.has-tooltip:first-child .th-tooltip::before {
            left: 20px;
            transform: translateX(0);
        }
        /* 오른쪽 끝 열: 툴팁을 왼쪽으로 정렬 */
        th.has-tooltip:last-child .th-tooltip {
            left: auto;
            right: 0;
            transform: translateX(0);
        }
        th.has-tooltip:last-child .th-tooltip::before {
            left: auto;
            right: 20px;
            transform: translateX(0);
        }

        /* === INFO POPUP TOOLTIP (아이콘 호버 시 팝업) === */
        .info-tooltip-wrapper {
            position: relative;
            display: inline-flex;
            align-items: center;
        }
        .info-trigger {
            transition: opacity 0.2s;
        }
        .info-trigger:hover {
            opacity: 1 !important;
        }
        .info-popup-tooltip {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: var(--pacific-blue);
            color: var(--ap-white);
            padding: 14px 16px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 400;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            z-index: 10001;
            box-shadow: var(--shadow-lg);
            min-width: 260px;
            max-width: 320px;
            white-space: normal;
            line-height: 1.5;
            text-align: left;
        }
        .info-popup-tooltip::before {
            content: '';
            position: absolute;
            bottom: 100%;
            right: 12px;
            border: 6px solid transparent;
            border-bottom-color: var(--pacific-blue);
        }
        .info-tooltip-wrapper:hover .info-popup-tooltip {
            opacity: 1;
            visibility: visible;
        }
        .info-popup-tooltip .tooltip-header {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.15);
        }
        .info-popup-tooltip .tooltip-content p {
            margin-bottom: 10px;
            line-height: 1.6;
        }
        .info-popup-tooltip .tooltip-content p:last-child {
            margin-bottom: 0;
        }
        .info-popup-tooltip .tooltip-content strong {
            color: #60a5fa;
        }

        /* === CHART DATE RANGE PICKER === */
        .chart-date-range {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }
        .chart-date-range label {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        .chart-date-range input[type="date"] {
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 12px;
            background: var(--ap-white);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .chart-date-range input[type="date"]:hover {
            border-color: var(--pacific-blue);
        }
        .chart-date-range input[type="date"]:focus {
            outline: none;
            border-color: var(--pacific-blue);
            box-shadow: 0 0 0 3px rgba(0, 112, 184, 0.1);
        }
        .chart-date-range .date-separator {
            color: var(--text-secondary);
            font-size: 12px;
        }
        .chart-date-range .apply-btn {
            padding: 6px 12px;
            background: var(--pacific-blue);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .chart-date-range .apply-btn:hover {
            background: var(--amore-blue);
        }
        .data-period-info {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 4px;
            padding: 4px 8px;
            background: rgba(0, 112, 184, 0.05);
            border-radius: 4px;
            display: inline-block;
        }
        .data-gap-warning {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .data-gap-warning i {
            width: 14px;
            height: 14px;
        }
        .tooltip-period-info {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.2);
            font-size: 10px;
            color: rgba(255,255,255,0.8);
        }

        /* === CATEGORY POSITION TOOLTIP === */
        .status-card.info { position: relative; z-index: 1; }
        .status-card.info:hover { z-index: 9999; }
        .category-position-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--pacific-blue);
            color: var(--ap-white);
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.15s ease;
            z-index: 10000;
            box-shadow: var(--shadow-lg);
            margin-bottom: 8px;
            min-width: 220px;
        }
        .category-position-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--pacific-blue);
        }
        .category-position-tooltip ul {
            list-style: none;
            text-align: left;
            margin: 0;
            padding: 0;
        }
        .category-position-tooltip li {
            padding: 3px 0;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
        }
        .category-position-tooltip li::before {
            content: '•';
            color: #60a5fa;
        }
        .status-card.info:hover .category-position-tooltip {
            opacity: 1;
            visibility: visible;
        }

        /* === GRID & CARDS - Clean Professional Style === */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }
        .content-grid.single { grid-template-columns: 1fr; }
        .card {
            background: var(--ap-white);
            border-radius: 8px;
            border: 1px solid var(--border-light);
            overflow: hidden;
            transition: all 0.2s ease;
        }
        .card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--amore-blue);
        }
        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-subtle);
        }
        .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            font-weight: 600;
            color: var(--pacific-blue);
        }
        .card-title-icon {
            width: 28px; height: 28px;
            background: var(--amore-blue);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .card-badge {
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
        }
        .card-badge.danger {
            background: rgba(139, 38, 53, 0.1);
            color: var(--danger);
        }
        .card-body { padding: 20px; overflow: visible; }

        /* 브랜드 분석 그리드 - 카드 높이 및 해석 가이드 정렬 */
        .content-grid.brand-analysis-grid .card { display: flex; flex-direction: column; height: 100%; }
        .content-grid.brand-analysis-grid .card-body {
            flex: 1;
            display: flex !important;
            flex-direction: column !important;
        }
        .content-grid.brand-analysis-grid .card-body .chart-guide { margin-top: auto !important; }
        .content-grid.brand-analysis-grid .card-body .action-table { flex: 1; }

        /* === DATE RANGE SELECTOR === */
        .date-range-selector {
            display: flex;
            gap: 4px;
            background: var(--bg-subtle);
            padding: 3px;
            border-radius: 6px;
        }
        .date-range-selector .date-btn {
            padding: 5px 10px;
            font-size: 11px;
            font-weight: 500;
            border: none;
            background: transparent;
            color: var(--ap-gray);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .date-range-selector .date-btn:hover {
            color: var(--pacific-blue);
            background: rgba(31, 87, 149, 0.05);
        }
        .date-range-selector .date-btn.active {
            background: var(--amore-blue);
            color: white;
        }
        .date-range-selector .date-btn.loading {
            opacity: 0.6;
            cursor: wait;
        }

        /* === ACTION TABLE - Data-focused === */
        .action-table { width: 100%; border-collapse: collapse; overflow: visible; }
        .action-table th {
            text-align: left;
            padding: 12px 16px;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--ap-gray);
            font-weight: 500;
            border-bottom: 1px solid var(--border-light);
            background: var(--bg-subtle);
        }
        .action-table td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-light);
            font-size: 13px;
            vertical-align: middle;
            overflow: visible;
            position: relative;
        }
        .action-table tr { transition: background 0.15s; }
        .action-table tr:hover { background: var(--bg-subtle); }
        .action-table tr.highlight-row { background: rgba(31, 87, 149, 0.05); }
        .action-table tr.highlight-row:hover { background: rgba(31, 87, 149, 0.08); }

        /* 경쟁사 비교 테이블 - 행 간격 확대 */
        #competitor-table td { padding: 20px 16px; }
        #competitor-table th { padding: 16px 16px; }

        /* Product Name Truncation with Custom Tooltip */
        .product-name-wrapper {
            position: relative;
            display: inline-block;
            max-width: 320px;
        }
        .product-name-truncate {
            max-width: 320px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-block;
            vertical-align: middle;
            cursor: help;
        }
        .product-name-truncate:hover {
            color: var(--amore-blue);
        }
        .product-name-tooltip {
            position: fixed;
            background: var(--pacific-blue);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.6;
            min-width: 220px;
            max-width: 300px;
            white-space: normal;
            word-break: keep-all;
            box-shadow: var(--shadow-lg);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
            z-index: 99999;
            pointer-events: none;
        }
        .product-name-tooltip .tooltip-header {
            font-weight: 600;
            margin-bottom: 10px;
            color: #22c55e;
            font-size: 12px;
        }
        .product-name-tooltip .tooltip-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .product-name-tooltip .tooltip-list li {
            padding: 3px 0;
            display: flex;
            align-items: flex-start;
            gap: 6px;
            font-size: 11px;
        }
        .product-name-tooltip .tooltip-list li::before {
            content: '•';
            color: #22c55e;
            flex-shrink: 0;
        }
        .product-name-wrapper:hover .product-name-tooltip {
            opacity: 1;
            visibility: visible;
        }

        /* Competitor Table Styles */
        .rank-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 28px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            background: var(--bg-subtle);
            color: var(--text-primary);
        }
        .vs-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
        }
        .vs-badge.baseline {
            background: rgba(31, 87, 149, 0.1);
            color: var(--amore-blue);
        }
        .vs-badge.ahead {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
        }
        .vs-badge.behind {
            background: rgba(139, 38, 53, 0.1);
            color: var(--danger);
        }

        .priority-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
        }
        .priority-badge.p1 {
            background: rgba(139, 38, 53, 0.1);
            color: var(--danger);
        }
        .priority-badge.p2 {
            background: rgba(196, 169, 98, 0.15);
            color: #9A7D2E;
        }
        .action-tag {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .action-tag.monitor {
            background: rgba(31, 87, 149, 0.1);
            color: var(--amore-blue);
        }
        .action-tag.risk {
            background: rgba(139, 38, 53, 0.1);
            color: var(--danger);
        }
        .action-tag.deep {
            background: rgba(196, 169, 98, 0.15);
            color: #9A7D2E;
        }
        .product-info { display: flex; align-items: center; gap: 12px; }
        .product-avatar {
            width: 32px; height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 11px;
            color: var(--ap-white);
            background: var(--amore-blue);
        }
        .product-name {
            font-weight: 500;
            color: var(--pacific-blue);
        }
        .product-brand {
            font-size: 11px;
            color: var(--ap-gray);
        }
        .link-action {
            color: var(--amore-blue);
            font-size: 12px;
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: color 0.15s;
        }
        .link-action:hover { color: var(--pacific-blue); }

        /* === KPI CARDS - Minimal Professional === */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        .kpi-card {
            background: var(--ap-white);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid var(--border-light);
            transition: all 0.2s ease;
        }
        .kpi-card:hover {
            border-color: var(--amore-blue);
            box-shadow: var(--shadow-md);
        }
        .kpi-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--ap-gray);
            font-weight: 500;
            margin-bottom: 8px;
        }
        .kpi-value {
            font-size: 28px;
            font-weight: 600;
            color: var(--pacific-blue);
            margin-bottom: 6px;
            display: flex;
            align-items: baseline;
            gap: 4px;
        }
        .kpi-value .unit {
            font-size: 14px;
            font-weight: 400;
            color: var(--ap-gray);
        }
        .kpi-delta {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }
        .kpi-delta.up {
            background: rgba(31, 87, 149, 0.1);
            color: var(--amore-blue);
        }
        .kpi-delta.down {
            background: rgba(139, 38, 53, 0.1);
            color: var(--danger);
        }

        /* === RESPONSIVE LAYOUT === */

        /* 태블릿 가로 (1200px 이하) */
        @media (max-width: 1200px) {
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .content-grid {
                grid-template-columns: 1fr;
            }
            .chatbot-panel.open {
                width: 360px;
                min-width: 280px;
            }
        }

        /* 태블릿 세로 (992px 이하) */
        @media (max-width: 992px) {
            .sidebar {
                width: 200px;
            }
            .chatbot-panel.open {
                position: fixed;
                right: 0;
                top: 0;
                height: 100vh;
                width: 380px;
                z-index: 1000;
                box-shadow: -4px 0 20px rgba(0,0,0,0.15);
            }
            .chatbot-overlay {
                display: block;
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.4);
                z-index: 999;
                opacity: 0;
                visibility: hidden;
                transition: all 0.25s ease;
            }
            .chatbot-overlay.active {
                opacity: 1;
                visibility: visible;
            }
        }

        /* 모바일 가로 / 작은 태블릿 (768px 이하) */
        @media (max-width: 768px) {
            .kpi-grid {
                grid-template-columns: 1fr;
            }
            .category-header-row {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start !important;
            }
            .chart-date-range {
                width: 100%;
                flex-wrap: wrap;
                justify-content: flex-start;
            }
            .sidebar {
                position: fixed;
                left: -240px;
                top: 0;
                height: 100vh;
                width: 240px;
                z-index: 1001;
                transition: left 0.3s ease;
            }
            .sidebar.open {
                left: 0;
            }
            .sidebar-overlay {
                display: block;
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.5);
                z-index: 1000;
                opacity: 0;
                visibility: hidden;
                transition: all 0.25s ease;
            }
            .sidebar-overlay.active {
                opacity: 1;
                visibility: visible;
            }
            .main-content {
                margin-left: 0 !important;
                width: 100%;
            }
            .mobile-header {
                display: flex !important;
                position: sticky;
                top: 0;
                z-index: 100;
                background: var(--pacific-blue);
                padding: 12px 16px;
                align-items: center;
                justify-content: space-between;
            }
            .mobile-header .menu-btn {
                background: none;
                border: none;
                color: white;
                font-size: 24px;
                cursor: pointer;
                padding: 4px;
            }
            .mobile-header .logo-text {
                color: white;
                font-size: 14px;
                font-weight: 600;
            }
            .mobile-header .chat-toggle-btn {
                background: var(--amore-blue);
                border: none;
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                font-size: 12px;
                cursor: pointer;
            }
            .category-tabs {
                flex-wrap: wrap;
            }
            .chatbot-panel.open {
                width: 100%;
                max-width: 100%;
                min-width: 100%;
            }
            .page-header {
                flex-direction: column;
                align-items: flex-start !important;
                gap: 12px;
            }
            .page-header h2 {
                font-size: 18px;
            }
            .view-header {
                flex-direction: column;
                gap: 12px;
            }
            .header-controls {
                width: 100%;
                flex-wrap: wrap;
            }
            .growth-type-container {
                flex-direction: column;
            }
        }

        /* 모바일 세로 (576px 이하) */
        @media (max-width: 576px) {
            .sidebar {
                width: 280px;
                left: -280px;
            }
            .main-content {
                padding: 12px !important;
            }
            .kpi-card {
                padding: 16px;
            }
            .kpi-value {
                font-size: 24px;
            }
            .card {
                border-radius: 8px;
            }
            .card-header {
                padding: 12px 16px;
            }
            .card-body {
                padding: 12px 16px;
            }
            .chart-date-range input[type="date"] {
                width: 110px;
                font-size: 11px;
            }
            .chart-date-range select {
                font-size: 11px;
                padding: 4px 8px;
            }
            .apply-btn {
                padding: 4px 8px;
                font-size: 10px;
            }
            .chatbot-input-area {
                padding: 12px;
            }
            .chatbot-input-area textarea {
                font-size: 14px;
            }
            .chat-message {
                max-width: 95%;
                font-size: 13px;
            }
            .suggestion-chips {
                flex-direction: column;
            }
            .suggestion-chip {
                width: 100%;
                text-align: left;
            }
            .data-table {
                font-size: 11px;
            }
            .data-table th, .data-table td {
                padding: 8px 6px;
            }
        }

        /* 매우 작은 화면 (400px 이하) */
        @media (max-width: 400px) {
            .page-header h2 {
                font-size: 16px;
            }
            .kpi-grid {
                gap: 8px;
            }
            .kpi-card {
                padding: 12px;
            }
            .kpi-value {
                font-size: 20px;
            }
            .kpi-label {
                font-size: 10px;
            }
            .chart-container {
                height: 200px;
            }
        }

        /* 모바일 헤더 기본 숨김 */
        .mobile-header {
            display: none;
        }

        /* 사이드바/챗봇 오버레이 기본 숨김 */
        .sidebar-overlay,
        .chatbot-overlay {
            display: none;
        }

        /* === CHARTS === */
        .chart-container { position: relative; height: 260px; }
        .chart-container-large { height: 420px; }
        .chart-guide {
            margin-top: 12px;
            padding: 12px 16px;
            background: var(--bg-subtle);
            border-left: 3px solid var(--amore-blue);
            border-radius: 0 6px 6px 0;
            font-size: 12px;
            line-height: 1.6;
            color: var(--ap-gray);
        }
        .chart-guide strong { color: var(--pacific-blue); }

        /* === GROWTH TYPE CLASSIFICATION === */
        .growth-type-container {
            display: flex;
            gap: 16px;
        }
        .growth-type-box {
            flex: 1;
            padding: 24px;
            border-radius: 8px;
            text-align: center;
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            transition: all 0.2s ease;
        }
        .growth-type-box:hover {
            border-color: var(--amore-blue);
            box-shadow: var(--shadow-md);
        }
        .growth-type-icon-wrapper {
            width: 48px;
            height: 48px;
            margin: 0 auto 12px;
            background: rgba(31, 87, 149, 0.08);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .growth-type-box.organic .growth-type-icon-wrapper {
            background: rgba(31, 87, 149, 0.08);
        }
        .growth-type-box.discount .growth-type-icon-wrapper {
            background: rgba(0, 28, 88, 0.08);
        }
        .growth-type-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        .growth-type-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--pacific-blue);
            margin-bottom: 8px;
        }
        .growth-type-desc {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* === ENHANCED COMPETITOR COMPARISON === */
        .competitor-section {
            margin-top: 20px;
        }

        .competitor-selector {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .competitor-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .competitor-dropdown {
            padding: 8px 14px;
            border-radius: 6px;
            border: 1px solid var(--border-light);
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            min-width: 180px;
        }

        .competitor-dropdown:hover {
            border-color: var(--amore-blue);
        }

        .competitor-dropdown:focus {
            outline: none;
            border-color: var(--amore-blue);
            box-shadow: 0 0 0 3px rgba(31, 87, 149, 0.1);
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .comparison-table thead {
            background: var(--bg-subtle);
        }

        .comparison-table th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border-light);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .comparison-table th:first-child {
            border-radius: 6px 0 0 0;
        }

        .comparison-table th:last-child {
            border-radius: 0 6px 0 0;
        }

        .comparison-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-light);
            color: var(--text-primary);
        }

        .comparison-table tbody tr:hover {
            background: var(--bg-subtle);
        }

        .comparison-table .metric-label {
            font-weight: 500;
            color: var(--text-primary);
        }

        .comparison-table .better {
            color: #10b981;
            font-weight: 600;
        }

        .comparison-table .worse {
            color: #ef4444;
            font-weight: 600;
        }

        .comparison-table .same {
            color: var(--text-secondary);
        }

        .comparison-table .value-cell {
            text-align: center;
            font-family: 'SF Mono', 'Monaco', monospace;
            font-size: 13px;
        }

        /* === PROMO COMPARISON TABLE === */
        .promo-table-container {
            max-height: 280px;
            overflow-y: auto;
        }
        .promo-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .promo-table thead {
            position: sticky;
            top: 0;
            background: var(--bg-card);
            z-index: 1;
        }
        .promo-table th {
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border-light);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .promo-table td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--border-light);
            color: var(--text-primary);
        }
        .promo-table tr:hover {
            background: var(--bg-subtle);
        }
        .promo-table tr.is-laneige {
            background: rgba(31, 87, 149, 0.08);
        }
        .promo-table tr.is-laneige:hover {
            background: rgba(31, 87, 149, 0.12);
        }
        .promo-table .brand-name {
            font-weight: 500;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .promo-table .brand-name.laneige {
            color: var(--amore-blue);
            font-weight: 600;
        }
        .promo-table .num-cell {
            text-align: center;
            font-family: 'SF Mono', 'Monaco', monospace;
        }
        .promo-table .discount-cell {
            color: #ef4444;
            font-weight: 500;
        }

        /* === DISCOUNT & PRICE BADGES === */
        .discount-badge {
            display: inline-block;
            background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 6px;
            vertical-align: middle;
            box-shadow: 0 2px 4px rgba(255, 107, 107, 0.2);
        }

        .coupon-badge {
            display: inline-block;
            background: #fff3cd;
            color: #856404;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
            margin-left: 6px;
            vertical-align: middle;
            border: 1px solid #ffeeba;
        }

        .deal-badge {
            display: inline-block;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 6px;
            vertical-align: middle;
        }

        .price-original {
            text-decoration: line-through;
            color: #999;
            font-size: 11px;
            margin-right: 6px;
        }

        .price-current {
            color: #e74c3c;
            font-weight: 600;
            font-size: 13px;
        }

        .price-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }

        /* === QUICK ACTIONS === */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 24px;
        }
        .quick-action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 20px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            border: none;
        }
        .quick-action-btn.primary {
            background: var(--pacific-blue);
            color: var(--ap-white);
        }
        .quick-action-btn.primary:hover {
            background: var(--amore-blue);
        }
        .quick-action-btn.secondary {
            background: var(--ap-white);
            color: var(--pacific-blue);
            border: 1px solid var(--pacific-blue);
        }
        .quick-action-btn.secondary:hover {
            background: var(--pacific-blue);
            color: var(--ap-white);
        }
        .quick-action-btn.accent {
            background: var(--amore-blue);
            color: var(--ap-white);
        }
        .quick-action-btn.accent:hover {
            background: var(--pacific-blue);
        }

        /* === PERIOD SELECTOR === */
        .period-selector {
            display: flex;
            gap: 4px;
        }
        .period-btn {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            border: 1px solid var(--border-light);
            background: var(--ap-white);
            color: var(--ap-gray);
        }
        .period-btn:hover {
            border-color: var(--amore-blue);
            color: var(--amore-blue);
        }
        .period-btn.active {
            background: var(--amore-blue);
            color: var(--ap-white);
            border-color: var(--amore-blue);
        }

        /* === CATEGORY TABS - Minimal === */
        .category-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .category-tab {
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            border: 1px solid var(--border-light);
            background: var(--ap-white);
            color: var(--ap-gray);
        }
        .category-tab:hover {
            border-color: var(--amore-blue);
            color: var(--amore-blue);
        }
        .category-tab.active {
            background: var(--pacific-blue);
            border-color: var(--pacific-blue);
            color: var(--ap-white);
        }

        /* === PRODUCT SELECTOR === */
        .selector-group {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        .selector-label {
            font-size: 11px;
            font-weight: 500;
            color: var(--ap-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .selector-dropdown {
            padding: 10px 16px;
            border-radius: 6px;
            border: 1px solid var(--border-light);
            font-size: 13px;
            font-weight: 400;
            cursor: pointer;
            background: var(--ap-white);
            min-width: 200px;
            outline: none;
            transition: border-color 0.15s;
            color: var(--pacific-blue);
        }
        .selector-dropdown:focus {
            border-color: var(--amore-blue);
        }

        /* === CATEGORY HIERARCHY TREE (카테고리 계층 트리) === */
        .category-tree {
            font-size: 12px;
            line-height: 1.4;
        }
        .category-tree-item {
            margin: 0;
            padding: 0;
        }
        .category-tree-node {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            margin: 2px 0;
            background: white;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .category-tree-node:hover {
            background: rgba(31, 87, 149, 0.05);
            border-color: var(--amore-blue);
        }
        .category-tree-node.has-laneige {
            border-left: 3px solid var(--amore-blue);
        }
        .category-tree-node.no-laneige {
            border-left: 3px solid #D0D0D0;
            opacity: 0.7;
        }
        .category-tree-toggle {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            color: var(--text-secondary);
            font-size: 10px;
            transition: transform 0.2s ease;
        }
        .category-tree-toggle.expanded {
            transform: rotate(90deg);
        }
        .category-tree-toggle.empty {
            visibility: hidden;
        }
        .category-tree-content {
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .category-tree-name {
            font-weight: 500;
            color: var(--pacific-blue);
        }
        .category-tree-level {
            font-size: 10px;
            color: var(--text-secondary);
            margin-left: 6px;
            padding: 2px 6px;
            background: rgba(0, 28, 88, 0.06);
            border-radius: 4px;
        }
        .category-tree-stats {
            text-align: right;
            font-size: 11px;
        }
        .category-tree-sos {
            font-weight: 600;
            color: var(--amore-blue);
        }
        .category-tree-count {
            color: var(--text-secondary);
            font-size: 10px;
        }
        .category-tree-children {
            margin-left: 28px;
            padding-left: 12px;
            border-left: 1px dashed var(--border-light);
            overflow: hidden;
            max-height: 0;
            transition: max-height 0.3s ease;
        }
        .category-tree-children.expanded {
            max-height: 500px;
        }
        /* 중간 카테고리 (모니터링 안함) */
        .category-tree-node.intermediate {
            background: rgba(0, 0, 0, 0.02);
            border-style: dashed;
            opacity: 0.6;
        }
        .category-tree-node.intermediate .category-tree-name {
            font-style: italic;
            color: var(--text-secondary);
        }

        /* === SELECTOR TOOLTIP (카테고리/제품 선택 툴팁) === */
        .selector-wrapper {
            position: relative;
            display: inline-block;
        }
        .selector-wrapper .selector-tooltip {
            position: absolute;
            bottom: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--deep-ocean);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.5;
            min-width: 280px;
            max-width: 360px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 1000;
            pointer-events: none;
        }
        .selector-wrapper .selector-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-top-color: var(--deep-ocean);
        }
        .selector-wrapper:hover .selector-tooltip {
            opacity: 1;
            visibility: visible;
        }
        .selector-tooltip-header {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .selector-tooltip-content p {
            margin: 6px 0;
            color: rgba(255,255,255,0.9);
        }
        .selector-tooltip-content strong {
            color: white;
        }
        .selector-tooltip-content ul {
            margin: 4px 0 4px 16px;
            padding: 0;
        }
        .selector-tooltip-content li {
            margin: 2px 0;
            color: rgba(255,255,255,0.85);
        }

        /* === PRODUCT PAGE HEADER ROW === */
        .product-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }
        .product-header-row .selector-group {
            margin-bottom: 0;
        }
        .product-header-row .chart-date-range {
            margin-left: 0;
        }

        /* === TEXT TRUNCATION FIX - 제품명 전체 표시 === */
        .promo-table .brand-name {
            max-width: none !important;
            overflow: visible !important;
            text-overflow: clip !important;
            white-space: normal !important;
            word-break: keep-all;
        }
        .selector-dropdown {
            min-width: 220px;
            max-width: 300px;
        }
        .action-table td,
        .promo-table td {
            white-space: normal;
            word-break: keep-all;
        }
        /* 제품명/브랜드명 컬럼 최소 너비 확보 */
        .action-table td:nth-child(2),
        .promo-table td:first-child {
            min-width: 120px;
        }
        /* 차트 범례 텍스트 잘림 방지 */
        .chart-container canvas {
            max-width: 100%;
        }

        /* === CHATBOT - Clean Professional with Resize === */
        .chatbot-panel {
            width: 0;
            min-width: 0;
            background: var(--ap-white);
            border-left: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
            transition: width 0.25s ease;
            overflow: hidden;
            position: relative;
        }
        .chatbot-panel.open {
            width: 420px;
            min-width: 320px;
            max-width: 600px;
        }
        .chatbot-panel.resizing {
            transition: none;
            user-select: none;
        }
        /* 드래그 핸들 (왼쪽 경계) */
        .chat-resize-handle {
            position: absolute;
            left: 0;
            top: 0;
            width: 6px;
            height: 100%;
            cursor: ew-resize;
            background: transparent;
            z-index: 10;
            transition: background 0.15s;
        }
        .chat-resize-handle:hover,
        .chat-resize-handle.active {
            background: var(--amore-blue);
        }
        .chat-header {
            padding: 12px 16px;
            background: linear-gradient(135deg, var(--pacific-blue) 0%, var(--amore-blue) 100%);
            color: var(--ap-white);
            flex-shrink: 0;
        }
        .chat-header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2px;
        }
        .chat-header h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 600;
        }
        .chat-close {
            width: 28px;
            height: 28px;
            background: rgba(255,255,255,0.15);
            border: none;
            border-radius: 6px;
            color: var(--ap-white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.15s;
        }
        .chat-close:hover { background: rgba(255,255,255,0.25); }
        .chat-subtitle {
            font-size: 11px;
            opacity: 0.7;
        }
        .chat-body {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            background: var(--bg-subtle);
        }
        .chat-message { margin-bottom: 12px; }
        .chat-message.bot .bubble {
            background: var(--ap-white);
            border: 1px solid var(--border-light);
            border-radius: 12px 12px 12px 4px;
            padding: 12px 16px;
            font-size: 13px;
            line-height: 1.7;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
        }
        .chat-message.user .bubble {
            background: var(--pacific-blue);
            color: var(--ap-white);
            border-radius: 12px 12px 4px 12px;
            padding: 12px 16px;
            font-size: 13px;
            margin-left: auto;
            max-width: 85%;
        }
        .chat-message.bot .bubble strong { color: var(--amore-blue); }

        /* === AI 출처 표기 === */
        .ai-source-citation {
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px dashed var(--border-light);
            font-size: 11px;
        }
        .ai-source-citation .source-header {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            padding: 4px 0;
            color: var(--text-secondary);
            transition: color 0.15s;
        }
        .ai-source-citation .source-header:hover {
            color: var(--amore-blue);
        }
        .ai-source-citation .source-toggle {
            font-size: 8px;
            transition: transform 0.2s;
        }
        .ai-source-citation.expanded .source-toggle {
            transform: rotate(90deg);
        }
        .ai-source-citation .source-label {
            font-weight: 500;
        }
        .ai-source-citation .source-details {
            display: none;
            margin-top: 8px;
            padding: 10px;
            background: var(--bg-subtle);
            border-radius: 6px;
        }
        .ai-source-citation.expanded .source-details {
            display: block;
        }
        .ai-source-citation .source-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 6px;
            line-height: 1.5;
        }
        .ai-source-citation .source-icon {
            flex-shrink: 0;
        }
        .ai-source-citation .source-text {
            color: var(--text-primary);
        }
        .ai-source-citation .source-text strong {
            color: var(--pacific-blue);
        }
        .ai-source-citation .source-disclaimer {
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px solid var(--border-light);
            color: var(--ap-gray);
            font-style: italic;
            font-size: 10px;
        }

        /* === 추천 질문 - 접기/펼치기 === */
        .chat-suggestions {
            border-top: 1px solid var(--border-light);
            background: var(--ap-white);
            flex-shrink: 0;
        }
        .suggestions-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 16px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .suggestions-header:hover {
            background: var(--bg-subtle);
        }
        .suggestions-label {
            font-size: 10px;
            color: var(--ap-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
            margin: 0;
        }
        .suggestions-toggle {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--ap-gray);
            transition: transform 0.2s;
        }
        .chat-suggestions.collapsed .suggestions-toggle {
            transform: rotate(-90deg);
        }
        .suggestion-chips {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 0 16px 12px 16px;
            max-height: 200px;
            overflow: hidden;
            transition: max-height 0.25s ease, padding 0.25s ease, opacity 0.2s ease;
        }
        .chat-suggestions.collapsed .suggestion-chips {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            opacity: 0;
        }
        .suggestion-chip {
            padding: 10px 14px;
            background: var(--bg-subtle);
            border: 1px solid var(--border-light);
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.15s;
            text-align: left;
            color: var(--pacific-blue);
        }
        .suggestion-chip:hover {
            background: rgba(31, 87, 149, 0.08);
            border-color: var(--amore-blue);
            color: var(--amore-blue);
        }
        .chat-input-area {
            padding: 12px 16px;
            border-top: 1px solid var(--border-light);
            display: flex;
            gap: 10px;
            background: var(--ap-white);
        }
        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border-light);
            background: var(--bg-subtle);
            border-radius: 6px;
            font-size: 13px;
            outline: none;
            transition: border-color 0.15s;
            color: var(--pacific-blue);
        }
        .chat-input:focus {
            border-color: var(--amore-blue);
            background: var(--ap-white);
        }
        .chat-send {
            width: 42px;
            height: 42px;
            background: var(--amore-blue);
            border: none;
            border-radius: 6px;
            color: var(--ap-white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.15s;
        }
        .chat-send:hover { background: var(--pacific-blue); }

        .chat-fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            background: var(--pacific-blue);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            z-index: 100;
            transition: all 0.2s;
            border: none;
        }
        .chat-fab:hover {
            background: var(--amore-blue);
        }
        .chat-fab.hidden { opacity: 0; pointer-events: none; transform: scale(0.9); }

        /* === AI DRAWER - Professional === */
        .ai-drawer {
            position: fixed;
            top: 0;
            right: 0;
            width: 480px;
            height: 100vh;
            background: var(--ap-white);
            border-left: 1px solid var(--border-light);
            box-shadow: var(--shadow-lg);
            z-index: 200;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .ai-drawer.open { transform: translateX(0); }
        .drawer-header {
            padding: 20px 24px;
            background: linear-gradient(135deg, var(--pacific-blue) 0%, var(--amore-blue) 100%);
            color: var(--ap-white);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .drawer-header-left { display: flex; align-items: center; gap: 12px; }
        .drawer-icon {
            width: 40px; height: 40px;
            background: rgba(255,255,255,0.15);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .drawer-header h3 { font-size: 15px; font-weight: 600; }
        .drawer-header p { font-size: 11px; opacity: 0.7; margin-top: 2px; }
        .drawer-close {
            width: 32px; height: 32px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 6px;
            color: var(--ap-white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.15s;
        }
        .drawer-close:hover { background: rgba(255,255,255,0.2); }
        .drawer-content { flex: 1; padding: 24px; overflow-y: auto; }
        .insight-section { margin-bottom: 24px; }
        .insight-section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            padding-left: 12px;
            border-left: 3px solid var(--amore-blue);
        }
        .insight-section-header h4 {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--amore-blue);
        }
        .insight-box {
            background: var(--bg-subtle);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 16px;
            font-size: 13px;
            line-height: 1.7;
            color: var(--pacific-blue);
        }
        .insight-box strong { color: var(--amore-blue); }
        .insight-box em { color: var(--pacific-blue); font-style: normal; font-weight: 600; }
        .inference-path {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 20px;
            background: var(--bg-subtle);
            border-radius: 8px;
        }
        .path-node {
            padding: 8px 14px;
            background: var(--ap-white);
            border: 1px solid var(--border-light);
            border-radius: 6px;
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            color: var(--ap-gray);
        }
        .path-node.highlight {
            border-color: var(--amore-blue);
            color: var(--amore-blue);
            background: rgba(31, 87, 149, 0.05);
        }
        .drawer-actions {
            padding: 16px 24px;
            border-top: 1px solid var(--border-light);
            display: flex;
            gap: 10px;
        }
        .drawer-btn {
            flex: 1;
            padding: 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.15s;
        }
        .drawer-btn.primary {
            background: var(--pacific-blue);
            border: none;
            color: var(--ap-white);
        }
        .drawer-btn.primary:hover { background: var(--amore-blue); }
        .drawer-btn.secondary {
            background: var(--ap-white);
            border: 1px solid var(--border-light);
            color: var(--pacific-blue);
        }
        .drawer-btn.secondary:hover { border-color: var(--amore-blue); }

        /* === EXPORT MODAL - Clean Professional === */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 28, 88, 0.5);
            z-index: 300;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.open { display: flex; }
        .modal-content {
            background: var(--ap-white);
            border-radius: 12px;
            width: 400px;
            padding: 28px;
            box-shadow: var(--shadow-lg);
        }
        .modal-header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 24px;
        }
        .modal-icon {
            width: 44px; height: 44px;
            background: var(--amore-blue);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--pacific-blue);
        }
        .modal-header p {
            font-size: 12px;
            color: var(--ap-gray);
            margin-top: 2px;
        }
        .form-group { margin-bottom: 20px; }
        .form-label {
            display: block;
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--ap-gray);
            margin-bottom: 8px;
        }
        .date-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .date-input {
            padding: 12px 14px;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            font-size: 13px;
            outline: none;
            background: var(--ap-white);
            color: var(--pacific-blue);
        }
        .date-input:focus { border-color: var(--amore-blue); }
        .platform-fixed {
            padding: 12px 16px;
            background: var(--pacific-blue);
            color: var(--ap-white);
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            text-align: center;
        }
        .modal-actions { display: flex; gap: 10px; margin-top: 24px; }
        .modal-btn {
            flex: 1;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }
        .modal-btn.cancel {
            background: var(--bg-subtle);
            border: none;
            color: var(--ap-gray);
        }
        .modal-btn.cancel:hover { background: var(--border-light); }
        .modal-btn.confirm {
            background: var(--amore-blue);
            border: none;
            color: var(--ap-white);
        }
        .modal-btn.confirm:hover { background: var(--pacific-blue); }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            background: var(--ap-white);
            border: 1px solid var(--border-light);
            border-radius: 12px 12px 12px 4px;
            width: fit-content;
        }
        .typing-indicator span {
            width: 6px; height: 6px;
            background: var(--amore-blue);
            border-radius: 50%;
            animation: typing 1s infinite;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">데이터를 불러오는 중...</div>
    </div>

    <div class="app-container">
        <!-- MOBILE HEADER (768px 이하에서 표시) -->
        <div class="mobile-header">
            <button class="menu-btn" onclick="toggleMobileSidebar()">☰</button>
            <span class="logo-text">AMORE INSIGHT</span>
            <button class="chat-toggle-btn" onclick="toggleChatbot()">💬 AI</button>
        </div>

        <!-- SIDEBAR OVERLAY (모바일용) -->
        <div class="sidebar-overlay" onclick="toggleMobileSidebar()"></div>

        <!-- CHATBOT OVERLAY (태블릿/모바일용) -->
        <div class="chatbot-overlay" onclick="toggleChatbot()"></div>

        <!-- SIDEBAR -->
        <aside class="sidebar" id="sidebar">
            <div class="logo-section">
                <div class="logo">
                    <div class="logo-icon"><i data-lucide="sparkles" style="color: white; width: 22px; height: 22px;"></i></div>
                    <div class="logo-text"><h1>AMORE INSIGHT</h1><span>AI Intelligence v2.0</span></div>
                </div>
            </div>
            <nav class="nav-section">
                <div class="nav-label">Main Views</div>
                <div class="nav-item active" onclick="switchPage('home')" data-page="home"><i data-lucide="home" style="width: 18px; height: 18px;"></i>Home</div>
                <div class="nav-item" onclick="switchPage('brand')" data-page="brand"><i data-lucide="building-2" style="width: 18px; height: 18px;"></i>Brand View (L1)</div>
                <div class="nav-item" onclick="switchPage('category')" data-page="category"><i data-lucide="layers" style="width: 18px; height: 18px;"></i>Category View (L2)</div>
                <div class="nav-item" onclick="switchPage('product')" data-page="product"><i data-lucide="box" style="width: 18px; height: 18px;"></i>Product View (L3)</div>
                <div class="nav-divider"></div>
                <div class="nav-label">Settings</div>
                <div class="nav-item" onclick="openAlertSettings()"><i data-lucide="bell" style="width: 18px; height: 18px;"></i>Alert Settings</div>
                <div class="nav-divider"></div>
                <div class="nav-label">Market Channel</div>
                <div class="channel-item"><span>🇺🇸 Amazon US</span><span class="channel-badge">Active</span></div>
            </nav>
        </aside>

        <!-- MAIN -->
        <div class="main-wrapper">
            <header class="header">
                <div class="header-left">
                    <div class="page-info"><h2 id="page-title">Home</h2><div class="breadcrumb" id="breadcrumb">Daily Insight & Action Board</div></div>
                </div>
                <div class="header-right">
                    <div class="time-display-group">
                        <div class="date-display" id="date-display">📅 데이터: 로딩중...</div>
                        <div class="date-display current-time" id="current-time">🕐 현재: --:--:--</div>
                    </div>
                    <div class="crawl-status" id="crawl-status" style="display: none;">
                        <span class="crawl-indicator"></span>
                        <span class="crawl-text">수집 중...</span>
                    </div>
                    <div class="platform-badge">🇺🇸 Amazon US</div>
                    <button class="export-btn" onclick="openExportModal()"><i data-lucide="download" style="width: 16px; height: 16px;"></i>Export</button>
                </div>
            </header>

            <div class="content-wrapper">
                <main class="content-area">
                    <!-- HOME PAGE -->
                    <div id="page-home" class="page-view active">
                        <div class="insight-banner">
                            <div class="insight-content">
                                <div class="insight-icon"><i data-lucide="sparkles" style="color: white; width: 28px; height: 28px;"></i></div>
                                <div class="insight-text">
                                    <div class="insight-label">✨ Daily AI Insight - Laneige</div>
                                    <div class="insight-message">Amazon US 내 Laneige 브랜드는 안정적인 상위권을 유지 중입니다. <strong>Lip Sleeping Mask</strong>가 2위로 상승했으며, Water Bank Cream의 평점 하락에 주의가 필요합니다.</div>
                                </div>
                            </div>
                        </div>
                        <div class="status-grid">
                            <div class="status-card success" id="exposureStatusCard">
                                <div class="status-label">Laneige 노출 상태</div>
                                <div class="status-value"><i data-lucide="trending-up" style="width: 24px; height: 24px;"></i><span id="exposureStatusValue">Stable Up</span></div>
                                <div class="exposure-status-tooltip" id="exposureStatusTooltip">
                                    <div style="font-weight: 600; margin-bottom: 8px; color: #22c55e;">📈 상태 판단 근거</div>
                                    <ul id="exposureStatusList">
                                        <li>Top 10 내 LANEIGE 제품: 3개</li>
                                        <li>전일 대비: 순위 상승</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="status-card info" id="categoryPositionCard">
                                <div class="status-label">카테고리 포지션</div>
                                <div class="status-value"><i data-lucide="bar-chart-3" style="width: 24px; height: 24px;"></i><span id="categoryPositionValue">Top 3</span></div>
                                <div class="category-position-tooltip" id="categoryPositionTooltip">
                                    <div style="font-weight: 600; margin-bottom: 8px; color: #3b82f6;">📊 카테고리별 Top 순위</div>
                                    <ul id="categoryPositionList">
                                        <li>Lip Sleeping Mask - Lip Care 4위</li>
                                        <li>Lip Glowy Balm - Lip Makeup 12위</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="status-card danger" id="warningProductsCard">
                                <div class="status-label">주의 제품</div>
                                <div class="status-value"><i data-lucide="alert-octagon" style="width: 24px; height: 24px;"></i><span id="warningCount">2개</span></div>
                                <div class="warning-tooltip" id="warningTooltip">
                                    <div style="font-weight: 600; margin-bottom: 8px; color: #f59e0b;">⚠️ 주의 필요 제품</div>
                                    <ul id="warningProductsList">
                                        <li>Water Bank Cream - 평점 하락</li>
                                        <li>Lip Glowy Balm - 순위 변동성</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="content-grid single">
                            <div class="card">
                                <div class="card-header"><div class="card-title"><div class="card-title-icon"><i data-lucide="zap" style="color: white; width: 16px; height: 16px;"></i></div>Laneige 액션 보드</div><span class="card-badge danger">4건 대기</span></div>
                                <div class="card-body" style="padding: 0;">
                                    <table class="action-table">
                                        <thead><tr><th>우선순위</th><th>제품</th><th>문제 신호</th><th>액션 태그</th><th>상세 분석</th></tr></thead>
                                        <tbody>
                                            <tr onclick="goToProductDetail('', 'Lip Sleeping Mask')"><td><span class="priority-badge p1">🔴 P1</span></td><td><div class="product-info"><div class="product-avatar">LN</div><div><div class="product-name">Lip Sleeping Mask</div><div class="product-brand">Berry</div></div></div></td><td>순위 3→2 (상향)</td><td><span class="action-tag monitor">MONITOR</span></td><td><a href="#" class="link-action" onclick="event.stopPropagation(); goToProductDetail('', 'Lip Sleeping Mask');">상세 분석 →</a></td></tr>
                                            <tr onclick="goToProductDetail('', 'Water Bank Cream')"><td><span class="priority-badge p1">🔴 P1</span></td><td><div class="product-info"><div class="product-avatar">LN</div><div><div class="product-name">Water Bank Cream</div><div class="product-brand">Blue Hyaluronic</div></div></div></td><td>평점 3.98 (하락)</td><td><span class="action-tag risk">CHECK</span></td><td><a href="#" class="link-action" onclick="event.stopPropagation(); goToProductDetail('', 'Water Bank Cream');">상세 분석 →</a></td></tr>
                                            <tr onclick="goToProductDetail('', 'Lip Glowy Balm')"><td><span class="priority-badge p2">🟠 P2</span></td><td><div class="product-info"><div class="product-avatar">LN</div><div><div class="product-name">Lip Glowy Balm</div><div class="product-brand">Berry</div></div></div></td><td>순위 변동성 높음</td><td><span class="action-tag deep">DEEP DIVE</span></td><td><a href="#" class="link-action" onclick="event.stopPropagation(); goToProductDetail('', 'Lip Glowy Balm');">상세 분석 →</a></td></tr>
                                            <tr onclick="goToProductDetail('', 'Cream Skin Toner')"><td><span class="priority-badge p2">🟠 P2</span></td><td><div class="product-info"><div class="product-avatar">LN</div><div><div class="product-name">Cream Skin Toner</div><div class="product-brand">Refiner</div></div></div></td><td>경쟁사 가격 하락</td><td><span class="action-tag monitor">MONITOR</span></td><td><a href="#" class="link-action" onclick="event.stopPropagation(); goToProductDetail('', 'Cream Skin Toner');">상세 분석 →</a></td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="content-grid">
                            <!-- 카테고리별 시장점유율 막대그래프 -->
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title" style="position: relative;">
                                        <div class="card-title-icon"><i data-lucide="bar-chart-2" style="color: white; width: 16px; height: 16px;"></i></div>
                                        카테고리별 시장점유율 비교
                                        <i data-lucide="help-circle" id="sosChartHelpIcon" class="help-icon" style="width: 14px; height: 14px; margin-left: 6px; opacity: 0.6; cursor: help;"></i>
                                        <div id="sosChartTooltip" class="sos-chart-tooltip" style="display: none; position: absolute; left: 0; top: 100%; margin-top: 8px; width: 320px; background: var(--pacific-blue); color: white; padding: 14px; border-radius: 8px; font-size: 12px; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                                            <div style="font-weight: 600; margin-bottom: 8px;">📊 시장점유율 (SoS) 이해하기</div>
                                            <div style="line-height: 1.6;">
                                                <p style="margin-bottom: 8px;"><strong>시장점유율이란?</strong><br>각 카테고리 Top 100 중 해당 브랜드가 차지하는 비율입니다.</p>
                                                <p style="margin-bottom: 8px;"><strong>카테고리 계층 관계</strong><br>
                                                • Beauty & Personal Care는 최상위 카테고리<br>
                                                • Skin Care, Lip Makeup 등은 하위 카테고리<br>
                                                • 상위 카테고리일수록 경쟁 범위가 넓어 진입이 어려움</p>
                                                <p style="margin-bottom: 0;"><strong>해석 TIP</strong><br>
                                                상위 카테고리(Beauty)에서 0%여도 하위 카테고리(Skin Care)에서 높은 SoS를 가질 수 있습니다. 이는 전체 뷰티 시장 대비 특정 세그먼트에서 강점을 가진다는 의미입니다.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- 필터 영역 -->
                                    <div class="sos-filters" style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; align-items: center;">
                                        <div class="filter-group" style="display: flex; align-items: center; gap: 8px;">
                                            <label style="font-size: 12px; color: var(--text-secondary);">기간:</label>
                                            <input type="date" id="sosStartDate" style="padding: 6px 10px; border: 1px solid var(--border-light); border-radius: 6px; font-size: 12px;">
                                            <span style="color: var(--text-secondary);">~</span>
                                            <input type="date" id="sosEndDate" style="padding: 6px 10px; border: 1px solid var(--border-light); border-radius: 6px; font-size: 12px;">
                                        </div>
                                        <div class="filter-group" style="display: flex; align-items: center; gap: 8px; position: relative;">
                                            <label style="font-size: 12px; color: var(--text-secondary);">비교:</label>
                                            <div class="brand-dropdown-container" style="position: relative;">
                                                <button type="button" id="brandDropdownBtn" onclick="toggleBrandDropdown()" style="padding: 6px 12px; border: 1px solid var(--border-light); border-radius: 6px; font-size: 12px; background: white; cursor: pointer; display: flex; align-items: center; gap: 6px; min-width: 140px;">
                                                    <span id="brandDropdownLabel">브랜드 선택</span>
                                                    <i data-lucide="chevron-down" style="width: 14px; height: 14px;"></i>
                                                </button>
                                                <div id="brandDropdownMenu" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 4px; background: white; border: 1px solid var(--border-light); border-radius: 8px; box-shadow: var(--shadow-lg); z-index: 1000; min-width: 200px; max-height: 250px; overflow-y: auto;">
                                                    <div style="padding: 8px; border-bottom: 1px solid var(--border-light);">
                                                        <input type="text" id="brandSearchInput" placeholder="브랜드 검색..." oninput="filterBrandList()" style="width: 100%; padding: 6px 10px; border: 1px solid var(--border-light); border-radius: 4px; font-size: 12px; box-sizing: border-box;">
                                                    </div>
                                                    <div id="brandCheckboxList" style="padding: 8px;">
                                                        <!-- 브랜드 체크박스 목록 -->
                                                    </div>
                                                </div>
                                            </div>
                                            <div id="selectedBrandTags" style="display: flex; gap: 4px; flex-wrap: wrap; max-width: 200px;">
                                                <!-- 선택된 브랜드 태그 -->
                                            </div>
                                        </div>
                                        <button onclick="updateSosChart()" style="padding: 6px 16px; background: var(--amore-blue); color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer;">적용</button>
                                    </div>
                                    <div class="chart-container" style="height: 280px;">
                                        <canvas id="sosChart"></canvas>
                                    </div>
                                    <div id="sosNoDataMessage" style="display: none; text-align: center; padding: 40px; color: var(--text-secondary);">
                                        <i data-lucide="alert-circle" style="width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.5;"></i>
                                        <p>해당 기간에 데이터가 없습니다.</p>
                                    </div>
                                    <!-- 카테고리별 상세 정보 (계층적 트리) -->
                                    <div id="sosCategoryDetail" style="margin-top: 12px; padding: 12px; background: rgba(0, 28, 88, 0.03); border-radius: 8px;">
                                        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                                            <i data-lucide="git-branch" style="width: 14px; height: 14px;"></i>
                                            카테고리 계층 구조 (클릭하여 펼치기/접기)
                                        </div>
                                        <div class="category-tree" id="sosCategoryDetailContent">
                                            <!-- 동적으로 채워짐 -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- SoS 추이 차트 -->
                            <div class="card">
                                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
                                    <div class="card-title">
                                        <div class="card-title-icon"><i data-lucide="trending-up" style="color: white; width: 16px; height: 16px;"></i></div>
                                        Laneige 시장점유율 추이
                                    </div>
                                    <div class="sos-trend-date-range" style="display: flex; align-items: center; gap: 8px; font-size: 12px;">
                                        <label style="color: var(--text-secondary);">기간:</label>
                                        <input type="date" id="sosTrendStartDate" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 11px;">
                                        <span style="color: var(--text-secondary);">~</span>
                                        <input type="date" id="sosTrendEndDate" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 11px;">
                                        <button onclick="applySosTrendDateRange()" style="padding: 4px 12px; background: var(--amore-blue); color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">적용</button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container"><canvas id="trendChart"></canvas></div>
                                </div>
                            </div>
                        </div>
                        <div class="quick-actions">
                            <button class="quick-action-btn secondary" onclick="switchPage('category')"><i data-lucide="layers" style="width: 18px; height: 18px;"></i>카테고리별 분석</button>
                            <button class="quick-action-btn secondary" onclick="switchPage('product')"><i data-lucide="box" style="width: 18px; height: 18px;"></i>제품 상세 분석</button>
                            <button class="quick-action-btn primary" onclick="toggleChatbot()"><i data-lucide="message-square" style="width: 18px; height: 18px;"></i>AI에게 질문하기</button>
                        </div>
                    </div>

                    <!-- BRAND PAGE (L1) -->
                    <div id="page-brand" class="page-view">
                        <div class="kpi-grid">
                            <div class="kpi-card has-tooltip">
                                <div class="kpi-label">Laneige 시장점유율 <i data-lucide="help-circle" class="help-icon"></i></div>
                                <div class="kpi-value">44.0<span class="unit">%</span></div>
                                <span class="kpi-delta up">▲ 2.1%p</span>
                                <div class="kpi-tooltip">
                                    <div class="tooltip-header">📊 시장점유율 (SoS: Share of Shelf)</div>
                                    <div class="tooltip-content">
                                        <p><strong>정의</strong><br>전체 Top 100 중 LANEIGE 제품이 차지하는 비율</p>
                                        <p><strong>계산</strong><br>LANEIGE 제품 수 ÷ 100 × 100%</p>
                                        <p><strong>해석</strong><br>• 높을수록 진열 점유율 우수<br>• %p 변화는 전일 대비 변동</p>
                                    </div>
                                </div>
                            </div>
                            <div class="kpi-card has-tooltip">
                                <div class="kpi-label">Top10 제품수 <i data-lucide="help-circle" class="help-icon"></i></div>
                                <div class="kpi-value">4<span class="unit">개</span></div>
                                <span class="kpi-delta up">+1 증가</span>
                                <div class="kpi-tooltip">
                                    <div class="tooltip-header">🏆 Top10 제품수</div>
                                    <div class="tooltip-content">
                                        <p><strong>정의</strong><br>베스트셀러 Top 10 내 LANEIGE 제품 수</p>
                                        <p><strong>중요성</strong><br>상위권 노출이 브랜드 인지도와 매출에 직결</p>
                                        <p><strong>해석</strong><br>• 숫자가 높을수록 상위권 장악력 우수<br>• 증감은 전일 대비 변화</p>
                                    </div>
                                </div>
                            </div>
                            <div class="kpi-card has-tooltip">
                                <div class="kpi-label">평균순위 <i data-lucide="help-circle" class="help-icon"></i></div>
                                <div class="kpi-value">53.6<span class="unit">위</span></div>
                                <span class="kpi-delta up">▼ 2.3위 개선</span>
                                <div class="kpi-tooltip">
                                    <div class="tooltip-header">📈 평균순위 (Avg Rank)</div>
                                    <div class="tooltip-content">
                                        <p><strong>정의</strong><br>LANEIGE 모든 제품의 평균 베스트셀러 순위</p>
                                        <p><strong>계산</strong><br>각 제품 순위의 합 ÷ 제품 수</p>
                                        <p><strong>해석</strong><br>• 숫자가 낮을수록 상위권<br>• ▼ 는 순위 상승 (개선)</p>
                                    </div>
                                </div>
                            </div>
                            <div class="kpi-card has-tooltip">
                                <div class="kpi-label">시장집중도 (HHI) <i data-lucide="help-circle" class="help-icon"></i></div>
                                <div class="kpi-value">0.35</div>
                                <span class="kpi-delta">중간 집중도</span>
                                <div class="kpi-tooltip">
                                    <div class="tooltip-header">📉 시장집중도 (HHI: Herfindahl Index)</div>
                                    <div class="tooltip-content">
                                        <p><strong>정의</strong><br>시장 집중도를 측정하는 경제학 지표</p>
                                        <p><strong>계산</strong><br>각 브랜드 SoS(%)² 의 합</p>
                                        <p><strong>해석</strong><br>• 0.25 이상: 고집중 시장<br>• 0.15~0.25: 중간 집중<br>• 0.15 미만: 분산 시장<br>• 높을수록 소수 브랜드 독점</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="content-grid brand-analysis-grid">
                            <div class="card">
                                <div class="card-header" style="flex-wrap: wrap; gap: 8px;">
                                    <div class="card-title has-tooltip">
                                        <div class="card-title-icon"><i data-lucide="scatter-chart" style="color: white; width: 16px; height: 16px;"></i></div>
                                        <span>Laneige vs 경쟁사 시장점유율 × 평균순위</span>
                                        <i data-lucide="help-circle" class="help-icon" style="width: 14px; height: 14px; margin-left: 6px; opacity: 0.6;"></i>
                                        <div class="chart-title-tooltip">
                                            <div class="tooltip-header">📊 지표 설명</div>
                                            <div class="tooltip-content">
                                                <p><strong>시장점유율 (SoS)</strong><br>Top 100 중 해당 브랜드 제품 비율 (%)<br>예: 5% = Top 100 중 5개 제품 보유</p>
                                                <p><strong>평균순위 (Avg Rank)</strong><br>해당 브랜드 제품들의 평균 순위<br>숫자가 낮을수록 상위권</p>
                                                <p><strong>해석</strong><br>• 우측 하단: 점유율 高 + 순위 高 (이상적)<br>• 좌측 상단: 점유율 低 + 순위 低 (개선 필요)</p>
                                            </div>
                                            <div class="tooltip-period-info" id="brandMatrixPeriodInfo">
                                                📅 분석 기간: 로딩 중...
                                            </div>
                                        </div>
                                    </div>
                                    <div class="chart-date-range" id="brandMatrixDateRange">
                                        <label>기간:</label>
                                        <input type="date" id="brandMatrixStartDate" />
                                        <span class="date-separator">~</span>
                                        <input type="date" id="brandMatrixEndDate" />
                                        <button class="apply-btn" onclick="applyBrandMatrixDateRange()">적용</button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container chart-container-large"><canvas id="brandMatrixChart"></canvas></div>
                                    <div class="chart-guide" style="margin-top: 16px;"><strong>해석 가이드:</strong> 우측 하단 = 물량 多 + 상위권 강함 (정상 성장) / 우측 상단 = 물량 多 + 상위권 약함 (효율 악화)</div>
                                    <div class="data-gap-warning" id="brandMatrixDataGap" style="display: none;">
                                        <i data-lucide="alert-triangle"></i>
                                        <span id="brandMatrixDataGapText">데이터 없는 기간이 있습니다.</span>
                                    </div>
                                </div>
                            </div>
                            <!-- 경쟁사 비교 테이블 -->
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title has-tooltip">
                                        <div class="card-title-icon"><i data-lucide="users" style="color: white; width: 16px; height: 16px;"></i></div>
                                        경쟁사 비교 분석
                                        <i data-lucide="help-circle" class="help-icon" style="width: 14px; height: 14px; margin-left: 6px; opacity: 0.6;"></i>
                                        <div class="chart-title-tooltip">
                                            <div class="tooltip-header">📊 경쟁사 선정 기준</div>
                                            <div class="tooltip-content">
                                                <p><strong>선정 기준</strong><br>모니터링 중인 5개 카테고리 Top 100 내 제품 보유 브랜드</p>
                                                <p><strong>SoS 기준 정렬</strong><br>Share of Shelf(진열 점유율) 높은 순서로 Top 5 표시</p>
                                                <p><strong>모니터링 카테고리</strong><br>• Beauty & Personal Care (L0)<br>&nbsp;&nbsp;└ Skin Care (L1) → Lip Care (L2)<br>&nbsp;&nbsp;└ Make Up → Lip Makeup (L2), Face Powder (L3)</p>
                                            </div>
                                        </div>
                                    </div>
                                    <span class="card-badge" style="background: rgba(31, 87, 149, 0.1); color: var(--amore-blue);">Top 5 브랜드</span>
                                </div>
                                <div class="card-body" style="padding: 0;">
                                    <table class="action-table" id="competitor-table">
                                        <thead>
                                            <tr>
                                                <th class="has-tooltip">
                                                    <span class="th-content">순위 <i data-lucide="help-circle" class="help-icon"></i></span>
                                                    <div class="th-tooltip">시장점유율 기준 순위입니다. 1위가 가장 높은 점유율을 보유합니다.</div>
                                                </th>
                                                <th class="has-tooltip">
                                                    <span class="th-content">브랜드 <i data-lucide="help-circle" class="help-icon"></i></span>
                                                    <div class="th-tooltip">Top 100 내 제품을 보유한 브랜드입니다. LANEIGE가 기준점으로 표시됩니다.</div>
                                                </th>
                                                <th class="has-tooltip">
                                                    <span class="th-content">점유율 <i data-lucide="help-circle" class="help-icon"></i></span>
                                                    <div class="th-tooltip"><strong>시장점유율 (SoS)</strong><br>Top 100 중 해당 브랜드 제품 비율(%). 예: 5% = 100개 중 5개 제품 보유</div>
                                                </th>
                                                <th class="has-tooltip">
                                                    <span class="th-content">제품수 <i data-lucide="help-circle" class="help-icon"></i></span>
                                                    <div class="th-tooltip">해당 브랜드가 Top 100 내에 보유한 제품 개수입니다.</div>
                                                </th>
                                                <th class="has-tooltip">
                                                    <span class="th-content">평균순위 <i data-lucide="help-circle" class="help-icon"></i></span>
                                                    <div class="th-tooltip">해당 브랜드 모든 제품의 평균 베스트셀러 순위입니다. 숫자가 낮을수록 상위권입니다.</div>
                                                </th>
                                                <th class="has-tooltip">
                                                    <span class="th-content">평균가격 <i data-lucide="help-circle" class="help-icon"></i></span>
                                                    <div class="th-tooltip"><strong>평균 판매가</strong><br>해당 브랜드 Top 100 제품들의 평균 판매 가격(USD)입니다.</div>
                                                </th>
                                                <th class="has-tooltip">
                                                    <span class="th-content">vs Laneige <i data-lucide="help-circle" class="help-icon"></i></span>
                                                    <div class="th-tooltip">LANEIGE 대비 점유율 차이(%p)입니다.<br>• 양수(+): LANEIGE보다 높음<br>• 음수(-): LANEIGE보다 낮음</div>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="competitor-tbody">
                                            <tr class="highlight-row">
                                                <td><span class="rank-badge">#1</span></td>
                                                <td><strong>LANEIGE</strong></td>
                                                <td>4.0%</td>
                                                <td>8개</td>
                                                <td>25.3위</td>
                                                <td>$26.89</td>
                                                <td><span class="vs-badge baseline">기준</span></td>
                                            </tr>
                                            <tr>
                                                <td><span class="rank-badge">#2</span></td>
                                                <td>COSRX</td>
                                                <td>3.8%</td>
                                                <td>12개</td>
                                                <td>32.1위</td>
                                                <td>$19.85</td>
                                                <td><span class="vs-badge behind">-0.2%p</span></td>
                                            </tr>
                                            <tr>
                                                <td><span class="rank-badge">#3</span></td>
                                                <td>Summer Fridays</td>
                                                <td>3.2%</td>
                                                <td>4개</td>
                                                <td>15.8위</td>
                                                <td>$41.99</td>
                                                <td><span class="vs-badge behind">-0.8%p</span></td>
                                            </tr>
                                            <tr>
                                                <td><span class="rank-badge">#4</span></td>
                                                <td>e.l.f.</td>
                                                <td>2.9%</td>
                                                <td>18개</td>
                                                <td>45.2위</td>
                                                <td>$8.50</td>
                                                <td><span class="vs-badge behind">-1.1%p</span></td>
                                            </tr>
                                            <tr>
                                                <td><span class="rank-badge">#5</span></td>
                                                <td>Rare Beauty</td>
                                                <td>2.5%</td>
                                                <td>6개</td>
                                                <td>28.4위</td>
                                                <td>$24.00</td>
                                                <td><span class="vs-badge behind">-1.5%p</span></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <div class="chart-guide" style="margin: 16px;"><strong>해석 가이드:</strong> 점유율 高 = 시장점유율 우위 / 평균순위 低 = 상위권 집중 / vs LANEIGE (+)%p = LANEIGE보다 점유율 높음</div>
                                </div>
                            </div>
                        </div>

                        <!-- Enhanced Competitor Comparison Section -->
                        <div class="content-grid single">
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title has-tooltip">
                                        <div class="card-title-icon"><i data-lucide="target" style="color: white; width: 16px; height: 16px;"></i></div>
                                        상세 경쟁사 비교
                                        <i data-lucide="help-circle" class="help-icon" style="width: 14px; height: 14px; margin-left: 6px; opacity: 0.6;"></i>
                                        <div class="chart-title-tooltip">
                                            <div class="tooltip-header">🎯 상세 경쟁사 비교</div>
                                            <div class="tooltip-content">
                                                <p><strong>기능</strong><br>선택한 경쟁사와 LANEIGE의 핵심 지표를 1:1 비교 분석합니다.</p>
                                                <p><strong>비교 항목</strong><br>• 시장점유율 차이<br>• 평균 순위 비교<br>• 제품 수량 대비<br>• 평균 가격 비교</p>
                                                <p><strong>활용법</strong><br>드롭다운에서 경쟁사를 선택하면 상세 비교 정보가 표시됩니다.</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="competitor-selector">
                                        <span class="competitor-label">비교 대상:</span>
                                        <select id="competitor-select" class="competitor-dropdown" onchange="updateCompetitorComparison()">
                                            <option value="">선택하세요</option>
                                            <option value="Summer Fridays">Summer Fridays (프리미엄 경쟁사)</option>
                                            <!-- 나머지 옵션은 동적으로 추가됨 -->
                                        </select>
                                    </div>
                                </div>
                                <div class="card-body" id="detailed-comparison-body">
                                    <div style="text-align: center; padding: 40px 0; color: var(--text-secondary);">
                                        <i data-lucide="users" style="width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.3;"></i>
                                        <p>비교할 경쟁사를 선택하세요</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="quick-actions"><button class="quick-action-btn accent" onclick="openAIDrawer()"><i data-lucide="sparkles" style="width: 18px; height: 18px;"></i>AI 전략 리포트 생성</button></div>
                    </div>

                    <!-- CATEGORY PAGE (L2) -->
                    <div id="page-category" class="page-view">
                        <!-- 카테고리 계층 구조:
                             Beauty & Personal Care (L0)
                             ├── Skin Care (L1)
                             │   └── Lip Care (L2)
                             └── Make Up (L1)
                                 ├── Lip Makeup (L2)
                                 └── Face (L2)
                                     └── Face Powder (L3)
                        -->
                        <div class="category-header-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div class="section-title" style="font-size: 14px; font-weight: 600; color: var(--pacific-blue);">
                                <i data-lucide="bar-chart-2" style="width: 16px; height: 16px; margin-right: 6px;"></i>
                                카테고리별 KPI 현황
                            </div>
                            <div class="chart-date-range" id="categoryDateRange">
                                <label>기간:</label>
                                <input type="date" id="categoryStartDate">
                                <span class="date-separator">~</span>
                                <input type="date" id="categoryEndDate">
                                <button class="apply-btn" onclick="applyCategoryDateRange()">적용</button>
                            </div>
                        </div>
                        <div class="category-tabs">
                            <div class="category-tab active" onclick="selectCategory('beauty', this)" title="Amazon Best Sellers in Beauty & Personal Care (전체 뷰티 랭킹, Level 0)" data-level="0" data-parent="">Beauty & Personal Care</div>
                            <div class="category-tab" onclick="selectCategory('skin', this)" title="Beauty > Skin Care (Node ID: 11060451, Level 1)" data-level="1" data-parent="beauty">Skin Care</div>
                            <div class="category-tab" onclick="selectCategory('lip', this)" title="Beauty > Skin Care > Lip Care (Node ID: 3761351, Level 2)" data-level="2" data-parent="skin_care">Lip Care</div>
                            <div class="category-tab" onclick="selectCategory('lip_makeup', this)" title="Beauty > Make Up > Lip Makeup (Node ID: 11059031, Level 2)" data-level="2" data-parent="makeup">Lip Makeup</div>
                            <div class="category-tab" onclick="selectCategory('face_powder', this)" title="Beauty > Make Up > Face > Face Powder (Node ID: 11058971, Level 3)" data-level="3" data-parent="face_makeup">Face Powder</div>
                        </div>
                        <div class="kpi-grid">
                            <div class="kpi-card has-tooltip">
                                <div class="kpi-label">카테고리 점유율 <i data-lucide="help-circle" class="help-icon" style="width: 12px; height: 12px;"></i></div>
                                <div class="kpi-value" id="cat-sos">18.5<span class="unit">%</span></div>
                                <span class="kpi-delta up" id="cat-sos-badge">Category Leader</span>
                                <div class="kpi-tooltip">
                                    <div class="tooltip-header">📊 카테고리 점유율 (SoS)</div>
                                    <div class="tooltip-content">
                                        <p><strong>정의</strong><br>해당 카테고리 Top 100 중 Laneige 제품이 차지하는 비율</p>
                                        <p><strong>해석 기준</strong><br>• 15% 이상: Category Leader<br>• 10~15%: 점유율 확대 필요<br>• 10% 미만: 점유율 확대 시급</p>
                                        <p><strong>의미</strong><br>높을수록 카테고리 내 존재감이 크며, 소비자 선택 가능성이 높음</p>
                                    </div>
                                </div>
                            </div>
                            <div class="kpi-card has-tooltip">
                                <div class="kpi-label">Laneige Rank <i data-lucide="help-circle" class="help-icon" style="width: 12px; height: 12px;"></i></div>
                                <div class="kpi-value" id="cat-rank">#2</div>
                                <span class="kpi-delta up" id="cat-rank-badge">1위 근접</span>
                                <div class="kpi-tooltip">
                                    <div class="tooltip-header">🏆 Laneige Rank</div>
                                    <div class="tooltip-content">
                                        <p><strong>정의</strong><br>Laneige 제품 중 해당 카테고리에서 가장 높은 순위</p>
                                        <p><strong>해석 기준</strong><br>• 1~3위: 1위 근접 (우수)<br>• 4~10위: Top 10 (양호)<br>• 11위 이하: 순위 개선 필요</p>
                                        <p><strong>의미</strong><br>숫자가 낮을수록 좋으며, 카테고리 내 경쟁력을 나타냄</p>
                                    </div>
                                </div>
                            </div>
                            <div class="kpi-card has-tooltip">
                                <div class="kpi-label">가격경쟁지수 <i data-lucide="help-circle" class="help-icon" style="width: 12px; height: 12px;"></i></div>
                                <div class="kpi-value" id="cat-cpi">112<span class="unit">pt</span></div>
                                <span class="kpi-delta down" id="cat-cpi-badge">가격 경쟁력 하락</span>
                                <div class="kpi-tooltip">
                                    <div class="tooltip-header">💰 가격경쟁지수 (CPI)</div>
                                    <div class="tooltip-content">
                                        <p><strong>정의</strong><br>경쟁사 대비 Laneige 가격 수준 지수</p>
                                        <p><strong>해석 기준</strong><br>• 100 = 경쟁사와 동일<br>• 100 초과 = 경쟁사보다 고가<br>• 100 미만 = 경쟁사보다 저가</p>
                                        <p><strong>상태 분류</strong><br>• 110 이상: 가격 경쟁력 하락<br>• 90~110: 적정 가격<br>• 90 미만: 가격 경쟁력 우위</p>
                                    </div>
                                </div>
                            </div>
                            <div class="kpi-card has-tooltip">
                                <div class="kpi-label">신규 경쟁자 <i data-lucide="help-circle" class="help-icon" style="width: 12px; height: 12px;"></i></div>
                                <div class="kpi-value" id="cat-new">18<span class="unit">개</span></div>
                                <span class="kpi-delta down" id="cat-new-badge">경쟁 심화</span>
                                <div class="kpi-tooltip">
                                    <div class="tooltip-header">🆕 신규 경쟁자</div>
                                    <div class="tooltip-content">
                                        <p><strong>정의</strong><br>최근 7일 내 Top 100에 새로 진입한 경쟁 브랜드/제품 수</p>
                                        <p><strong>해석 기준</strong><br>• 15개 이상: 경쟁 심화<br>• 5~15개: 보통<br>• 5개 미만: 안정적</p>
                                        <p><strong>의미</strong><br>많을수록 시장 경쟁이 치열하며, 순위 변동 가능성 높음</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="content-grid single">
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title has-tooltip">
                                        <div class="card-title-icon"><i data-lucide="bar-chart" style="color: white; width: 16px; height: 16px;"></i></div>
                                        가격경쟁지수 추이
                                        <i data-lucide="help-circle" class="help-icon" style="width: 14px; height: 14px; margin-left: 6px; opacity: 0.6;"></i>
                                        <div class="chart-title-tooltip">
                                            <div class="tooltip-header">📈 가격경쟁지수 (CPI) 추이</div>
                                            <div class="tooltip-content">
                                                <p><strong>차트 설명</strong><br>경쟁사 대비 Laneige의 가격 경쟁력 지수(CPI)를 일별로 추적합니다.</p>
                                                <p><strong>기준선 해석</strong><br>• 파란 실선: Laneige CPI<br>• 점선 (100): 경쟁사 동일 가격 기준</p>
                                                <p><strong>활용법</strong><br>CPI가 100 위면 프리미엄 포지셔닝, 100 아래면 가격 경쟁력 우위</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <label style="font-size: 12px; color: #666;">LANEIGE:</label>
                                            <select id="cpiLaneigeProductSelect" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; max-width: 180px;">
                                                <option value="">제품 선택...</option>
                                            </select>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <label style="font-size: 12px; color: #666;">vs 경쟁사:</label>
                                            <select id="cpiCompetitorProductSelect" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; max-width: 180px;">
                                                <option value="">제품 선택...</option>
                                            </select>
                                        </div>
                                        <div class="chart-date-range" id="cpiDateRange">
                                            <label>기간:</label>
                                            <input type="date" id="cpiStartDate">
                                            <span class="date-separator">~</span>
                                            <input type="date" id="cpiEndDate">
                                            <button class="apply-btn" onclick="applyCpiDateRange()">적용</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container"><canvas id="cpiChart"></canvas></div>
                                    <div class="chart-guide">
                                        <strong>CPI (Competitive Price Index):</strong> 100 이상 = 경쟁사 대비 고가 / 100 미만 = 경쟁사 대비 저가<br>
                                        <span id="cpi-comparison-info" style="color: var(--text-secondary); font-size: 11px; margin-top: 4px; display: inline-block;">
                                            📊 제품을 선택하면 CPI 비교 차트가 표시됩니다.
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PRODUCT PAGE (L3) -->
                    <div id="page-product" class="page-view">
                        <div class="product-header-row">
                            <div class="selector-group">
                                <span class="selector-label">카테고리</span>
                                <div class="selector-wrapper">
                                    <select class="selector-dropdown" id="productCategory" onchange="updateProductList()">
                                        <option value="beauty">Beauty & Personal Care</option>
                                        <option value="skin_care">Skin Care</option>
                                        <option value="lip_care">Lip Care</option>
                                        <option value="lip_makeup">Lip Makeup</option>
                                        <option value="face_powder">Face Powder</option>
                                    </select>
                                    <div class="selector-tooltip">
                                        <div class="selector-tooltip-header">📁 카테고리 선택</div>
                                        <div class="selector-tooltip-content">
                                            <p><strong>기능</strong><br>분석할 Amazon 베스트셀러 카테고리를 선택합니다.</p>
                                            <p><strong>카테고리 계층</strong></p>
                                            <ul>
                                                <li>Beauty & Personal Care (전체)</li>
                                                <li>↳ Skin Care → Lip Care</li>
                                                <li>↳ Makeup → Lip Makeup, Face Powder</li>
                                            </ul>
                                            <p><strong>선택 시</strong><br>해당 카테고리 내 LANEIGE 제품 목록이 업데이트됩니다.</p>
                                        </div>
                                    </div>
                                </div>
                                <span class="selector-label">제품</span>
                                <div class="selector-wrapper">
                                    <select class="selector-dropdown" id="productSelect" onchange="updateProductView()">
                                        <option value="lip-mask-berry">Lip Sleeping Mask (Berry)</option>
                                        <option value="lip-mask-original">Lip Sleeping Mask (Original)</option>
                                        <option value="lip-glowy">Lip Glowy Balm</option>
                                    </select>
                                    <div class="selector-tooltip">
                                        <div class="selector-tooltip-header">📦 제품 선택</div>
                                        <div class="selector-tooltip-content">
                                            <p><strong>선택 기준</strong><br>선택한 카테고리의 Top 100 내 LANEIGE 제품이 표시됩니다.</p>
                                            <p><strong>정렬 방식</strong><br>베스트셀러 순위가 높은 제품이 먼저 표시됩니다.</p>
                                            <p><strong>대시보드 정보</strong></p>
                                            <ul>
                                                <li>현재순위: 베스트셀러 순위</li>
                                                <li>순위변동성: 7일간 순위 변동 폭</li>
                                                <li>고객평점: Amazon 평점</li>
                                                <li>순위고착도: Top 100 연속 등장 일수</li>
                                            </ul>
                                            <p><strong>차트</strong><br>순위/가격 추이, 제품 매트릭스, 할인율 분석</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-date-range" id="productDateRange">
                                <label>기간:</label>
                                <input type="date" id="productStartDate" value="2026-01-12">
                                <span class="date-separator">~</span>
                                <input type="date" id="productEndDate" value="2026-01-19">
                                <button class="apply-btn" onclick="applyProductDateRange()">적용</button>
                            </div>
                        </div>
                        <div class="kpi-grid">
                            <div class="kpi-card has-tooltip">
                                <div class="kpi-label">현재순위 <i data-lucide="help-circle" class="help-icon" style="width: 12px; height: 12px;"></i></div>
                                <div class="kpi-value" id="prod-rank">#2</div>
                                <span class="kpi-delta up" id="prod-rank-delta">▲ 1위 상승</span>
                                <div class="kpi-tooltip">
                                    <div class="tooltip-header">🏆 현재순위</div>
                                    <div class="tooltip-content">
                                        <p><strong>정의</strong><br>선택한 제품의 현재 베스트셀러 순위</p>
                                        <p><strong>해석</strong><br>• 1~10위: 최상위권<br>• 11~50위: 상위권<br>• 51~100위: 중위권</p>
                                        <p><strong>변동</strong><br>전일 대비 순위 변화를 함께 표시</p>
                                    </div>
                                </div>
                            </div>
                            <div class="kpi-card has-tooltip">
                                <div class="kpi-label">순위변동성 <i data-lucide="help-circle" class="help-icon" style="width: 12px; height: 12px;"></i></div>
                                <div class="kpi-value" id="prod-vol">12<span class="unit">pt</span></div>
                                <span class="kpi-delta" id="prod-vol-delta">안정적</span>
                                <div class="kpi-tooltip">
                                    <div class="tooltip-header">📊 순위변동성 (Volatility)</div>
                                    <div class="tooltip-content">
                                        <p><strong>정의</strong><br>최근 7일간 순위 변동 표준편차</p>
                                        <p><strong>해석 기준</strong><br>• 10pt 미만: 매우 안정<br>• 10~20pt: 안정적<br>• 20~30pt: 변동성 높음<br>• 30pt 이상: 불안정</p>
                                        <p><strong>의미</strong><br>낮을수록 순위가 안정적으로 유지됨</p>
                                    </div>
                                </div>
                            </div>
                            <div class="kpi-card has-tooltip">
                                <div class="kpi-label">고객평점 <i data-lucide="help-circle" class="help-icon" style="width: 12px; height: 12px;"></i></div>
                                <div class="kpi-value" id="prod-rating">4.5<span class="unit">★</span></div>
                                <span class="kpi-delta up" id="prod-rating-delta">상위 10%</span>
                                <div class="kpi-tooltip">
                                    <div class="tooltip-header">⭐ 고객평점</div>
                                    <div class="tooltip-content">
                                        <p><strong>정의</strong><br>Amazon 고객 평점 (5.0 만점)</p>
                                        <p><strong>해석 기준</strong><br>• 4.5 이상: 상위 10%<br>• 4.0~4.5: 양호<br>• 4.0 미만: 개선 필요</p>
                                        <p><strong>의미</strong><br>고객 만족도와 제품 품질 지표</p>
                                    </div>
                                </div>
                            </div>
                            <div class="kpi-card has-tooltip">
                                <div class="kpi-label">순위고착도 <i data-lucide="help-circle" class="help-icon" style="width: 12px; height: 12px;"></i></div>
                                <div class="kpi-value" id="prod-stick">92<span class="unit">pt</span></div>
                                <span class="kpi-delta up" id="prod-stick-delta">고착화 높음</span>
                                <div class="kpi-tooltip">
                                    <div class="tooltip-header">📌 순위고착도 (Stickiness)</div>
                                    <div class="tooltip-content">
                                        <p><strong>정의</strong><br>Top 100 내 연속 등장 일수 기반 점수</p>
                                        <p><strong>해석 기준</strong><br>• 90pt 이상: 고착화 높음<br>• 70~90pt: 중간<br>• 70pt 미만: 불안정</p>
                                        <p><strong>의미</strong><br>높을수록 베스트셀러 지위가 안정적</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="content-grid">
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title has-tooltip">
                                        <div class="card-title-icon"><i data-lucide="line-chart" style="color: white; width: 16px; height: 16px;"></i></div>
                                        순위 & 가격 추이 (vs 카테고리 1위)
                                        <i data-lucide="help-circle" class="help-icon" style="width: 14px; height: 14px; margin-left: 6px; opacity: 0.6;"></i>
                                        <div class="chart-title-tooltip">
                                            <div class="tooltip-header">📈 순위 & 가격 추이</div>
                                            <div class="tooltip-content">
                                                <p><strong>차트 설명</strong><br>Laneige 제품과 카테고리 1위 제품의 순위/가격을 비교합니다.</p>
                                                <p><strong>라인 구분</strong><br>• 실선: Laneige 제품<br>• 점선: 카테고리 1위 (Summer Fridays)<br>• 1위 기준선: 최상위 순위</p>
                                                <p><strong>활용법</strong><br>경쟁사 대비 순위 추세와 가격 변동 패턴을 파악</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="chart-date-range" id="rankTrendDateRange">
                                        <label>기간:</label>
                                        <input type="date" id="rankTrendStartDate">
                                        <span class="date-separator">~</span>
                                        <input type="date" id="rankTrendEndDate">
                                        <button class="apply-btn" onclick="applyRankTrendDateRange()">적용</button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="product-selector-row" style="margin-bottom: 12px; display: flex; align-items: center; gap: 12px;">
                                        <label style="font-weight: 500; color: var(--text-secondary); white-space: nowrap;">제품 선택:</label>
                                        <div class="custom-dropdown" id="productDropdown" style="position: relative; min-width: 280px;">
                                            <button type="button" class="dropdown-toggle" id="productDropdownToggle" onclick="toggleProductDropdown()" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; background: white; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-size: 13px;">
                                                <span id="productDropdownLabel">전체 제품</span>
                                                <i data-lucide="chevron-down" style="width: 16px; height: 16px; opacity: 0.6;"></i>
                                            </button>
                                            <div class="dropdown-menu" id="productDropdownMenu" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-height: 300px; overflow-y: auto; margin-top: 4px;">
                                                <div class="dropdown-item" style="padding: 8px 12px; border-bottom: 1px solid #eee;">
                                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px;">
                                                        <input type="checkbox" id="productSelectAll" checked onchange="toggleAllProducts(this.checked)" style="width: 16px; height: 16px;">
                                                        <span style="font-weight: 500;">전체 선택</span>
                                                    </label>
                                                </div>
                                                <div id="productCheckboxList"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="chart-container"><canvas id="rankTrendChart"></canvas></div>
                                    <div class="chart-guide"><strong>비교 대상:</strong> Summer Fridays Lip Butter Balm (현재 카테고리 1위)</div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title has-tooltip">
                                        <div class="card-title-icon"><i data-lucide="grid-3x3" style="color: white; width: 16px; height: 16px;"></i></div>
                                        Laneige 제품 매트릭스
                                        <i data-lucide="help-circle" class="help-icon" style="width: 14px; height: 14px; margin-left: 6px; opacity: 0.6;"></i>
                                        <div class="chart-title-tooltip">
                                            <div class="tooltip-header">🎯 Laneige 제품 매트릭스</div>
                                            <div class="tooltip-content">
                                                <p><strong>차트 설명</strong><br>X축(순위)과 Y축(변동성)으로 제품 포지션을 시각화합니다.</p>
                                                <p><strong>4분면 해석</strong><br>• 좌하단(King): 안정적 상위권<br>• 좌상단(Rising): 급부상 중<br>• 우하단(Lagging): 정체<br>• 우상단(Risk): 위험</p>
                                                <p><strong>버블 크기</strong><br>제품의 리뷰 수 또는 중요도 반영</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="chart-date-range" id="matrixDateRange">
                                        <label>기간:</label>
                                        <input type="date" id="matrixStartDate">
                                        <span class="date-separator">~</span>
                                        <input type="date" id="matrixEndDate">
                                        <button class="apply-btn" onclick="applyMatrixDateRange()">적용</button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container"><canvas id="productMatrixChart"></canvas></div>
                                    <div class="chart-guide"><strong>4분면 해석:</strong> 좌하단(King) = 안정적 상위권 / 좌상단(Rising) = 급부상 / 우하단(Lagging) = 정체 / 우상단(Risk) = 위험</div>
                                </div>
                            </div>
                        </div>
                        <!-- 할인율 추이 그래프 -->
                        <div class="content-grid single">
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title has-tooltip">
                                        <div class="card-title-icon"><i data-lucide="percent" style="color: white; width: 16px; height: 16px;"></i></div>
                                        가격 & 할인율 추이
                                        <i data-lucide="help-circle" class="help-icon" style="width: 14px; height: 14px; margin-left: 6px; opacity: 0.6;"></i>
                                        <div class="chart-title-tooltip">
                                            <div class="tooltip-header">💵 가격 & 할인율 추이</div>
                                            <div class="tooltip-content">
                                                <p><strong>차트 설명</strong><br>제품의 판매가와 할인율을 일별로 추적합니다.</p>
                                                <p><strong>라인 구분</strong><br>• 파란 실선: 판매가 ($)<br>• 노란 점선: 할인율 (%)</p>
                                                <p><strong>해석 가이드</strong><br>• 할인율↑: 프로모션 강화<br>• 가격↓: 가격 경쟁력 확보</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <label style="font-size: 12px; color: #666;">제품:</label>
                                            <select id="discountProductSelect" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; max-width: 200px;">
                                                <option value="">제품 선택...</option>
                                            </select>
                                        </div>
                                        <div class="chart-date-range" id="discountDateRange">
                                            <label>기간:</label>
                                            <input type="date" id="discountStartDate">
                                            <span class="date-separator">~</span>
                                            <input type="date" id="discountEndDate">
                                            <button class="apply-btn" onclick="applyDiscountDateRange()">적용</button>
                                        </div>
                                        <span class="card-badge" id="discount-badge" style="background: rgba(31, 87, 149, 0.1); color: var(--amore-blue);">현재 할인율: --%</span>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container"><canvas id="discountTrendChart"></canvas></div>
                                    <div class="chart-guide">
                                        <strong>해석 가이드:</strong> 할인율 상승 = 프로모션 강화 / 가격 하락 = 가격 경쟁력 확보
                                        <span id="discount-insight" style="color: var(--amore-blue); margin-left: 12px;"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- 성장 유형 분류 & 경쟁사 프로모션 비교 -->
                        <div class="content-grid">
                            <!-- 성장 유형 분류 -->
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title has-tooltip">
                                        <div class="card-title-icon"><i data-lucide="trending-up" style="color: white; width: 16px; height: 16px;"></i></div>
                                        제품 성장 유형 분류
                                        <i data-lucide="help-circle" class="help-icon" style="width: 14px; height: 14px; margin-left: 6px; opacity: 0.6;"></i>
                                        <div class="chart-title-tooltip">
                                            <div class="tooltip-header">📊 성장 유형 분류</div>
                                            <div class="tooltip-content">
                                                <p><strong>분류 기준</strong><br>제품의 순위 상승이 자연적인지, 할인에 의존하는지 분석</p>
                                                <p><strong>오가닉 성장</strong><br>할인/프로모션 없이 순위 상승 (건강한 성장)</p>
                                                <p><strong>할인 기반 성장</strong><br>15%↑ 할인, 쿠폰, 딜 활용 시 (주의 필요)</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <label style="font-size: 12px; color: #666;">제품:</label>
                                            <select id="growthTypeProductSelect" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; max-width: 200px;">
                                                <option value="">전체 LANEIGE 제품</option>
                                            </select>
                                        </div>
                                        <div class="chart-date-range" id="growthTypeDateRange">
                                            <label>기간:</label>
                                            <input type="date" id="growthTypeStartDate">
                                            <span class="date-separator">~</span>
                                            <input type="date" id="growthTypeEndDate">
                                            <button class="apply-btn" onclick="applyGrowthTypeDateRange()">적용</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="growth-type-container" id="growth-type-container">
                                        <div class="growth-type-box organic">
                                            <div class="growth-type-icon-wrapper">
                                                <i data-lucide="trending-up" style="width: 24px; height: 24px; color: var(--amore-blue);"></i>
                                            </div>
                                            <div class="growth-type-label">오가닉 성장</div>
                                            <div class="growth-type-value" id="organic-count">-</div>
                                            <div class="growth-type-desc">할인/프로모션 없이 순위 상승</div>
                                        </div>
                                        <div class="growth-type-box discount">
                                            <div class="growth-type-icon-wrapper">
                                                <i data-lucide="tag" style="width: 24px; height: 24px; color: var(--pacific-blue);"></i>
                                            </div>
                                            <div class="growth-type-label">할인 기반 성장</div>
                                            <div class="growth-type-value" id="discount-count">-</div>
                                            <div class="growth-type-desc">15%↑ 할인 또는 쿠폰/딜 활용</div>
                                        </div>
                                    </div>
                                    <div class="chart-guide" style="margin-top: 16px;">
                                        <strong>분류 기준:</strong> 할인율 15% 초과, 쿠폰 적용, Lightning/Limited Deal 중 하나라도 해당 시 "할인 기반"으로 분류
                                    </div>
                                </div>
                            </div>
                            <!-- 경쟁사 프로모션 비교 -->
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title has-tooltip">
                                        <div class="card-title-icon"><i data-lucide="users" style="color: white; width: 16px; height: 16px;"></i></div>
                                        경쟁사 프로모션 비교
                                        <i data-lucide="help-circle" class="help-icon" style="width: 14px; height: 14px; margin-left: 6px; opacity: 0.6;"></i>
                                        <div class="chart-title-tooltip">
                                            <div class="tooltip-header">🏷️ 경쟁사 프로모션 비교</div>
                                            <div class="tooltip-content">
                                                <p><strong>분석 대상</strong><br>카테고리 Top 10 브랜드의 프로모션 현황을 비교합니다.</p>
                                                <p><strong>항목 설명</strong><br>• 평균할인: 제품별 평균 할인율<br>• 쿠폰: 쿠폰 적용 제품 수<br>• 딜: Lightning/Limited Deal 수<br>• S&S: Subscribe & Save 제품 수</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <label style="font-size: 12px; color: #666;">제품:</label>
                                            <select id="competitorProductSelect" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; max-width: 200px;">
                                                <option value="">제품 선택...</option>
                                            </select>
                                        </div>
                                        <div class="chart-date-range" id="competitorPromoDateRange">
                                            <label>기간:</label>
                                            <input type="date" id="competitorPromoStartDate">
                                            <span class="date-separator">~</span>
                                            <input type="date" id="competitorPromoEndDate">
                                            <button class="apply-btn" onclick="applyCompetitorPromoDateRange()">적용</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="promo-table-container">
                                        <table class="promo-table" id="competitor-promo-table">
                                            <thead>
                                                <tr>
                                                    <th>제품명</th>
                                                    <th>브랜드</th>
                                                    <th>평균순위</th>
                                                    <th>할인율</th>
                                                    <th>쿠폰</th>
                                                    <th>S&S</th>
                                                </tr>
                                            </thead>
                                            <tbody id="competitor-promo-tbody">
                                                <tr><td colspan="6" style="text-align: center; color: var(--text-secondary);">데이터 로딩 중...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="chart-guide" style="margin-top: 12px;">
                                        <strong>S&S:</strong> Subscribe & Save 제품 수 | <strong>딜:</strong> Lightning/Limited Time Deal
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                        <div class="kpi-grid">
                            <div class="kpi-card has-tooltip">
                                <div class="kpi-label">Active Deals <i data-lucide="help-circle" class="help-icon" style="width: 12px; height: 12px;"></i></div>
                                <div class="kpi-value" id="deals-total-count">--<span class="unit">개</span></div>
                                <span class="kpi-delta" id="deals-total-delta">경쟁사 할인</span>
                                <div class="kpi-tooltip">
                                    <div class="tooltip-header">🏷️ Active Deals</div>
                                    <div class="tooltip-content">
                                        <p><strong>정의</strong><br>현재 진행 중인 경쟁사 할인 수</p>
                                        <p><strong>의미</strong><br>경쟁사 프로모션 강도 지표</p>
                                    </div>
                                </div>
                            </div>
                            <div class="kpi-card has-tooltip">
                                <div class="kpi-label">Lightning Deals <i data-lucide="help-circle" class="help-icon" style="width: 12px; height: 12px;"></i></div>
                                <div class="kpi-value" id="deals-lightning-count">--<span class="unit">개</span></div>
                                <span class="kpi-delta" id="deals-lightning-delta" style="background: rgba(255, 107, 107, 0.1); color: #ef4444;">⚡ 시간 한정</span>
                                <div class="kpi-tooltip">
                                    <div class="tooltip-header">⚡ Lightning Deals</div>
                                    <div class="tooltip-content">
                                        <p><strong>정의</strong><br>시간 한정 Lightning Deal 수</p>
                                        <p><strong>주의</strong><br>경쟁사 Lightning Deal이 많으면 LANEIGE 순위 하락 가능</p>
                                    </div>
                                </div>
                            </div>
                            <div class="kpi-card has-tooltip">
                                <div class="kpi-label">Avg Discount <i data-lucide="help-circle" class="help-icon" style="width: 12px; height: 12px;"></i></div>
                                <div class="kpi-value" id="deals-avg-discount">--<span class="unit">%</span></div>
                                <span class="kpi-delta" id="deals-avg-discount-delta">평균 할인율</span>
                                <div class="kpi-tooltip">
                                    <div class="tooltip-header">📊 평균 할인율</div>
                                    <div class="tooltip-content">
                                        <p><strong>정의</strong><br>경쟁사 딜의 평균 할인율</p>
                                        <p><strong>해석</strong><br>• 20% 이상: 공격적 프로모션<br>• 10~20%: 일반적<br>• 10% 미만: 보수적</p>
                                    </div>
                                </div>
                            </div>
                            <div class="kpi-card has-tooltip">
                                <div class="kpi-label">Max Discount <i data-lucide="help-circle" class="help-icon" style="width: 12px; height: 12px;"></i></div>
                                <div class="kpi-value" id="deals-max-discount">--<span class="unit">%</span></div>
                                <span class="kpi-delta" id="deals-max-discount-delta" style="background: rgba(139, 38, 53, 0.1); color: var(--danger);">최대 할인</span>
                                <div class="kpi-tooltip">
                                    <div class="tooltip-header">🔥 최대 할인율</div>
                                    <div class="tooltip-content">
                                        <p><strong>정의</strong><br>경쟁사 딜 중 가장 높은 할인율</p>
                                        <p><strong>주의</strong><br>30% 이상 할인은 가격 경쟁 심화 신호</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="content-grid">
                            <!-- 경쟁사 딜 테이블 -->
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title">
                                        <div class="card-title-icon" style="background: #ef4444;"><i data-lucide="flame" style="color: white; width: 16px; height: 16px;"></i></div>
                                        실시간 경쟁사 Deals
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <select class="selector-dropdown" id="dealsFilterBrand" onchange="filterDealsTable()">
                                            <option value="">전체 브랜드</option>
                                            <option value="e.l.f.">e.l.f.</option>
                                            <option value="Maybelline">Maybelline</option>
                                            <option value="L'Oreal">L'Oreal</option>
                                            <option value="NYX">NYX</option>
                                            <option value="CeraVe">CeraVe</option>
                                            <option value="COSRX">COSRX</option>
                                        </select>
                                        <button class="apply-btn" onclick="refreshDealsData()">🔄 새로고침</button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="promo-table-container" style="max-height: 400px;">
                                        <table class="promo-table" id="deals-table">
                                            <thead>
                                                <tr>
                                                    <th>브랜드</th>
                                                    <th>제품명</th>
                                                    <th>딜 타입</th>
                                                    <th>할인율</th>
                                                    <th>딜 가격</th>
                                                    <th>남은 시간</th>
                                                    <th>판매율</th>
                                                </tr>
                                            </thead>
                                            <tbody id="deals-tbody">
                                                <tr><td colspan="7" style="text-align: center; color: var(--text-secondary); padding: 40px;">
                                                    <i data-lucide="loader" style="width: 24px; height: 24px; opacity: 0.5;"></i><br><br>
                                                    Deals 데이터 로딩 중...<br>
                                                    <small>새로고침 버튼을 눌러 최신 데이터를 가져오세요</small>
                                                </td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- 브랜드별 딜 현황 -->
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title has-tooltip">
                                        <div class="card-title-icon"><i data-lucide="bar-chart-3" style="color: white; width: 16px; height: 16px;"></i></div>
                                        브랜드별 딜 현황 (7일)
                                        <i data-lucide="help-circle" class="help-icon" style="width: 14px; height: 14px; margin-left: 6px; opacity: 0.6;"></i>
                                        <div class="chart-title-tooltip">
                                            <div class="tooltip-header">📊 브랜드별 딜 현황</div>
                                            <div class="tooltip-content">
                                                <p><strong>차트 설명</strong><br>최근 7일간 경쟁 브랜드별 딜(할인/프로모션) 수를 비교합니다.</p>
                                                <p><strong>활용법</strong><br>• 어떤 브랜드가 가격 경쟁에 적극적인지 파악<br>• 경쟁사 할인 전략 모니터링<br>• LANEIGE 대응 전략 수립</p>
                                                <p><strong>딜 유형</strong><br>Lightning Deal, Coupon, Subscribe & Save 등 포함</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container"><canvas id="dealsByBrandChart"></canvas></div>
                                </div>
                            </div>
                        </div>

                        <!-- 딜 트렌드 차트 -->
                        <div class="content-grid single">
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title has-tooltip">
                                        <div class="card-title-icon"><i data-lucide="trending-up" style="color: white; width: 16px; height: 16px;"></i></div>
                                        일별 Deals 추이
                                        <i data-lucide="help-circle" class="help-icon" style="width: 14px; height: 14px; margin-left: 6px; opacity: 0.6;"></i>
                                        <div class="chart-title-tooltip">
                                            <div class="tooltip-header">📈 일별 Deals 추이</div>
                                            <div class="tooltip-content">
                                                <p><strong>차트 설명</strong><br>시간에 따른 경쟁사 딜 수와 평균 할인율 변화를 추적합니다.</p>
                                                <p><strong>주요 지표</strong><br>• 딜 수 (좌측 Y축): 하루 동안 활성화된 총 딜 개수<br>• 평균 할인율 (우측 Y축): 모든 딜의 평균 할인 비율</p>
                                                <p><strong>해석 가이드</strong><br>• 딜 수 급증 → LANEIGE 순위 변동 가능성 증가<br>• ⚡ Lightning Deal 증가 시 즉시 대응 필요<br>• 할인율 상승 → 가격 경쟁 심화</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="chart-date-range">
                                        <label>기간:</label>
                                        <select id="dealsTrendPeriod" onchange="updateDealsTrendChart()">
                                            <option value="7">최근 7일</option>
                                            <option value="14">최근 14일</option>
                                            <option value="30">최근 30일</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container"><canvas id="dealsTrendChart"></canvas></div>
                                    <div class="chart-guide">
                                        <strong>해석:</strong> 경쟁사 딜 수가 증가하면 LANEIGE 순위 변동 가능성 증가 | ⚡ Lightning Deal 급증 시 주의
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 알림 목록 -->
                        <div class="content-grid single">
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title has-tooltip">
                                        <div class="card-title-icon" style="background: #f59e0b;"><i data-lucide="bell" style="color: white; width: 16px; height: 16px;"></i></div>
                                        경쟁사 할인 알림
                                        <i data-lucide="help-circle" class="help-icon" style="width: 14px; height: 14px; margin-left: 6px; opacity: 0.6;"></i>
                                        <div class="chart-title-tooltip">
                                            <div class="tooltip-header">🔔 알림 기능 설명</div>
                                            <div class="tooltip-content">
                                                <p><strong>자동 감지 조건</strong><br>• 할인율 30% 이상 신규 딜 발생<br>• ⚡ Lightning Deal 새로 등록<br>• 경쟁 제품 순위 급상승 (10위 이상 상승)</p>
                                                <p><strong>알림 발송</strong><br>• 📤 알림 발송 버튼으로 이메일/Slack 전송<br>• 🧪 테스트 버튼으로 알림 시스템 점검</p>
                                                <p><strong>활용법</strong><br>실시간 경쟁 상황 모니터링으로 빠른 대응 전략 수립</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <span class="card-badge" id="alerts-count-badge" style="background: rgba(31, 87, 149, 0.1); color: var(--amore-blue);">0개의 새 알림</span>
                                        <button class="apply-btn" onclick="sendPendingAlerts()">📤 알림 발송</button>
                                        <button class="apply-btn" onclick="testAlertService()" style="background: var(--amore-blue);">🧪 테스트</button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="alert-service-status" style="padding: 8px 12px; background: var(--bg-subtle); border-radius: 6px; margin-bottom: 12px; font-size: 13px; display: none;">
                                        <span id="alert-status-text">알림 서비스 상태를 확인 중...</span>
                                    </div>
                                    <div id="deals-alerts-list" style="max-height: 200px; overflow-y: auto;">
                                        <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                                            아직 알림이 없습니다. 경쟁사가 큰 할인을 시작하면 알림이 표시됩니다.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>

                <!-- CHATBOT -->
                <aside class="chatbot-panel" id="chatbotPanel">
                    <!-- 드래그 핸들 (크기 조절용) -->
                    <div class="chat-resize-handle" id="chatResizeHandle"></div>

                    <div class="chat-header">
                        <div class="chat-header-top"><h3><i data-lucide="bot" style="width: 20px; height: 20px;"></i>AI Insight Agent</h3><button class="chat-close" onclick="toggleChatbot()"><i data-lucide="x" style="width: 18px; height: 18px;"></i></button></div>
                        <div class="chat-subtitle">Laneige 브랜드 맞춤 인사이트</div>
                    </div>
                    <div class="chat-body" id="chatBody">
                        <div class="chat-message bot"><div class="bubble">안녕하세요!<br><br>오늘 <strong>Laneige Lip Sleeping Mask</strong>가 2위로 상승했습니다. 경쟁사 대비 가격 경쟁력이 좋은 상황이에요.<br><br>궁금한 점을 물어보세요!</div></div>
                    </div>
                    <div class="chat-suggestions" id="chatSuggestions">
                        <div class="suggestions-header" onclick="toggleSuggestions()">
                            <div class="suggestions-label">추천 질문</div>
                            <div class="suggestions-toggle"><i data-lucide="chevron-down" style="width: 14px; height: 14px;"></i></div>
                        </div>
                        <div class="suggestion-chips">
                            <div class="suggestion-chip" onclick="sendChatMessage('Lip Sleeping Mask 상승 원인 분석해줘')">Lip Mask 상승 원인</div>
                            <div class="suggestion-chip" onclick="sendChatMessage('Water Bank Cream 평점 하락 대응 전략은?')">Water Bank 평점 대응</div>
                            <div class="suggestion-chip" onclick="sendChatMessage('오늘 가장 시급한 액션은?')">시급한 액션</div>
                        </div>
                    </div>
                    <div class="chat-input-area">
                        <input type="text" class="chat-input" id="chatInput" placeholder="질문을 입력하세요..." onkeypress="handleChatKeypress(event)">
                        <button class="chat-send" onclick="sendChatFromInput()"><i data-lucide="send" style="width: 18px; height: 18px;"></i></button>
                    </div>
                </aside>
            </div>
        </div>

        <div class="chat-fab" id="chatFab" onclick="toggleChatbot()"><i data-lucide="message-square" style="color: white; width: 28px; height: 28px;"></i></div>

        <!-- AI DRAWER -->
        <div class="ai-drawer" id="aiDrawer">
            <div class="drawer-header">
                <div class="drawer-header-left"><div class="drawer-icon"><i data-lucide="brain" style="color: white; width: 24px; height: 24px;"></i></div><div><h3>AI Strategy Report</h3><p>Laneige Amazon US Analysis</p></div></div>
                <button class="drawer-close" onclick="closeAIDrawer()"><i data-lucide="x" style="width: 20px; height: 20px;"></i></button>
            </div>
            <div class="drawer-content">
                <div class="insight-section">
                    <div class="insight-section-header"><i data-lucide="chart-bar" style="width: 16px; height: 16px; color: var(--amore-primary);"></i><h4>Strategy Summary</h4></div>
                    <div class="insight-box"><strong>Laneige</strong> 브랜드는 Amazon US Lip Care 카테고리에서 <em>"Price-Quality Leader"</em> 포지션을 확보하고 있습니다.<br><br>현재 Lip Sleeping Mask의 가격 경쟁력과 높은 평점(4.5)을 활용한 <strong>SKU 확장 전략</strong>이 권장됩니다.</div>
                </div>
                <div class="insight-section">
                    <div class="insight-section-header"><i data-lucide="git-branch" style="width: 16px; height: 16px; color: var(--amore-secondary);"></i><h4>Inference Path</h4></div>
                    <div class="inference-path"><div class="path-node highlight">Laneige</div><i data-lucide="arrow-right" style="width: 16px; height: 16px; color: var(--text-secondary);"></i><div class="path-node">Top2 Position</div><i data-lucide="arrow-right" style="width: 16px; height: 16px; color: var(--text-secondary);"></i><div class="path-node highlight">SKU Expansion</div></div>
                </div>
                <div class="insight-section">
                    <div class="insight-section-header"><i data-lucide="target" style="width: 16px; height: 16px; color: var(--amore-warning);"></i><h4>Recommended Actions</h4></div>
                    <div class="insight-box">1️⃣ Lip Sleeping Mask 신규 플레이버(Mango, Vanilla) 출시 검토<br>2️⃣ Water Bank Cream 리뷰 분석 → 부정 키워드 대응<br>3️⃣ 번들 프로모션으로 객단가 상승 유도</div>
                </div>
            </div>
            <div class="drawer-actions">
                <button class="drawer-btn secondary" onclick="copyStrategyReport()"><i data-lucide="copy" style="width: 16px; height: 16px;"></i>복사</button>
                <button class="drawer-btn primary" onclick="shareStrategyReport()"><i data-lucide="mail" style="width: 16px; height: 16px;"></i>공유</button>
            </div>
        </div>

        <!-- EXPORT MODAL -->
        <div class="modal-overlay" id="exportModal">
            <div class="modal-content">
                <div class="modal-header"><div class="modal-icon"><i data-lucide="file-spreadsheet" style="color: white; width: 26px; height: 26px;"></i></div><div><h3>데이터 내보내기</h3><p>Amazon US 데이터 추출</p></div></div>
                <div class="form-group"><label class="form-label">내보내기 형식</label>
                    <div style="display: flex; gap: 12px; margin-top: 8px;">
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 10px 16px; border: 2px solid var(--border-light); border-radius: 8px; transition: all 0.15s;">
                            <input type="radio" name="exportFormat" value="docx" checked style="accent-color: var(--amore-blue);">
                            <span>📄 DOCX (인사이트 리포트)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 10px 16px; border: 2px solid var(--border-light); border-radius: 8px; transition: all 0.15s;">
                            <input type="radio" name="exportFormat" value="excel" style="accent-color: var(--amore-blue);">
                            <span>📊 Excel (원본 데이터)</span>
                        </label>
                    </div>
                </div>
                <div class="form-group"><label class="form-label">분석 기간</label><div class="date-inputs"><input type="date" class="date-input" id="exportStartDate"><input type="date" class="date-input" id="exportEndDate"></div></div>
                <div class="form-group"><label class="form-label">대상 플랫폼</label><div class="platform-fixed">🇺🇸 Amazon US (고정)</div></div>
                <div class="modal-actions"><button class="modal-btn cancel" onclick="closeExportModal()">취소</button><button class="modal-btn confirm" onclick="executeExport()">📥 다운로드</button></div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        let currentPage = 'home', chatbotOpen = false, charts = {};

        // Dashboard Data (loaded from JSON)
        let dashboardData = null;

        // Default Product Data (fallback)
        let productData = {
            'lip-mask-berry': { rank: '#2', rankDelta: '▲ 1위 상승', vol: '12', volDelta: '안정적', rating: '4.5', ratingDelta: '상위 10%', stick: '92', stickDelta: '고착화 높음' },
            'lip-mask-original': { rank: '#5', rankDelta: '유지', vol: '8', volDelta: '매우 안정', rating: '4.4', ratingDelta: '양호', stick: '88', stickDelta: '높음' },
            'lip-glowy': { rank: '#12', rankDelta: '▼ 2위 하락', vol: '22', volDelta: '변동성 높음', rating: '4.2', ratingDelta: '평균', stick: '65', stickDelta: '중간' }
        };

        let categoryProducts = {
            'beauty': [['lip-mask-berry', 'Lip Sleeping Mask (Berry)'], ['water-bank', 'Water Bank Blue Cream']],
            'skin_care': [['water-bank', 'Water Bank Blue Cream'], ['cream-skin', 'Cream Skin Toner']],
            'lip_care': [['lip-mask-berry', 'Lip Sleeping Mask (Berry)'], ['lip-mask-original', 'Lip Sleeping Mask (Original)'], ['lip-glowy', 'Lip Glowy Balm']],
            'lip_makeup': [['lip-glowy', 'Lip Glowy Balm'], ['lip-tint', 'Lip Tint']],
            'face_powder': [['neo-cushion', 'Neo Cushion'], ['skin-veil', 'Skin Veil Base']]
        };

        // 크롤링 상태 관리
        let crawlStatusInterval = null;
        let lastDataDate = null;  // 마지막 데이터 날짜 추적

        // 토스트 알림 표시
        function showToast(message, type = 'info') {
            // 기존 토스트 제거
            const existing = document.getElementById('toast-notification');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.id = 'toast-notification';
            toast.style.cssText = `
                position: fixed; bottom: 24px; right: 24px; z-index: 10000;
                padding: 16px 24px; border-radius: 12px;
                font-size: 14px; font-weight: 500;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                animation: slideIn 0.3s ease;
                display: flex; align-items: center; gap: 10px;
                ${type === 'success'
                    ? 'background: linear-gradient(135deg, #10b981, #059669); color: white;'
                    : type === 'error'
                    ? 'background: linear-gradient(135deg, #ef4444, #dc2626); color: white;'
                    : 'background: linear-gradient(135deg, #3b82f6, #2563eb); color: white;'}
            `;
            toast.innerHTML = `
                <span>${type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️'}</span>
                <span>${message}</span>
            `;
            document.body.appendChild(toast);

            // 5초 후 제거
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // 크롤링 상태 체크 및 UI 업데이트
        async function checkCrawlStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/crawl/status`);
                if (!response.ok) return;

                const data = await response.json();
                const statusEl = document.getElementById('crawl-status');
                const textEl = statusEl?.querySelector('.crawl-text');

                if (!statusEl) return;

                if (data.status === 'running') {
                    statusEl.style.display = 'flex';
                    statusEl.className = 'crawl-status running';
                    textEl.textContent = `수집 중... ${data.progress}%`;
                } else if (data.status === 'completed' && data.date === new Date().toISOString().split('T')[0]) {
                    statusEl.style.display = 'flex';
                    statusEl.className = 'crawl-status completed';
                    textEl.textContent = '오늘 데이터 수집 완료';

                    // 데이터 날짜가 변경됐으면 새로고침
                    if (lastDataDate !== data.date) {
                        showToast('📊 새 데이터 수집 완료! 모든 차트가 최신 데이터로 업데이트됩니다.', 'success');
                        await refreshDashboardData();
                        lastDataDate = data.date;

                        // 데이터 시간 표시 업데이트
                        updateDataTime();
                    }

                    // 5초 후 숨김
                    setTimeout(() => { statusEl.style.display = 'none'; }, 5000);
                } else if (data.status === 'failed') {
                    statusEl.style.display = 'flex';
                    statusEl.className = 'crawl-status failed';
                    textEl.textContent = '수집 실패';
                    showToast('데이터 수집에 실패했습니다.', 'error');
                    setTimeout(() => { statusEl.style.display = 'none'; }, 5000);
                } else {
                    statusEl.style.display = 'none';
                }

                // 진행 중이 아니면 폴링 중단
                if (data.status !== 'running' && crawlStatusInterval) {
                    clearInterval(crawlStatusInterval);
                    crawlStatusInterval = null;
                }
            } catch (error) {
                console.warn('Failed to check crawl status:', error);
            }
        }

        // 크롤링 상태 폴링 시작
        function startCrawlStatusPolling() {
            if (crawlStatusInterval) return;
            crawlStatusInterval = setInterval(checkCrawlStatus, 3000);
            checkCrawlStatus(); // 즉시 한 번 체크
        }

        // 대시보드 데이터 새로고침 (API에서 로드)
        async function refreshDashboardData() {
            try {
                // API에서 최신 데이터 가져오기
                const response = await fetch(`${API_BASE}/api/data`);
                if (!response.ok) {
                    console.warn('API data not available, falling back to JSON file');
                    return await loadDashboardData();
                }

                dashboardData = await response.json();
                window.dashboardData = dashboardData;  // 전역으로 접근 가능하게
                console.log('Dashboard data refreshed from API:', dashboardData.metadata);

                // UI 업데이트 (애니메이션 효과)
                highlightUpdatedElements();
                updateDashboardFromData();
                initChartsForPage(currentPage);

                return true;
            } catch (error) {
                console.warn('Failed to refresh from API:', error);
                return await loadDashboardData();
            }
        }

        // 업데이트된 요소 하이라이트 효과
        function highlightUpdatedElements() {
            const elements = document.querySelectorAll('.kpi-value, .insight-message, .metric-card');
            elements.forEach(el => {
                el.style.transition = 'background-color 0.5s ease';
                el.style.backgroundColor = 'rgba(16, 185, 129, 0.2)';
                setTimeout(() => {
                    el.style.backgroundColor = '';
                }, 2000);
            });

            // 차트 컨테이너도 하이라이트
            const chartContainers = document.querySelectorAll('.chart-container, canvas');
            chartContainers.forEach(el => {
                el.style.transition = 'box-shadow 0.5s ease';
                el.style.boxShadow = '0 0 20px rgba(16, 185, 129, 0.4)';
                setTimeout(() => {
                    el.style.boxShadow = '';
                }, 2000);
            });
        }

        // Loading State Management
        function showLoading(show = true, message = '데이터를 불러오는 중...') {
            const overlay = document.getElementById('loadingOverlay');
            const textEl = overlay?.querySelector('.loading-text');
            if (overlay) {
                if (show) {
                    overlay.classList.add('show');
                    if (textEl) textEl.textContent = message;
                } else {
                    overlay.classList.remove('show');
                }
            }
        }

        function hideLoading() { showLoading(false); }

        // Load Dashboard Data (API 우선, JSON fallback)
        async function loadDashboardData() {
            showLoading(true, '대시보드 데이터 로딩 중...');
            try {
                // 1. 먼저 API에서 시도
                let response = await fetch(`${API_BASE}/api/data`);

                // API 실패 시 JSON 파일로 폴백
                if (!response.ok) {
                    console.warn('API not available, trying JSON file');
                    response = await fetch('../data/dashboard_data.json');
                }

                if (!response.ok) {
                    console.warn('Dashboard data not found');
                    return false;
                }

                dashboardData = await response.json();
                window.dashboardData = dashboardData;  // 전역으로 접근 가능하게
                console.log('Dashboard data loaded:', dashboardData.metadata);

                // 마지막 데이터 날짜 저장 (새로고침 감지용)
                lastDataDate = dashboardData.metadata?.data_date;

                // Update UI with loaded data
                updateDashboardFromData();

                // 오늘 데이터가 아니면 크롤링 상태 체크 시작
                const dataDate = dashboardData.metadata?.data_date;
                const today = new Date().toISOString().split('T')[0];
                if (dataDate !== today) {
                    startCrawlStatusPolling();
                }

                hideLoading();
                return true;
            } catch (error) {
                console.warn('Failed to load dashboard data:', error);
                hideLoading();
                // 데이터 로드 실패 시 현재 날짜 표시
                const dateDisplay = document.getElementById('date-display');
                if (dateDisplay) {
                    dateDisplay.textContent = '📅 ' + new Date().toISOString().split('T')[0];
                }
                showToast('데이터 로드에 실패했습니다. 페이지를 새로고침해주세요.', 'error');
                return false;
            }
        }

        // Update Dashboard UI from loaded data
        function updateDashboardFromData() {
            if (!dashboardData) return;

            // Update date display - 데이터 날짜 또는 현재 날짜 표시
            const dateDisplay = document.getElementById('date-display');
            if (dateDisplay) {
                const dataDate = dashboardData.metadata?.data_date;
                const today = new Date().toISOString().split('T')[0];
                dateDisplay.textContent = '📅 ' + (dataDate || today);
            }

            // Update Home page insight
            if (dashboardData.home?.insight_message) {
                const insightEl = document.querySelector('.insight-message');
                if (insightEl) insightEl.innerHTML = dashboardData.home.insight_message;
            }

            // Update status cards
            if (dashboardData.home?.status) {
                const status = dashboardData.home.status;
                const statusCards = document.querySelectorAll('.status-card');
                if (statusCards[0]) {
                    statusCards[0].querySelector('.status-value span').textContent = status.exposure || 'Stable';
                }
                if (statusCards[1]) {
                    statusCards[1].querySelector('.status-value span').textContent = status.position || 'Top 5';
                }
                if (statusCards[2]) {
                    statusCards[2].querySelector('.status-value span').textContent = (status.warning_count || 0) + '개';
                }
            }

            // Update action items
            if (dashboardData.home?.action_items) {
                updateActionTable(dashboardData.home.action_items);
            }

            // Update exposure status tooltip
            updateExposureStatusTooltip(dashboardData.home, dashboardData.home?.action_items);

            // 경쟁사 드롭다운 동적 생성
            populateCompetitorDropdown();

            // Update Brand KPIs
            if (dashboardData.brand?.kpis) {
                const kpis = dashboardData.brand.kpis;
                const kpiCards = document.querySelectorAll('#page-brand .kpi-card');
                if (kpiCards[0]) kpiCards[0].querySelector('.kpi-value').innerHTML = kpis.sos + '<span class="unit">%</span>';
                if (kpiCards[1]) kpiCards[1].querySelector('.kpi-value').innerHTML = kpis.top10_count + '<span class="unit">개</span>';
                if (kpiCards[2]) kpiCards[2].querySelector('.kpi-value').innerHTML = kpis.avg_rank + '<span class="unit">위</span>';
                if (kpiCards[3]) kpiCards[3].querySelector('.kpi-value').textContent = kpis.hhi;
            }

            // Update Competitor Table
            if (dashboardData.brand?.competitors) {
                updateCompetitorTable(dashboardData.brand.competitors);
            }

            // Update product data from loaded data
            if (dashboardData.products) {
                productData = {};
                categoryProducts = {
                    'beauty': [],
                    'skin_care': [],
                    'lip_care': [],
                    'lip_makeup': [],
                    'face_powder': []
                };

                for (const [asin, product] of Object.entries(dashboardData.products)) {
                    const key = asin.toLowerCase().replace(/[^a-z0-9]/g, '-');
                    productData[key] = {
                        rank: '#' + product.rank,
                        rankDelta: product.rank_delta,
                        vol: String(product.volatility),
                        volDelta: product.volatility_status,
                        rating: String(product.rating),
                        ratingDelta: product.rating_delta,
                        stick: '85',
                        stickDelta: '높음'
                    };

                    // Add to category (매핑: thresholds.json 카테고리 키)
                    const cat = product.category || 'lip_care';
                    let catKey = 'beauty';
                    if (cat.includes('lip_care') || cat === 'lip') catKey = 'lip_care';
                    else if (cat.includes('lip_makeup')) catKey = 'lip_makeup';
                    else if (cat.includes('skin_care') || cat === 'skin') catKey = 'skin_care';
                    else if (cat.includes('face_powder') || cat === 'face') catKey = 'face_powder';
                    else catKey = 'beauty';

                    if (categoryProducts[catKey]) {
                        categoryProducts[catKey].push([key, product.name]);
                    }
                    // Also add to beauty (top level) for visibility
                    if (catKey !== 'beauty' && categoryProducts['beauty']) {
                        categoryProducts['beauty'].push([key, product.name]);
                    }
                }
            }

            console.log('Dashboard UI updated from data');

            // Initialize date range pickers
            initDateRangePickers();
        }

        // ============== DATE RANGE PICKER FUNCTIONS ==============

        // ===== 글로벌 날짜 범위 상태 관리 =====
        const globalDateRange = {
            startDate: null,
            endDate: null,
            availableDateRange: null,  // API에서 받은 사용 가능한 날짜 범위

            // 초기화: localStorage에서 복원 또는 기본값 설정
            init() {
                const saved = localStorage.getItem('dashboardDateRange');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        this.startDate = parsed.startDate;
                        this.endDate = parsed.endDate;
                        console.log('[GlobalDateRange] Restored from localStorage:', this.startDate, '~', this.endDate);
                    } catch (e) {
                        console.warn('[GlobalDateRange] Failed to parse localStorage, using defaults');
                        this.setDefaultRange();
                    }
                } else {
                    this.setDefaultRange();
                }
            },

            // 기본값 설정: dashboardData에서 사용 가능한 날짜 범위 추출
            setDefaultRange() {
                // API 메타데이터에서 날짜 범위 가져오기 시도
                if (dashboardData?.metadata?.available_date_range) {
                    const range = dashboardData.metadata.available_date_range;
                    this.startDate = range.min;
                    this.endDate = range.max;
                    console.log('[GlobalDateRange] Default from metadata:', this.startDate, '~', this.endDate);
                } else if (dashboardData?.charts?.sos_trend?.["30d"]?.labels) {
                    // 폴백: SoS 트렌드 30일 데이터에서 추출
                    const labels = dashboardData.charts.sos_trend["30d"].labels;
                    this.startDate = labels[0];
                    this.endDate = labels[labels.length - 1];
                    console.log('[GlobalDateRange] Default from sos_trend:', this.startDate, '~', this.endDate);
                } else {
                    // 최후 폴백: 최근 30일
                    const end = new Date();
                    const start = new Date();
                    start.setDate(start.getDate() - 30);
                    this.startDate = start.toISOString().split('T')[0];
                    this.endDate = end.toISOString().split('T')[0];
                    console.log('[GlobalDateRange] Default fallback (30 days):', this.startDate, '~', this.endDate);
                }
            },

            // 날짜 범위 설정 및 저장
            set(start, end) {
                // 유효성 검사
                if (new Date(start) > new Date(end)) {
                    console.warn('[GlobalDateRange] Invalid range: start > end');
                    return false;
                }

                this.startDate = start;
                this.endDate = end;

                // localStorage에 저장
                localStorage.setItem('dashboardDateRange', JSON.stringify({
                    startDate: start,
                    endDate: end,
                    savedAt: new Date().toISOString()
                }));

                console.log('[GlobalDateRange] Set:', start, '~', end);

                // 모든 차트에 날짜 변경 이벤트 발송
                this.notifyCharts();
                return true;
            },

            // 모든 차트에 날짜 변경 이벤트 발송
            notifyCharts() {
                console.log('[GlobalDateRange] Dispatching dateRangeChanged event');
                document.dispatchEvent(new CustomEvent('dateRangeChanged', {
                    detail: {
                        startDate: this.startDate,
                        endDate: this.endDate
                    }
                }));
            },

            // 날짜 범위 가져오기
            get() {
                return {
                    startDate: this.startDate,
                    endDate: this.endDate
                };
            },

            // 일수 계산
            getDays() {
                if (!this.startDate || !this.endDate) return 30;
                const start = new Date(this.startDate);
                const end = new Date(this.endDate);
                return Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            }
        };

        // Date range state (기존 호환성 유지)
        let chartDateRanges = {
            brandMatrix: { startDate: null, endDate: null, availableDates: [] }
        };

        // Initialize date range pickers with current data
        function initDateRangePickers() {
            // 글로벌 날짜 범위 초기화
            globalDateRange.init();

            const startDate = globalDateRange.startDate;
            const endDate = globalDateRange.endDate;

            console.log('[initDateRangePickers] Using global date range:', startDate, '~', endDate);

            // Brand Matrix chart date picker
            const brandMatrixStart = document.getElementById('brandMatrixStartDate');
            const brandMatrixEnd = document.getElementById('brandMatrixEndDate');

            if (brandMatrixStart && brandMatrixEnd) {
                // 글로벌 날짜 범위 적용
                brandMatrixStart.value = startDate;
                brandMatrixEnd.value = endDate;

                // Store initial range
                chartDateRanges.brandMatrix.startDate = startDate;
                chartDateRanges.brandMatrix.endDate = endDate;

                // Update tooltip with period info
                updateChartPeriodTooltip('brandMatrix', startDate, endDate);
            }

            // 모든 날짜 입력창에 글로벌 날짜 범위 동기화
            syncAllDateInputsToGlobal();
        }

        // 모든 날짜 입력창을 글로벌 날짜 범위와 동기화
        function syncAllDateInputsToGlobal() {
            const { startDate, endDate } = globalDateRange.get();

            // 동기화할 날짜 입력창 ID 목록
            const dateInputPairs = [
                ['sosTrendStartDate', 'sosTrendEndDate'],
                ['cpiStartDate', 'cpiEndDate'],
                ['categoryStartDate', 'categoryEndDate'],
                ['productStartDate', 'productEndDate'],
                ['rankTrendStartDate', 'rankTrendEndDate'],
                ['matrixStartDate', 'matrixEndDate'],
                ['discountStartDate', 'discountEndDate'],
                ['growthTypeStartDate', 'growthTypeEndDate'],
                ['competitorPromoStartDate', 'competitorPromoEndDate'],
                ['sosStartDate', 'sosEndDate']
            ];

            dateInputPairs.forEach(([startId, endId]) => {
                const startInput = document.getElementById(startId);
                const endInput = document.getElementById(endId);

                if (startInput && endInput) {
                    startInput.value = startDate;
                    endInput.value = endDate;
                }
            });

            console.log('[syncAllDateInputsToGlobal] Synced all date inputs to:', startDate, '~', endDate);
        }

        // Update chart tooltip with period info
        function updateChartPeriodTooltip(chartId, startDate, endDate, missingDates = []) {
            const periodInfoEl = document.getElementById(`${chartId}PeriodInfo`);
            if (periodInfoEl) {
                let periodText = `📅 분석 기간: ${startDate} ~ ${endDate}`;
                if (missingDates.length > 0) {
                    periodText += `<br>⚠️ 데이터 없는 날짜: ${missingDates.length}일`;
                }
                periodInfoEl.innerHTML = periodText;
            }
        }

        // Apply date range for Brand Matrix chart (글로벌 상태 업데이트 포함)
        async function applyBrandMatrixDateRange() {
            const startDate = document.getElementById('brandMatrixStartDate').value;
            const endDate = document.getElementById('brandMatrixEndDate').value;

            console.log('[DateRange] applyBrandMatrixDateRange called:', { startDate, endDate });

            if (!startDate || !endDate) {
                showToast('시작일과 종료일을 모두 선택해주세요.', 'error');
                return;
            }

            if (startDate > endDate) {
                showToast('시작일은 종료일보다 이전이어야 합니다.', 'error');
                return;
            }

            // 글로벌 날짜 범위 업데이트 (모든 차트 자동 업데이트)
            globalDateRange.set(startDate, endDate);
            return;

            // 아래 코드는 이제 globalDateRange.set() 호출 시 dateRangeChanged 이벤트로 처리됨
            showToast('데이터 로딩 중...', 'info');

            try {
                // Fetch historical data for the selected range
                const url = `${API_BASE}/api/historical?start_date=${startDate}&end_date=${endDate}`;
                console.log('[DateRange] Fetching:', url);

                const response = await fetch(url);
                console.log('[DateRange] Response status:', response.status);

                if (!response.ok) {
                    throw new Error(`Historical data fetch failed: ${response.status}`);
                }

                const histData = await response.json();
                console.log('[DateRange] Response data:', {
                    success: histData.success,
                    available_dates: histData.available_dates?.length,
                    brand_metrics: histData.brand_metrics?.length,
                    available_date_range: histData.available_date_range,
                    data_source: histData.data_source
                });

                // Find missing dates in the range
                const missingDates = findMissingDates(startDate, endDate, histData.available_dates || []);
                console.log('[DateRange] Missing dates:', missingDates.length);

                // Update chart date range state
                if (typeof chartDateRanges !== 'undefined' && chartDateRanges.brandMatrix) {
                    chartDateRanges.brandMatrix.startDate = startDate;
                    chartDateRanges.brandMatrix.endDate = endDate;
                    chartDateRanges.brandMatrix.availableDates = histData.available_dates || [];
                    chartDateRanges.brandMatrix.availableDateRange = histData.available_date_range || {};
                }

                // Update tooltip with period info
                updateChartPeriodTooltip('brandMatrix', startDate, endDate, missingDates);

                // Show data gap warning if there are missing dates (with available range hint)
                showDataGapWarning('brandMatrix', missingDates, histData.available_date_range);

                // Update the chart with new data
                if (histData.brand_metrics && histData.brand_metrics.length > 0) {
                    updateBrandMatrixChart(histData.brand_metrics);
                    const sourceInfo = histData.data_source ? ` (${histData.data_source})` : '';
                    showToast(`${startDate} ~ ${endDate} 기간 데이터 적용됨 (${histData.brand_metrics.length}개 브랜드)${sourceInfo}`, 'success');
                } else {
                    const rangeHint = histData.available_date_range?.min && histData.available_date_range?.max
                        ? ` (사용 가능: ${histData.available_date_range.min} ~ ${histData.available_date_range.max})`
                        : '';
                    showToast(`해당 기간에 브랜드 데이터가 없습니다.${rangeHint}`, 'warning');
                }

            } catch (error) {
                console.error('[DateRange] Error:', error);
                showToast('데이터를 불러오는데 실패했습니다: ' + error.message, 'error');
            }
        }

        // Find missing dates in a range
        function findMissingDates(startDate, endDate, availableDates) {
            const missing = [];
            const start = new Date(startDate);
            const end = new Date(endDate);
            const availableSet = new Set(availableDates);

            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];
                if (!availableSet.has(dateStr)) {
                    missing.push(dateStr);
                }
            }

            return missing;
        }

        // Show data gap warning
        function showDataGapWarning(chartId, missingDates, availableDateRange = null) {
            const warningEl = document.getElementById(`${chartId}DataGap`);
            const textEl = document.getElementById(`${chartId}DataGapText`);

            if (!warningEl || !textEl) return;

            if (missingDates.length === 0) {
                warningEl.style.display = 'none';
                return;
            }

            // Group consecutive missing dates into ranges
            const ranges = groupConsecutiveDates(missingDates);
            let warningText = '';

            if (ranges.length === 1 && ranges[0].start === ranges[0].end) {
                warningText = `${ranges[0].start}: 데이터 없음`;
            } else if (ranges.length === 1) {
                warningText = `${ranges[0].start} ~ ${ranges[0].end}: 데이터 없음`;
            } else {
                const rangeStrs = ranges.slice(0, 3).map(r =>
                    r.start === r.end ? r.start : `${r.start}~${r.end}`
                );
                warningText = `데이터 없는 기간: ${rangeStrs.join(', ')}`;
                if (ranges.length > 3) {
                    warningText += ` 외 ${ranges.length - 3}개 구간`;
                }
            }

            // Add available date range hint if provided
            if (availableDateRange && availableDateRange.min && availableDateRange.max) {
                warningText += ` (사용 가능: ${availableDateRange.min} ~ ${availableDateRange.max})`;
            }

            textEl.textContent = warningText;
            warningEl.style.display = 'flex';

            // Refresh lucide icons for the warning icon
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // Group consecutive dates into ranges
        function groupConsecutiveDates(dates) {
            if (dates.length === 0) return [];

            const sorted = dates.sort();
            const ranges = [];
            let rangeStart = sorted[0];
            let rangeEnd = sorted[0];

            for (let i = 1; i < sorted.length; i++) {
                const prevDate = new Date(rangeEnd);
                const currDate = new Date(sorted[i]);
                const diffDays = (currDate - prevDate) / (1000 * 60 * 60 * 24);

                if (diffDays === 1) {
                    rangeEnd = sorted[i];
                } else {
                    ranges.push({ start: rangeStart, end: rangeEnd });
                    rangeStart = sorted[i];
                    rangeEnd = sorted[i];
                }
            }

            ranges.push({ start: rangeStart, end: rangeEnd });
            return ranges;
        }

        // Update Brand Matrix chart with new data
        function updateBrandMatrixChart(brandMetrics) {
            console.log('[DateRange] updateBrandMatrixChart called', {
                hasChart: !!charts.brandMatrix,
                metricsCount: brandMetrics?.length
            });

            if (!brandMetrics || brandMetrics.length === 0) {
                console.warn('[DateRange] No brand metrics data');
                return;
            }

            // 차트가 아직 초기화되지 않았으면 Brand 페이지로 이동 필요
            if (!charts.brandMatrix) {
                console.warn('[DateRange] brandMatrix chart not initialized - may need to be on Brand page');
                showToast('Brand 페이지에서 차트를 확인하세요.', 'info');
                return;
            }

            const colors = {
                laneige: '#1F5795',
                competitor: '#7D7D7D'
            };
            const brandColors = ['#1F5795', '#001C58', '#7D7D7D', '#4A7DB8', '#A0A0A0', '#2E4A6E', '#5C5C5C', '#3D6B99', '#8B8B8B', '#1A3D66'];

            // Convert metrics to chart datasets
            const brandDatasets = brandMetrics.map((brand, idx) => ({
                label: brand.brand,
                data: [{ x: brand.sos, y: brand.avg_rank, r: brand.bubble_size || Math.max(5, brand.product_count * 2) }],
                backgroundColor: brand.is_laneige ? colors.laneige : brandColors[idx % brandColors.length]
            }));

            console.log('[DateRange] Updating chart with', brandDatasets.length, 'datasets');

            // Update chart data
            charts.brandMatrix.data.datasets = brandDatasets;

            // Recalculate axis ranges
            const maxBubbleR = Math.max(...brandDatasets.flatMap(d => d.data.map(p => p.r || 10)));
            const allX = brandDatasets.flatMap(d => d.data.map(p => p.x));
            const allY = brandDatasets.flatMap(d => d.data.map(p => p.y));

            const xMin = Math.max(0, Math.min(...allX) - 1);
            const xMax = Math.max(...allX) + 1;
            const yMin = Math.max(1, Math.min(...allY) - 5);
            const yMax = Math.max(...allY) + 5;

            console.log('[DateRange] New axis ranges:', { xMin, xMax, yMin, yMax });

            charts.brandMatrix.options.scales.x.min = xMin;
            charts.brandMatrix.options.scales.x.max = xMax;
            charts.brandMatrix.options.scales.y.min = yMin;
            charts.brandMatrix.options.scales.y.max = yMax;

            charts.brandMatrix.update('none');  // 'none' for immediate update without animation
            console.log('[DateRange] Chart updated successfully');
        }

        // ============== END DATE RANGE PICKER FUNCTIONS ==============

        // Update action table with dynamic data
        function updateActionTable(items) {
            const tbody = document.querySelector('.action-table tbody');
            if (!tbody || !items.length) return;

            tbody.innerHTML = items.map((item, idx) => {
                // Generate discount badges if available
                const discountInfo = item.discount_percent || item.has_coupon || item.is_deal ?
                    generateDiscountBadges(item) : '';

                // 제품명 짧게 표시 (LANEIGE 제거 후 40자)
                // products 데이터에서 전체 이름 가져오기 (action_items의 product_name은 truncate됨)
                const productData = window.dashboardData?.products?.[item.asin];
                const fullName = productData?.name || item.product_name || 'Unknown';
                const shortName = fullName.replace(/^LANEIGE\s+/i, '').substring(0, 40) + (fullName.length > 47 ? '...' : '');

                return `
                <tr onclick="goToProductDetail('${item.asin || ''}', '${item.product_name || ''}')">
                    <td><span class="priority-badge ${item.priority.toLowerCase()}">${item.priority === 'P1' ? '🔴' : '🟠'} ${item.priority}</span></td>
                    <td>
                        <div class="product-info">
                            <div class="product-avatar">LN</div>
                            <div>
                                <div class="product-name">
                                    <span class="product-name-wrapper">
                                        <span class="product-name-truncate">${shortName}</span>
                                        <div class="product-name-tooltip">
                                            <div class="tooltip-header">📦 제품 정보</div>
                                            <ul class="tooltip-list">
                                                <li>${fullName}</li>
                                                <li>ASIN: ${item.asin || '-'}</li>
                                            </ul>
                                        </div>
                                    </span>
                                    ${discountInfo}
                                </div>
                                <div class="product-brand">${item.brand_variant || ''}</div>
                            </div>
                        </div>
                    </td>
                    <td>${item.signal}</td>
                    <td><span class="action-tag ${item.action_tag.toLowerCase()}">${item.action_tag}</span></td>
                    <td><a href="#" class="link-action" onclick="event.stopPropagation(); goToProductDetail('${item.asin || ''}', '${item.product_name || ''}');">상세 분석 →</a></td>
                </tr>
                `;
            }).join('');

            // 주의 제품 툴팁 업데이트
            updateWarningTooltip(items);

            // 카테고리 포지션 툴팁 업데이트
            updateCategoryPositionTooltip(items);

            // 제품명 툴팁 위치 이벤트 바인딩
            bindProductTooltipEvents();
        }

        // 제품명 툴팁 동적 위치 조정 및 표시
        function bindProductTooltipEvents() {
            document.querySelectorAll('.product-name-wrapper').forEach(wrapper => {
                // onmouseenter/onmouseleave로 직접 할당 (중복 방지)
                wrapper.onmouseenter = function() {
                    const tooltip = this.querySelector('.product-name-tooltip');
                    if (!tooltip) return;

                    const rect = this.getBoundingClientRect();
                    const tooltipWidth = 300;
                    const tooltipHeight = 150;
                    const padding = 10;

                    // 기본: 아래쪽에 표시
                    let top = rect.bottom + padding;
                    let left = rect.left;

                    // 오른쪽 화면 경계 체크
                    if (left + tooltipWidth > window.innerWidth) {
                        left = window.innerWidth - tooltipWidth - padding;
                    }

                    // 왼쪽 경계 체크
                    if (left < padding) {
                        left = padding;
                    }

                    // 아래쪽 화면 경계 체크 - 위로 표시
                    if (top + tooltipHeight > window.innerHeight) {
                        top = rect.top - tooltipHeight - padding;
                    }

                    tooltip.style.top = top + 'px';
                    tooltip.style.left = left + 'px';
                    tooltip.style.opacity = '1';
                    tooltip.style.visibility = 'visible';
                };

                wrapper.onmouseleave = function() {
                    const tooltip = this.querySelector('.product-name-tooltip');
                    if (tooltip) {
                        tooltip.style.opacity = '0';
                        tooltip.style.visibility = 'hidden';
                    }
                };
            });
        }

        // 주의 제품 툴팁 업데이트
        function updateWarningTooltip(items) {
            const warningItems = items.filter(item => item.priority === 'P1' || item.action_tag === 'CHECK' || item.action_tag === 'RISK');
            const tooltipList = document.getElementById('warningProductsList');
            const warningCount = document.getElementById('warningCount');

            if (tooltipList && warningItems.length > 0) {
                tooltipList.innerHTML = warningItems.map(item =>
                    `<li>${item.product_name} - ${item.signal}</li>`
                ).join('');
                if (warningCount) warningCount.textContent = warningItems.length + '개';
            }
        }

        // 카테고리 포지션 툴팁 업데이트
        function updateCategoryPositionTooltip(items) {
            const tooltipList = document.getElementById('categoryPositionList');
            const positionValue = document.getElementById('categoryPositionValue');

            if (!tooltipList || !items || items.length === 0) return;

            // ASIN별로 가장 좋은 순위만 선택 (중복 제거)
            const asinBest = {};
            items.forEach(item => {
                const asin = item.asin;
                if (!asin) return;

                // rank를 숫자로 추출
                const rankMatch = item.signal?.match(/(\d+)위/) || item.signal?.match(/Top (\d+)/);
                const rank = rankMatch ? parseInt(rankMatch[1]) : 999;

                if (!asinBest[asin] || rank < asinBest[asin].rank) {
                    asinBest[asin] = {
                        name: item.product_name,
                        rank: rank,
                        category: item.category_name || '카테고리'
                    };
                }
            });

            // 순위순으로 정렬
            const sortedProducts = Object.values(asinBest)
                .filter(p => p.rank <= 50)  // Top 50 이내만 표시
                .sort((a, b) => a.rank - b.rank)
                .slice(0, 6);  // 최대 6개

            if (sortedProducts.length > 0) {
                tooltipList.innerHTML = sortedProducts.map(p =>
                    `<li>${p.name} - ${p.category} ${p.rank}위</li>`
                ).join('');

                // 가장 좋은 순위로 표시 업데이트
                const bestRank = sortedProducts[0].rank;
                if (positionValue) {
                    positionValue.textContent = `Top ${bestRank}`;
                }
            }
        }

        // 노출 상태 툴팁 업데이트
        function updateExposureStatusTooltip(homeData, items) {
            const tooltipList = document.getElementById('exposureStatusList');
            const statusValue = document.getElementById('exposureStatusValue');
            const statusCard = document.getElementById('exposureStatusCard');

            if (!tooltipList || !homeData) return;

            const status = homeData.status || {};
            const exposure = status.exposure || 'Stable';
            const top10Count = status.top10_count || 0;

            // 상태 값 업데이트
            if (statusValue) {
                statusValue.textContent = exposure;
            }

            // 카드 클래스 업데이트 (상태에 따라 색상 변경)
            if (statusCard) {
                statusCard.classList.remove('success', 'info', 'danger');
                if (exposure.includes('Up') || exposure.includes('Stable')) {
                    statusCard.classList.add('success');
                } else if (exposure.includes('Moderate')) {
                    statusCard.classList.add('info');
                } else {
                    statusCard.classList.add('danger');
                }
            }

            // 툴팁 내용 생성
            const tooltipItems = [];

            // Top 10 내 제품 수
            tooltipItems.push(`Top 10 내 LANEIGE 제품: ${top10Count}개`);

            // 상태 판단 기준 설명
            if (top10Count >= 3) {
                tooltipItems.push('판단: 3개 이상 → Stable Up');
            } else if (top10Count >= 1) {
                tooltipItems.push('판단: 1~2개 → Moderate');
            } else {
                tooltipItems.push('판단: 0개 → Needs Attention');
            }

            // 순위 변동 요약 (items에서 추출)
            if (items && items.length > 0) {
                const upItems = items.filter(i => i.signal?.includes('상향')).length;
                const downItems = items.filter(i => i.signal?.includes('하락') && i.signal?.includes('순위')).length;
                if (upItems > 0) tooltipItems.push(`순위 상승 제품: ${upItems}개`);
                if (downItems > 0) tooltipItems.push(`순위 하락 제품: ${downItems}개`);
            }

            tooltipList.innerHTML = tooltipItems.map(item => `<li>${item}</li>`).join('');
        }

        // 경쟁사 테이블 업데이트
        function updateCompetitorTable(competitors) {
            const tbody = document.getElementById('competitor-tbody');
            if (!tbody || !competitors || !competitors.length) return;

            // LANEIGE SoS 찾기 (기준점)
            const laneige = competitors.find(c => c.brand.toUpperCase().includes('LANEIGE'));
            const laneigeSos = laneige ? laneige.sos : 0;

            // 상위 5개 브랜드만 표시
            const top5 = competitors.slice(0, 5);

            tbody.innerHTML = top5.map((comp, idx) => {
                const isLaneige = comp.brand.toUpperCase().includes('LANEIGE');
                const sosDiff = (comp.sos - laneigeSos).toFixed(1);
                const vsBadgeClass = isLaneige ? 'baseline' : (parseFloat(sosDiff) > 0 ? 'ahead' : 'behind');
                const vsBadgeText = isLaneige ? '기준' : (parseFloat(sosDiff) > 0 ? `+${sosDiff}%p` : `${sosDiff}%p`);
                // 평균 가격 표시 (avg_price 필드 사용)
                const avgPriceDisplay = comp.avg_price ? `$${comp.avg_price.toFixed(2)}` : '-';

                return `
                    <tr class="${isLaneige ? 'highlight-row' : ''}">
                        <td><span class="rank-badge">#${idx + 1}</span></td>
                        <td>${isLaneige ? '<strong>' + comp.brand + '</strong>' : comp.brand}</td>
                        <td>${comp.sos}%</td>
                        <td>${comp.product_count || comp.count || '-'}개</td>
                        <td>${comp.avg_rank ? comp.avg_rank.toFixed(1) + '위' : '-'}</td>
                        <td>${avgPriceDisplay}</td>
                        <td><span class="vs-badge ${vsBadgeClass}">${vsBadgeText}</span></td>
                    </tr>
                `;
            }).join('');
        }

        // Utility function to generate discount badges HTML
        function generateDiscountBadges(product) {
            let badges = '';

            // Discount percentage badge
            if (product.discount_percent && product.discount_percent > 0) {
                badges += `<span class="discount-badge">-${product.discount_percent}%</span>`;
            }

            // Coupon badge
            if (product.coupon_text || product.has_coupon) {
                const couponText = product.coupon_text || 'Coupon';
                badges += `<span class="coupon-badge">🎟️ ${couponText}</span>`;
            }

            // Deal badge (Lightning Deal, Limited Time Deal, etc.)
            if (product.deal_type || product.is_deal) {
                const dealText = product.deal_type || 'Deal';
                badges += `<span class="deal-badge">⚡ ${dealText}</span>`;
            }

            return badges;
        }

        // Utility function to generate price display HTML
        function generatePriceDisplay(product) {
            if (!product.price && !product.current_price) {
                return '<span style="color: var(--text-secondary);">가격 정보 없음</span>';
            }

            const currentPrice = product.current_price || product.price;
            const originalPrice = product.original_price;

            let priceHtml = '<div class="price-container">';

            // Show original price if there's a discount
            if (originalPrice && originalPrice > currentPrice) {
                priceHtml += `<span class="price-original">$${originalPrice.toFixed(2)}</span>`;
            }

            // Current price
            priceHtml += `<span class="price-current">$${currentPrice.toFixed(2)}</span>`;

            priceHtml += '</div>';

            return priceHtml;
        }

        // 경쟁사 드롭다운 동적 생성
        function populateCompetitorDropdown() {
            const select = document.getElementById('competitor-select');
            if (!select) return;

            const competitors = dashboardData?.brand?.competitors || [];

            // 기존 동적 옵션 제거 (Summer Fridays는 유지)
            const options = select.querySelectorAll('option:not([value=""]):not([value="Summer Fridays"])');
            options.forEach(opt => opt.remove());

            // 경쟁사 데이터에서 옵션 추가 (Summer Fridays 제외)
            competitors.forEach(comp => {
                if (comp.brand && comp.brand !== 'Summer Fridays') {
                    const option = document.createElement('option');
                    option.value = comp.brand;
                    option.textContent = comp.brand;
                    select.appendChild(option);
                }
            });
        }

        // Enhanced Competitor Comparison
        function updateCompetitorComparison() {
            const select = document.getElementById('competitor-select');
            const bodyDiv = document.getElementById('detailed-comparison-body');

            if (!select || !bodyDiv) return;

            const competitorName = select.value;

            if (!competitorName) {
                bodyDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px 0; color: var(--text-secondary);">
                        <i data-lucide="users" style="width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.3;"></i>
                        <p>비교할 경쟁사를 선택하세요</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            // LANEIGE 데이터: brand.kpis에서 우선 가져오기 (competitors에 없을 수 있음)
            const kpis = dashboardData?.brand?.kpis || {};
            const competitors = dashboardData?.brand?.competitors || [];

            // LANEIGE 데이터 구성
            const laneige = {
                brand: 'LANEIGE',
                sos: kpis.sos || 0,
                product_count: kpis.top10_count || kpis.product_count || 0,
                avg_rank: kpis.avg_rank || 0,
                avg_price: kpis.avg_price || 0
            };

            // 경쟁사 데이터 찾기
            const competitor = competitors.find(c => c.brand === competitorName) || {
                brand: competitorName,
                sos: 0,
                product_count: 0,
                avg_rank: 0,
                avg_price: 0
            };

            // Helper function to compare values
            function compareValues(val1, val2, lowerIsBetter = false) {
                if (!val1 || !val2) return 'same';
                if (lowerIsBetter) {
                    return val1 < val2 ? 'better' : val1 > val2 ? 'worse' : 'same';
                }
                return val1 > val2 ? 'better' : val1 < val2 ? 'worse' : 'same';
            }

            // Generate comparison table
            bodyDiv.innerHTML = `
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th class="metric-label">지표</th>
                            <th class="value-cell">LANEIGE</th>
                            <th class="value-cell">${competitorName}</th>
                            <th class="value-cell">우위</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="metric-label">Share of Shelf (SoS)</td>
                            <td class="value-cell">${laneige.sos ? laneige.sos.toFixed(1) + '%' : '-'}</td>
                            <td class="value-cell">${competitor.sos ? competitor.sos.toFixed(1) + '%' : '-'}</td>
                            <td class="value-cell ${compareValues(laneige.sos, competitor.sos)}">
                                ${laneige.sos > competitor.sos ? '✓ LANEIGE' : laneige.sos < competitor.sos ? competitorName : '동일'}
                            </td>
                        </tr>
                        <tr>
                            <td class="metric-label">제품 수</td>
                            <td class="value-cell">${laneige.product_count || laneige.count || '-'}개</td>
                            <td class="value-cell">${competitor.product_count || competitor.count || '-'}개</td>
                            <td class="value-cell ${compareValues(laneige.product_count, competitor.product_count)}">
                                ${(laneige.product_count || 0) > (competitor.product_count || 0) ? '✓ LANEIGE' :
                                  (laneige.product_count || 0) < (competitor.product_count || 0) ? competitorName : '동일'}
                            </td>
                        </tr>
                        <tr>
                            <td class="metric-label">평균 순위</td>
                            <td class="value-cell">${laneige.avg_rank ? laneige.avg_rank.toFixed(1) + '위' : '-'}</td>
                            <td class="value-cell">${competitor.avg_rank ? competitor.avg_rank.toFixed(1) + '위' : '-'}</td>
                            <td class="value-cell ${compareValues(laneige.avg_rank, competitor.avg_rank, true)}">
                                ${(laneige.avg_rank || 999) < (competitor.avg_rank || 999) ? '✓ LANEIGE' :
                                  (laneige.avg_rank || 999) > (competitor.avg_rank || 999) ? competitorName : '동일'}
                            </td>
                        </tr>
                        <tr>
                            <td class="metric-label">평균 가격</td>
                            <td class="value-cell">${laneige.avg_price ? '$' + laneige.avg_price.toFixed(2) : '-'}</td>
                            <td class="value-cell">${competitor.avg_price ? '$' + competitor.avg_price.toFixed(2) : '-'}</td>
                            <td class="value-cell same">
                                ${Math.abs((laneige.avg_price || 0) - (competitor.avg_price || 0)) < 1 ? '비슷함' :
                                  (laneige.avg_price || 0) > (competitor.avg_price || 0) ? 'LANEIGE 고가' : competitorName + ' 고가'}
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="chart-guide" style="margin-top: 16px;">
                    <strong>분석:</strong> ${competitorName}과(와) LANEIGE의 핵심 지표 비교.
                    <span class="better" style="display: inline;">✓</span> 표시는 우위를 나타냅니다.
                </div>
            `;
        }

        // 제품 상세 페이지로 이동
        function goToProductDetail(asin, productName) {
            // 제품 페이지로 전환
            switchPage('product');

            // 제품 선택 드롭다운에서 해당 제품 찾기
            const productSelect = document.getElementById('productSelect');
            if (productSelect && productName) {
                // 제품명으로 옵션 찾기
                const options = productSelect.options;
                for (let i = 0; i < options.length; i++) {
                    if (options[i].textContent.includes(productName.split(' ')[0])) {
                        productSelect.selectedIndex = i;
                        updateProductView();
                        break;
                    }
                }
            }

            // 챗봇 열고 해당 제품 분석 요청
            setTimeout(() => {
                const chatInput = document.getElementById('chatInput');
                if (chatInput && productName) {
                    chatInput.value = `${productName} 제품의 상세 분석을 해주세요.`;
                    chatInput.focus();
                }
            }, 300);
        }

        // SoS 추이 차트 날짜 범위 초기화 (글로벌 날짜 범위 사용)
        function initSosTrendDateRange() {
            let { startDate, endDate } = globalDateRange.get();

            // globalDateRange가 아직 초기화되지 않은 경우 fallback
            if (!startDate || !endDate) {
                console.warn('[initSosTrendDateRange] globalDateRange not initialized, using fallback');
                if (dashboardData?.charts?.sos_trend?.['30d']?.labels) {
                    const labels = dashboardData.charts.sos_trend['30d'].labels;
                    if (labels.length > 0) {
                        const year = new Date().getFullYear();
                        endDate = `${year}-${labels[labels.length - 1].replace('/', '-')}`;
                        startDate = `${year}-${labels[0].replace('/', '-')}`;
                    }
                }
                if (!startDate || !endDate) {
                    const today = new Date();
                    endDate = today.toISOString().split('T')[0];
                    const start = new Date(today);
                    start.setDate(start.getDate() - 13);
                    startDate = start.toISOString().split('T')[0];
                }
            }

            const startInput = document.getElementById('sosTrendStartDate');
            const endInput = document.getElementById('sosTrendEndDate');
            if (startInput && endInput) {
                startInput.value = startDate;
                endInput.value = endDate;
            }
        }

        // SoS 추이 차트 날짜 범위 적용 (글로벌 상태 업데이트 포함)
        async function applySosTrendDateRange() {
            const startDate = document.getElementById('sosTrendStartDate')?.value;
            const endDate = document.getElementById('sosTrendEndDate')?.value;

            if (!startDate || !endDate) {
                showToast('시작일과 종료일을 모두 선택해주세요.', 'error');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                showToast('시작일이 종료일보다 늦을 수 없습니다.', 'error');
                return;
            }

            // 글로벌 날짜 범위 업데이트 (모든 차트 자동 업데이트)
            globalDateRange.set(startDate, endDate);
        }

        // 기존 호환성 유지용 (사용 안함)
        function updateSosTrendPeriod(days, btnElement) {
            // 날짜 선택기로 대체됨
        }

        function switchPage(pageId) {
            currentPage = pageId;
            document.querySelectorAll('.page-view').forEach(p => p.classList.remove('active'));
            document.getElementById(`page-${pageId}`).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(item => { item.classList.remove('active'); if (item.dataset.page === pageId) item.classList.add('active'); });
            // 모바일에서 페이지 전환 시 사이드바 닫기
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.querySelector('.sidebar-overlay');
                if (sidebar) sidebar.classList.remove('open');
                if (overlay) overlay.classList.remove('active');
            }
            const titles = {
                home: { title: 'Home', breadcrumb: 'Daily Insight & Action Board' },
                brand: { title: 'Brand View (L1)', breadcrumb: 'Laneige 브랜드 분석' },
                category: { title: 'Category View (L2)', breadcrumb: 'Amazon US 카테고리 분석' },
                product: { title: 'Product View (L3)', breadcrumb: 'Laneige 제품 상세' }
            };
            document.getElementById('page-title').textContent = titles[pageId].title;
            document.getElementById('breadcrumb').textContent = titles[pageId].breadcrumb;
            initChartsForPage(pageId);
            // Product View 진입 시 날짜 선택기 값으로 차트 데이터 로드
            if (pageId === 'product') {
                setTimeout(() => {
                    loadInitialProductChartData();
                }, 200);
            }
        }

        // === Category Date Range Functions ===
        let categoryDateRange = {
            start: null,
            end: null
        };

        function initCategoryDateRange() {
            // 글로벌 날짜 범위 사용
            const { startDate, endDate } = globalDateRange.get();

            const catStartInput = document.getElementById('categoryStartDate');
            const catEndInput = document.getElementById('categoryEndDate');
            if (catStartInput && catEndInput) {
                catStartInput.value = startDate;
                catEndInput.value = endDate;
            }

            categoryDateRange.start = startDate;
            categoryDateRange.end = endDate;

            // CPI 차트 날짜 범위도 초기화
            const cpiStartInput = document.getElementById('cpiStartDate');
            const cpiEndInput = document.getElementById('cpiEndDate');
            if (cpiStartInput && cpiEndInput) {
                cpiStartInput.value = startDate;
                cpiEndInput.value = endDate;
            }

            // CPI 드롭다운 변경 이벤트 리스너 추가
            const cpiLaneigeSelect = document.getElementById('cpiLaneigeProductSelect');
            const cpiCompetitorSelect = document.getElementById('cpiCompetitorProductSelect');
            if (cpiLaneigeSelect) {
                cpiLaneigeSelect.addEventListener('change', () => applyCpiDateRange());
            }
            if (cpiCompetitorSelect) {
                cpiCompetitorSelect.addEventListener('change', () => applyCpiDateRange());
            }
        }

        async function applyCpiDateRange() {
            const startDate = document.getElementById('cpiStartDate')?.value;
            const endDate = document.getElementById('cpiEndDate')?.value;

            if (!startDate || !endDate) {
                showToast('시작일과 종료일을 모두 선택해주세요.', 'error');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                showToast('시작일이 종료일보다 늦을 수 없습니다.', 'error');
                return;
            }

            // 글로벌 날짜 범위 업데이트 (모든 차트 자동 업데이트)
            globalDateRange.set(startDate, endDate);
        }

        async function updateCpiChartWithProducts(startDate, endDate) {
            try {
                console.log('[CPI] Updating chart with range:', startDate, '~', endDate);
                const laneigeSelect = document.getElementById('cpiLaneigeProductSelect');
                const competitorSelect = document.getElementById('cpiCompetitorProductSelect');

                const historicalData = await fetchHistoricalData(startDate, endDate);
                if (!historicalData) {
                    console.log('[CPI] No historical data');
                    return;
                }

                const rankHistory = historicalData.rank_history || {};
                // 요청된 기간 내 날짜만 필터링
                const allDates = Object.keys(rankHistory).sort();
                const dates = allDates.filter(d => d >= startDate && d <= endDate);
                console.log('[CPI] Filtered dates:', dates.length, 'from', dates[0], 'to', dates[dates.length-1]);

                // 제품별 가격/할인 데이터 수집
                const productStats = {};
                dates.forEach(date => {
                    const dayData = rankHistory[date];
                    if (dayData && dayData.products) {
                        dayData.products.forEach(p => {
                            const name = p.name || p.product_name;
                            if (!name) return;
                            if (!productStats[name]) {
                                productStats[name] = {
                                    name,
                                    brand: p.brand || 'Unknown',
                                    prices: {},
                                    ranks: []
                                };
                            }
                            if (p.price) productStats[name].prices[date] = p.price;
                            if (p.rank) productStats[name].ranks.push(p.rank);
                        });
                    }
                });

                // 제품 목록 정렬 (LANEIGE 우선, 순위순)
                const sortedProducts = Object.values(productStats)
                    .filter(p => p.ranks.length > 0)
                    .map(p => ({
                        ...p,
                        avgRank: p.ranks.reduce((a, b) => a + b, 0) / p.ranks.length
                    }))
                    .sort((a, b) => {
                        const aIsLaneige = a.brand.toLowerCase() === 'laneige';
                        const bIsLaneige = b.brand.toLowerCase() === 'laneige';
                        if (aIsLaneige && !bIsLaneige) return -1;
                        if (!aIsLaneige && bIsLaneige) return 1;
                        return a.avgRank - b.avgRank;
                    });

                const laneigProducts = sortedProducts.filter(p => p.brand.toLowerCase() === 'laneige');
                const otherProducts = sortedProducts.filter(p => p.brand.toLowerCase() !== 'laneige');

                // LANEIGE 드롭다운 업데이트
                if (laneigeSelect) {
                    const currentLaneige = laneigeSelect.value;
                    laneigeSelect.innerHTML = '<option value="">LANEIGE 제품 선택...</option>';
                    laneigProducts.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.name;
                        const shortName = p.name.length > 35 ? p.name.substring(0, 35) + '...' : p.name;
                        option.textContent = shortName;
                        option.title = p.name;
                        laneigeSelect.appendChild(option);
                    });
                    if (currentLaneige) laneigeSelect.value = currentLaneige;
                }

                // 경쟁사 드롭다운 업데이트
                if (competitorSelect) {
                    const currentCompetitor = competitorSelect.value;
                    competitorSelect.innerHTML = '<option value="">경쟁사 제품 선택...</option>';

                    // 브랜드별 그룹화
                    const brandGroups = {};
                    otherProducts.forEach(p => {
                        if (!brandGroups[p.brand]) brandGroups[p.brand] = [];
                        brandGroups[p.brand].push(p);
                    });

                    Object.keys(brandGroups).sort().forEach(brand => {
                        const group = document.createElement('optgroup');
                        group.label = brand;
                        brandGroups[brand].slice(0, 5).forEach(p => {
                            const option = document.createElement('option');
                            option.value = p.name;
                            const shortName = p.name.length > 30 ? p.name.substring(0, 30) + '...' : p.name;
                            option.textContent = shortName;
                            option.title = p.name;
                            group.appendChild(option);
                        });
                        competitorSelect.appendChild(group);
                    });
                    if (currentCompetitor) competitorSelect.value = currentCompetitor;
                }

                // 선택된 제품으로 CPI 차트 그리기
                const selectedLaneige = laneigeSelect?.value;
                const selectedCompetitor = competitorSelect?.value;

                if (selectedLaneige && selectedCompetitor) {
                    const laneigeData = productStats[selectedLaneige];
                    const competitorData = productStats[selectedCompetitor];

                    if (laneigeData && competitorData) {
                        // CPI 계산: (LANEIGE 가격 / 경쟁사 가격) * 100
                        // 모든 날짜를 labels에 추가하고, 데이터 없는 날은 null로 처리
                        const cpiData = [];
                        const labels = [];
                        let missingDates = 0;
                        let validDates = 0;
                        let firstValidDate = null;
                        let lastValidDate = null;

                        dates.forEach(date => {
                            const lPrice = laneigeData.prices[date];
                            const cPrice = competitorData.prices[date];
                            const dateLabel = date.slice(5); // MM-DD
                            labels.push(dateLabel);

                            if (lPrice && lPrice > 0 && cPrice && cPrice > 0) {
                                const cpi = (lPrice / cPrice) * 100;
                                cpiData.push(parseFloat(cpi.toFixed(1)));
                                validDates++;
                                if (!firstValidDate) firstValidDate = dateLabel;
                                lastValidDate = dateLabel;
                            } else {
                                cpiData.push(null); // 차트에서 gap으로 표시
                                missingDates++;
                            }
                        });

                        console.log('[CPI] Total dates:', dates.length, '| Valid:', validDates, '| Missing:', missingDates);

                        if (validDates > 0) {
                            const actualRange = `${firstValidDate} ~ ${lastValidDate}`;
                            updateCpiChart(labels, cpiData, selectedLaneige, selectedCompetitor, competitorData.brand, actualRange, missingDates, dates.length, validDates);
                        } else {
                            const infoEl = document.getElementById('cpi-comparison-info');
                            if (infoEl) {
                                infoEl.innerHTML = '⚠️ 선택한 기간에 두 제품의 가격 데이터가 겹치는 날짜가 없습니다.';
                            }
                        }
                    }
                } else {
                    // 선택 안됨 - 안내 메시지
                    const infoEl = document.getElementById('cpi-comparison-info');
                    if (infoEl) {
                        infoEl.innerHTML = '📊 LANEIGE 제품과 비교할 경쟁사 제품을 선택해주세요.';
                    }
                }

            } catch (error) {
                console.error('[CPI] Error updating chart:', error);
            }
        }

        function updateCpiChart(labels, data, laneigeName, competitorName, competitorBrand, actualRange = '', missingDates = 0, totalDates = 0, validDates = 0) {
            const ctx = document.getElementById('cpiChart');
            if (!ctx) return;

            // 기존 차트 제거
            if (charts.cpi) {
                charts.cpi.destroy();
            }

            const shortLaneige = laneigeName.length > 25 ? laneigeName.substring(0, 25) + '...' : laneigeName;
            const shortCompetitor = competitorName.length > 25 ? competitorName.substring(0, 25) + '...' : competitorName;

            // Y축 스케일: 100을 정확히 가운데로 배치 (null 값 제외)
            const numericData = data.filter(v => v !== null).map(Number);
            const dataMax = numericData.length > 0 ? Math.max(...numericData) : 130;
            const dataMin = numericData.length > 0 ? Math.min(...numericData) : 70;

            // 100에서 가장 멀리 떨어진 값 기준으로 대칭 범위 설정
            const maxDeviation = Math.max(
                Math.abs(dataMax - 100),
                Math.abs(dataMin - 100)
            );
            // 여유 20% 추가, 최소 30pt
            const range = Math.max(30, Math.ceil(maxDeviation * 1.2));
            const yMin = 100 - range;
            const yMax = 100 + range;

            charts.cpi = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'LANEIGE CPI',
                            data: data,
                            borderColor: '#1F5795',
                            backgroundColor: 'rgba(31, 87, 149, 0.15)',
                            borderWidth: 2.5,
                            fill: false, // null 값이 있을 때 fill 비활성화
                            tension: 0.3,
                            spanGaps: false, // null 값에서 선 끊기
                            pointRadius: function(context) {
                                // null 값은 포인트 숨김
                                return context.raw === null ? 0 : 5;
                            },
                            pointBackgroundColor: '#1F5795',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            segment: {
                                // 데이터가 끊어진 구간 전후는 점선으로 표시
                                borderDash: ctx => {
                                    if (ctx.p0.skip || ctx.p1.skip) return [5, 5];
                                    return undefined;
                                }
                            }
                        },
                        {
                            label: '기준선 (100)',
                            data: Array(labels.length).fill(100),
                            borderColor: '#E74C3C',
                            borderWidth: 2,
                            borderDash: [8, 4],
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { font: { size: 11 } }
                        },
                        tooltip: {
                            filter: function(tooltipItem) {
                                // null 값은 툴팁에서 제외
                                return tooltipItem.raw !== null;
                            },
                            callbacks: {
                                label: function(context) {
                                    if (context.datasetIndex === 0) {
                                        const cpi = context.parsed.y;
                                        if (cpi === null) return null;
                                        const diff = (cpi - 100).toFixed(1);
                                        const status = cpi >= 100 ? `+${diff} 프리미엄` : `${diff} 저가`;
                                        return `CPI: ${cpi} (${status})`;
                                    }
                                    return context.dataset.label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            min: yMin,
                            max: yMax,
                            ticks: {
                                font: { size: 11 },
                                stepSize: range > 100 ? 50 : 25,
                                callback: function(value) {
                                    if (value === 100) return '★ 100 (기준)';
                                    return value;
                                }
                            },
                            grid: {
                                color: function(context) {
                                    if (context.tick.value === 100) {
                                        return '#E74C3C';
                                    }
                                    return 'rgba(0, 0, 0, 0.08)';
                                },
                                lineWidth: function(context) {
                                    if (context.tick.value === 100) {
                                        return 2;
                                    }
                                    return 1;
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: { size: 11 },
                                maxRotation: 45,
                                minRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 15 // 너무 많은 날짜는 자동 생략
                            }
                        }
                    }
                }
            });

            // 정보 업데이트 (개선된 표시)
            const infoEl = document.getElementById('cpi-comparison-info');
            if (infoEl) {
                // null 값 제외하고 평균 계산
                const validData = data.filter(v => v !== null);
                const avgCpi = validData.length > 0
                    ? (validData.reduce((a, b) => a + parseFloat(b), 0) / validData.length).toFixed(1)
                    : 100;
                const diff = (avgCpi - 100).toFixed(1);
                const status = avgCpi >= 100 ? `프리미엄 (+${diff}%)` : `저가 (${diff}%)`;
                let info = `📊 <strong>비교:</strong> ${shortLaneige} vs ${competitorBrand} (${shortCompetitor}) | <strong>평균 CPI:</strong> ${avgCpi} (${status})`;
                if (actualRange) {
                    info += ` | <strong>데이터 기간:</strong> ${actualRange}`;
                }
                // 개선된 누락 정보 표시
                if (totalDates > 0 && validDates > 0 && validDates < totalDates) {
                    const coverage = ((validDates / totalDates) * 100).toFixed(0);
                    info += ` <span style="color: #C4A962;">(${validDates}일/${totalDates}일 데이터, ${coverage}% 커버리지)</span>`;
                }
                infoEl.innerHTML = info;
            }
        }

        async function applyCategoryDateRange() {
            const startDate = document.getElementById('categoryStartDate').value;
            const endDate = document.getElementById('categoryEndDate').value;

            if (!startDate || !endDate) {
                showToast('시작일과 종료일을 모두 선택해주세요.', 'error');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                showToast('시작일이 종료일보다 늦을 수 없습니다.', 'error');
                return;
            }

            categoryDateRange.start = startDate;
            categoryDateRange.end = endDate;

            // CPI 차트 기간도 동기화
            const cpiStartInput = document.getElementById('cpiStartDate');
            const cpiEndInput = document.getElementById('cpiEndDate');
            if (cpiStartInput && cpiEndInput) {
                cpiStartInput.value = startDate;
                cpiEndInput.value = endDate;
            }

            // 현재 선택된 카테고리 찾기
            const activeTab = document.querySelector('.category-tab.active');
            if (activeTab) {
                const catKey = activeTab.getAttribute('onclick').match(/selectCategory\('(\w+)'/)?.[1];
                if (catKey) {
                    await loadCategoryKPIWithDateRange(catKey, startDate, endDate);
                }
            }

            // CPI 차트도 업데이트
            await updateCpiChartWithProducts(startDate, endDate);

            showToast(`기간이 ${startDate} ~ ${endDate}로 적용되었습니다.`, 'success');
        }

        async function loadCategoryKPIWithDateRange(categoryKey, startDate, endDate) {
            const catMap = {
                'beauty': 'beauty_personal_care',
                'skin': 'skin_care',
                'lip': 'lip_care',
                'lip_makeup': 'lip_makeup',
                'face_powder': 'face_powder'
            };
            const categoryId = catMap[categoryKey] || categoryKey;

            try {
                // API 호출하여 기간별 데이터 로드
                const response = await fetch(`/api/category/kpi?category_id=${categoryId}&start_date=${startDate}&end_date=${endDate}`);

                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        updateCategoryKPIDisplay(result.data);
                        return;
                    }
                }

                // API 실패 시 기존 데이터 사용
                console.warn('API 호출 실패, 기존 데이터 사용');

            } catch (error) {
                console.error('Category KPI 로드 오류:', error);
            }
        }

        function updateCategoryKPIDisplay(data) {
            if (data.sos !== undefined) {
                document.getElementById('cat-sos').innerHTML = data.sos.toFixed(1) + '<span class="unit">%</span>';
            }
            if (data.best_rank !== undefined) {
                document.getElementById('cat-rank').textContent = '#' + data.best_rank;
            }
            if (data.cpi !== undefined) {
                document.getElementById('cat-cpi').innerHTML = data.cpi.toFixed(0) + '<span class="unit">pt</span>';
            }
            if (data.new_competitors !== undefined) {
                document.getElementById('cat-new').innerHTML = data.new_competitors + '<span class="unit">개</span>';
            }

            // 배지 업데이트
            updateCategoryBadges({
                sos: data.sos || 0,
                rank: '#' + (data.best_rank || 0),
                cpi: data.cpi || 100,
                new: data.new_competitors || 0
            });
        }

        function selectCategory(cat, el) {
            document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');

            // 카테고리 ID 매핑 (새로운 5개 카테고리)
            const catMap = {
                'beauty': 'beauty_personal_care',
                'skin': 'skin_care',
                'lip': 'lip_care',
                'lip_makeup': 'lip_makeup',
                'face_powder': 'face_powder'
            };
            const catId = catMap[cat] || cat;

            // JSON 데이터에서 카테고리 KPI 로드
            let data;
            if (dashboardData?.charts?.category_kpis?.[catId]) {
                const catKpi = dashboardData.charts.category_kpis[catId];
                data = {
                    sos: catKpi.sos || 0,
                    rank: '#' + (catKpi.best_rank || 'N/A'),
                    cpi: catKpi.cpi || 100,
                    new: catKpi.new_competitors || 0
                };
            } else {
                // Fallback 데이터 (새로운 5개 카테고리)
                const fallback = {
                    beauty: { sos: '5.2', rank: '#8', cpi: '105', new: '45' },
                    skin: { sos: '12.3', rank: '#4', cpi: '108', new: '24' },
                    lip: { sos: '18.5', rank: '#2', cpi: '112', new: '18' },
                    lip_makeup: { sos: '8.1', rank: '#6', cpi: '98', new: '22' },
                    face_powder: { sos: '6.7', rank: '#9', cpi: '115', new: '15' }
                };
                data = fallback[cat] || { sos: 0, rank: '#N/A', cpi: 100, new: 0 };
            }

            document.getElementById('cat-sos').innerHTML = data.sos + '<span class="unit">%</span>';
            document.getElementById('cat-rank').textContent = data.rank;
            document.getElementById('cat-cpi').innerHTML = data.cpi + '<span class="unit">pt</span>';
            document.getElementById('cat-new').innerHTML = data.new + '<span class="unit">개</span>';

            // KPI 배지 업데이트
            updateCategoryBadges(data);

            // CPI 차트 드롭다운 데이터 로드
            const cpiStartDate = document.getElementById('cpiStartDate')?.value;
            const cpiEndDate = document.getElementById('cpiEndDate')?.value;
            if (cpiStartDate && cpiEndDate) {
                updateCpiChartWithProducts(cpiStartDate, cpiEndDate);
            }
        }

        // 카테고리 KPI 배지 동적 업데이트
        function updateCategoryBadges(data) {
            const sos = parseFloat(data.sos);
            const rank = parseInt(data.rank.replace('#', ''));
            const cpi = parseFloat(data.cpi);
            const newComp = parseInt(data.new);

            // SoS 배지
            const sosBadge = document.getElementById('cat-sos-badge');
            if (sos >= 15) {
                sosBadge.textContent = 'Category Leader';
                sosBadge.className = 'kpi-delta up';
            } else if (sos >= 8) {
                sosBadge.textContent = 'Strong Presence';
                sosBadge.className = 'kpi-delta up';
            } else {
                sosBadge.textContent = '점유율 확대 필요';
                sosBadge.className = 'kpi-delta down';
            }

            // Rank 배지
            const rankBadge = document.getElementById('cat-rank-badge');
            if (rank <= 3) {
                rankBadge.textContent = '1위 근접';
                rankBadge.className = 'kpi-delta up';
            } else if (rank <= 10) {
                rankBadge.textContent = 'Top 10';
                rankBadge.className = 'kpi-delta up';
            } else {
                rankBadge.textContent = '순위 개선 필요';
                rankBadge.className = 'kpi-delta down';
            }

            // CPI 배지
            const cpiBadge = document.getElementById('cat-cpi-badge');
            if (cpi >= 110) {
                cpiBadge.textContent = '가격 경쟁력 하락';
                cpiBadge.className = 'kpi-delta down';
            } else if (cpi >= 90) {
                cpiBadge.textContent = '적정 가격';
                cpiBadge.className = 'kpi-delta up';
            } else {
                cpiBadge.textContent = '가격 경쟁력 우위';
                cpiBadge.className = 'kpi-delta up';
            }

            // 신규 경쟁자 배지
            const newBadge = document.getElementById('cat-new-badge');
            if (newComp >= 15) {
                newBadge.textContent = '경쟁 심화';
                newBadge.className = 'kpi-delta down';
            } else if (newComp >= 5) {
                newBadge.textContent = '보통';
                newBadge.className = 'kpi-delta';
            } else {
                newBadge.textContent = '안정적';
                newBadge.className = 'kpi-delta up';
            }
        }

        function updateProductList() {
            const cat = document.getElementById('productCategory').value;
            const select = document.getElementById('productSelect');
            select.innerHTML = '';
            categoryProducts[cat].forEach(p => { const opt = document.createElement('option'); opt.value = p[0]; opt.textContent = p[1]; select.appendChild(opt); });
            updateProductView();
        }

        function updateProductView() {
            const prod = document.getElementById('productSelect').value;
            const d = productData[prod] || { rank: '#10', rankDelta: '-', vol: '15', volDelta: '-', rating: '4.0', ratingDelta: '-', stick: '70', stickDelta: '-' };
            document.getElementById('prod-rank').textContent = d.rank;
            document.getElementById('prod-rank-delta').textContent = d.rankDelta;
            document.getElementById('prod-vol').innerHTML = d.vol + '<span class="unit">pt</span>';
            document.getElementById('prod-vol-delta').textContent = d.volDelta;
            document.getElementById('prod-rating').innerHTML = d.rating + '<span class="unit">★</span>';
            document.getElementById('prod-rating-delta').textContent = d.ratingDelta;
            document.getElementById('prod-stick').innerHTML = d.stick + '<span class="unit">pt</span>';
            document.getElementById('prod-stick-delta').textContent = d.stickDelta;

            // 프로모션 관련 데이터 업데이트
            updatePromoViews();
        }

        // Product View 날짜 범위 적용
        function applyProductDateRange() {
            const startDate = document.getElementById('productStartDate').value;
            const endDate = document.getElementById('productEndDate').value;

            if (!startDate || !endDate) {
                showToast('시작일과 종료일을 모두 선택해주세요.', 'error');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                showToast('시작일이 종료일보다 늦을 수 없습니다.', 'error');
                return;
            }

            // 기간 배지 업데이트
            const periodText = `${startDate.slice(5)} ~ ${endDate.slice(5)}`;
            const periodBadges = ['rankTrendPeriod', 'matrixPeriod', 'discountPeriod'];
            periodBadges.forEach(id => {
                const badge = document.getElementById(id);
                if (badge) badge.textContent = periodText;
            });

            // 차트 데이터 필터링 및 업데이트 (실제 데이터가 있을 경우)
            console.log(`Product View 기간 설정: ${startDate} ~ ${endDate}`);
            showToast(`기간이 적용되었습니다: ${periodText}`, 'success');

            // TODO: 실제 데이터 필터링 로직
            // filterProductDataByDateRange(startDate, endDate);
        }

        // Individual chart date range functions (글로벌 상태 업데이트 포함)
        async function applyRankTrendDateRange() {
            const startDate = document.getElementById('rankTrendStartDate').value;
            const endDate = document.getElementById('rankTrendEndDate').value;

            if (!startDate || !endDate) {
                showToast('시작일과 종료일을 모두 선택해주세요.', 'error');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                showToast('시작일이 종료일보다 늦을 수 없습니다.', 'error');
                return;
            }

            // 글로벌 날짜 범위 업데이트 (모든 차트 자동 업데이트)
            globalDateRange.set(startDate, endDate);
        }

        async function applyMatrixDateRange() {
            const startDate = document.getElementById('matrixStartDate').value;
            const endDate = document.getElementById('matrixEndDate').value;

            if (!startDate || !endDate) {
                showToast('시작일과 종료일을 모두 선택해주세요.', 'error');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                showToast('시작일이 종료일보다 늦을 수 없습니다.', 'error');
                return;
            }

            // 글로벌 날짜 범위 업데이트 (모든 차트 자동 업데이트)
            globalDateRange.set(startDate, endDate);
        }

        async function applyDiscountDateRange() {
            const startDate = document.getElementById('discountStartDate').value;
            const endDate = document.getElementById('discountEndDate').value;

            if (!startDate || !endDate) {
                showToast('시작일과 종료일을 모두 선택해주세요.', 'error');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                showToast('시작일이 종료일보다 늦을 수 없습니다.', 'error');
                return;
            }

            // 글로벌 날짜 범위 업데이트 (모든 차트 자동 업데이트)
            globalDateRange.set(startDate, endDate);
        }

        async function applyGrowthTypeDateRange() {
            const startDate = document.getElementById('growthTypeStartDate').value;
            const endDate = document.getElementById('growthTypeEndDate').value;

            if (!startDate || !endDate) {
                showToast('시작일과 종료일을 모두 선택해주세요.', 'error');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                showToast('시작일이 종료일보다 늦을 수 없습니다.', 'error');
                return;
            }

            // 글로벌 날짜 범위 업데이트 (모든 차트 자동 업데이트)
            globalDateRange.set(startDate, endDate);
        }

        async function applyCompetitorPromoDateRange() {
            const startDate = document.getElementById('competitorPromoStartDate').value;
            const endDate = document.getElementById('competitorPromoEndDate').value;

            if (!startDate || !endDate) {
                showToast('시작일과 종료일을 모두 선택해주세요.', 'error');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                showToast('시작일이 종료일보다 늦을 수 없습니다.', 'error');
                return;
            }

            // 글로벌 날짜 범위 업데이트 (모든 차트 자동 업데이트)
            globalDateRange.set(startDate, endDate);
        }

        // Product View 초기화 시 날짜 범위 기본값 설정 (글로벌 날짜 범위 사용)
        function initProductDateRange() {
            const { startDate, endDate } = globalDateRange.get();

            const startInput = document.getElementById('productStartDate');
            const endInput = document.getElementById('productEndDate');

            if (startInput && endInput) {
                startInput.value = startDate;
                endInput.value = endDate;
            }
        }

        // Initialize all chart date ranges (글로벌 날짜 범위 사용)
        function initAllChartDateRanges() {
            const { startDate, endDate } = globalDateRange.get();

            // Rank Trend chart
            const rankStartInput = document.getElementById('rankTrendStartDate');
            const rankEndInput = document.getElementById('rankTrendEndDate');
            if (rankStartInput && rankEndInput) {
                rankStartInput.value = startDate;
                rankEndInput.value = endDate;
            }

            // Matrix chart
            const matrixStartInput = document.getElementById('matrixStartDate');
            const matrixEndInput = document.getElementById('matrixEndDate');
            if (matrixStartInput && matrixEndInput) {
                matrixStartInput.value = startDate;
                matrixEndInput.value = endDate;
            }

            // Discount chart
            const discountStartInput = document.getElementById('discountStartDate');
            const discountEndInput = document.getElementById('discountEndDate');
            if (discountStartInput && discountEndInput) {
                discountStartInput.value = startDate;
                discountEndInput.value = endDate;
            }

            // 제품 선택 드롭다운 변경 시 차트 업데이트
            const discountProductSelect = document.getElementById('discountProductSelect');
            if (discountProductSelect) {
                discountProductSelect.addEventListener('change', () => {
                    applyDiscountDateRange();
                });
            }

            // Growth Type
            const growthStartInput = document.getElementById('growthTypeStartDate');
            const growthEndInput = document.getElementById('growthTypeEndDate');
            if (growthStartInput && growthEndInput) {
                growthStartInput.value = startDate;
                growthEndInput.value = endDate;
            }

            // 성장 유형 제품 선택 드롭다운 변경 시 업데이트
            const growthTypeProductSelect = document.getElementById('growthTypeProductSelect');
            if (growthTypeProductSelect) {
                growthTypeProductSelect.addEventListener('change', () => {
                    applyGrowthTypeDateRange();
                });
            }

            // Competitor Promo
            const compStartInput = document.getElementById('competitorPromoStartDate');
            const compEndInput = document.getElementById('competitorPromoEndDate');
            if (compStartInput && compEndInput) {
                compStartInput.value = startDate;
                compEndInput.value = endDate;
            }

            // 경쟁사 프로모션 제품 선택 드롭다운 변경 시 테이블 업데이트
            const competitorProductSelect = document.getElementById('competitorProductSelect');
            if (competitorProductSelect) {
                competitorProductSelect.addEventListener('change', () => {
                    applyCompetitorPromoDateRange();
                });
            }
        }

        // 프로모션 데이터 뷰 업데이트
        function updatePromoViews() {
            if (!dashboardData || !dashboardData.charts) return;

            const charts = dashboardData.charts;

            // 성장 유형 분류 업데이트
            if (charts.growth_type_summary) {
                const organic = charts.growth_type_summary.organic || 0;
                const discountBased = charts.growth_type_summary.discount_based || 0;
                document.getElementById('organic-count').textContent = organic + '개';
                document.getElementById('discount-count').textContent = discountBased + '개';
            }

            // 경쟁사 프로모션 비교 테이블 업데이트
            if (charts.competitor_promo && charts.competitor_promo.length > 0) {
                const tbody = document.getElementById('competitor-promo-tbody');
                tbody.innerHTML = '';

                charts.competitor_promo.forEach(comp => {
                    const row = document.createElement('tr');
                    if (comp.is_laneige) row.classList.add('is-laneige');

                    const brandClass = comp.is_laneige ? 'brand-name laneige' : 'brand-name';
                    const discountDisplay = comp.avg_discount > 0 ? comp.avg_discount + '%' : '-';

                    // Add discount badge if significant discount
                    const discountBadge = comp.avg_discount > 15 ?
                        `<span class="discount-badge" style="font-size: 9px; padding: 2px 6px; margin-left: 4px;">🔥</span>` : '';

                    row.innerHTML = `
                        <td class="${brandClass}" title="${comp.brand}">${comp.brand.substring(0, 12)}</td>
                        <td class="num-cell">${comp.product_count}</td>
                        <td class="num-cell discount-cell">${discountDisplay}${discountBadge}</td>
                        <td class="num-cell">${comp.coupon_count}${comp.coupon_count > 0 ? ' 🎟️' : ''}</td>
                        <td class="num-cell">${comp.deal_count}${comp.deal_count > 0 ? ' ⚡' : ''}</td>
                        <td class="num-cell">${comp.sns_count}</td>
                    `;
                    tbody.appendChild(row);
                });
            }

            // 할인율 추이 차트 업데이트
            if (charts.discount_trend && charts.discount_trend.labels) {
                updateDiscountTrendChart(charts.discount_trend);
            }
        }

        // 할인율 추이 차트 업데이트
        function updateDiscountTrendChart(discountData) {
            const ctx = document.getElementById('discountTrendChart');
            if (!ctx) return;

            // 기존 차트 제거
            if (window.discountChart) {
                window.discountChart.destroy();
            }

            // 현재 할인율 배지 업데이트
            const latestDiscount = discountData.data[discountData.data.length - 1] || 0;
            document.getElementById('discount-badge').textContent = `현재 할인율: ${latestDiscount}%`;

            window.discountChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: discountData.labels,
                    datasets: [{
                        label: '평균 할인율',
                        data: discountData.data,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#ef4444',
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 50,
                            title: {
                                display: true,
                                text: '할인율 (%)'
                            }
                        }
                    }
                }
            });

            // 인사이트 업데이트
            const trend = latestDiscount > discountData.data[0] ? '상승' : latestDiscount < discountData.data[0] ? '하락' : '유지';
            document.getElementById('discount-insight').textContent = `추세: ${trend}`;
        }

        // API 서버 주소 (배포 환경에서는 현재 호스트 사용, 로컬에서는 localhost:8001)
        const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:8001'
            : window.location.origin;

        // XSS 방지를 위한 HTML 이스케이프 함수
        function escapeHtml(text) {
            if (typeof text !== 'string') return text;
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 서버 연결 상태 관리
        let serverConnected = false;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 30;

        // 서버 상태 체크 및 자동 재연결
        async function checkServerStatus() {
            try {
                const response = await fetch(`${API_BASE}/`, {
                    method: 'GET',
                    signal: AbortSignal.timeout(2000)
                });
                if (response.ok) {
                    if (!serverConnected) {
                        serverConnected = true;
                        reconnectAttempts = 0;
                        showServerStatus('connected');
                        console.log('✅ 서버 연결됨');
                    }
                    return true;
                }
            } catch (e) {
                if (serverConnected) {
                    serverConnected = false;
                    showServerStatus('disconnected');
                }
            }
            return false;
        }

        // 서버 연결 상태 UI 표시
        function showServerStatus(status) {
            let statusEl = document.getElementById('serverStatus');
            if (!statusEl) {
                statusEl = document.createElement('div');
                statusEl.id = 'serverStatus';
                statusEl.style.cssText = 'position:fixed;top:10px;left:50%;transform:translateX(-50%);padding:8px 16px;border-radius:20px;font-size:12px;font-weight:500;z-index:9999;transition:all 0.3s;display:flex;align-items:center;gap:8px;';
                document.body.appendChild(statusEl);
            }

            // file:// 프로토콜로 열린 경우 서버 URL로 이동 안내
            if (window.location.protocol === 'file:') {
                statusEl.style.background = 'linear-gradient(135deg, #3b82f6, #1d4ed8)';
                statusEl.style.color = 'white';
                statusEl.style.opacity = '1';
                statusEl.style.cursor = 'pointer';
                statusEl.innerHTML = '🔗 서버 대시보드로 이동하기 (클릭)';
                statusEl.onclick = () => { window.location.href = 'http://localhost:8001/dashboard'; };
                return;
            }

            if (status === 'connected') {
                statusEl.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                statusEl.style.color = 'white';
                statusEl.innerHTML = '<span style="width:8px;height:8px;background:#fff;border-radius:50%;animation:pulse 1s infinite;"></span> API 서버 연결됨';
                setTimeout(() => { statusEl.style.opacity = '0'; }, 3000);
            } else if (status === 'disconnected') {
                statusEl.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
                statusEl.style.color = 'white';
                statusEl.style.opacity = '1';
                statusEl.innerHTML = '<span style="width:8px;height:8px;background:#fff;border-radius:50%;"></span> 서버 연결 중... (자동 재연결)';
            } else if (status === 'failed') {
                statusEl.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                statusEl.style.color = 'white';
                statusEl.style.opacity = '1';
                statusEl.style.cursor = 'pointer';
                statusEl.innerHTML = '❌ 서버 연결 실패 - 클릭하여 서버 대시보드로 이동';
                statusEl.onclick = () => { window.location.href = 'http://localhost:8001/dashboard'; };
            }
        }

        // 자동 재연결 루프
        async function autoReconnect() {
            if (serverConnected) return;

            reconnectAttempts++;
            const connected = await checkServerStatus();

            if (!connected && reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                // 2초마다 재시도
                setTimeout(autoReconnect, 2000);
            } else if (!connected) {
                showServerStatus('failed');
            }
        }

        // 페이지 로드 시 서버 연결 확인 및 초기화
        document.addEventListener('DOMContentLoaded', async () => {
            const connected = await checkServerStatus();
            if (!connected) {
                showServerStatus('disconnected');
                autoReconnect();
            }

            // Product View 날짜 범위 초기화
            initProductDateRange();
            initAllChartDateRanges();
            // Category View 날짜 범위 초기화
            initCategoryDateRange();
            // SoS 추이 차트 날짜 범위 초기화
            initSosTrendDateRange();

            // 글로벌 날짜 범위 변경 이벤트 리스너 등록
            registerGlobalDateRangeListeners();
        });

        // ===== 글로벌 날짜 범위 변경 이벤트 리스너 등록 =====
        function registerGlobalDateRangeListeners() {
            console.log('[GlobalDateRange] Registering event listeners');

            // dateRangeChanged 이벤트 리스너 - 모든 차트 업데이트
            document.addEventListener('dateRangeChanged', async (e) => {
                const { startDate, endDate } = e.detail;
                console.log('[GlobalDateRange] dateRangeChanged received:', startDate, '~', endDate);

                // 모든 날짜 입력창 동기화
                syncAllDateInputsToGlobal();

                // 현재 페이지에 따라 관련 차트 업데이트
                showToast('날짜 범위가 변경되었습니다. 차트 업데이트 중...', 'info');

                try {
                    // 병렬로 모든 차트 업데이트
                    await Promise.allSettled([
                        updateSosTrendWithGlobalRange(startDate, endDate),
                        updateCpiChartWithGlobalRange(startDate, endDate),
                        updateRankTrendWithGlobalRange(startDate, endDate),
                        updateBrandMatrixWithGlobalRange(startDate, endDate),
                        updateDiscountTrendWithGlobalRange(startDate, endDate)
                    ]);

                    showToast(`${startDate} ~ ${endDate} 기간 데이터가 적용되었습니다.`, 'success');
                } catch (error) {
                    console.error('[GlobalDateRange] Error updating charts:', error);
                    showToast('일부 차트 업데이트에 실패했습니다.', 'error');
                }
            });
        }

        // ===== 글로벌 날짜 범위로 각 차트 업데이트 함수들 =====

        // SoS 추이 차트 업데이트
        async function updateSosTrendWithGlobalRange(startDate, endDate) {
            try {
                const response = await fetch(`/api/sos/trend?start_date=${startDate}&end_date=${endDate}&brand=LANEIGE`);
                const result = await response.json();

                if (result.success && charts.trend) {
                    const trendData = result.trend || [];
                    charts.trend.data.labels = trendData.map(d => {
                        const date = new Date(d.date);
                        return `${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                    });
                    charts.trend.data.datasets[0].data = trendData.map(d => d.sos);
                    charts.trend.update('none');
                    console.log('[GlobalDateRange] SoS trend chart updated');
                }
            } catch (error) {
                console.error('[GlobalDateRange] Failed to update SoS trend:', error);
            }
        }

        // CPI 차트 업데이트
        async function updateCpiChartWithGlobalRange(startDate, endDate) {
            try {
                // 기존 함수 호출
                if (typeof updateCpiChartWithProducts === 'function') {
                    await updateCpiChartWithProducts(startDate, endDate);
                    console.log('[GlobalDateRange] CPI chart updated');
                }
            } catch (error) {
                console.error('[GlobalDateRange] Failed to update CPI chart:', error);
            }
        }

        // 제품 순위 추이 차트 업데이트
        async function updateRankTrendWithGlobalRange(startDate, endDate) {
            try {
                const days = Math.ceil((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24)) + 1;
                if (typeof updateProductRankTrendChart === 'function') {
                    await updateProductRankTrendChart(startDate, endDate, days);
                    console.log('[GlobalDateRange] Rank trend chart updated');
                }
            } catch (error) {
                console.error('[GlobalDateRange] Failed to update rank trend:', error);
            }
        }

        // 브랜드 매트릭스 차트 업데이트
        async function updateBrandMatrixWithGlobalRange(startDate, endDate) {
            try {
                const days = Math.ceil((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24)) + 1;
                if (typeof updateProductMatrixChart === 'function') {
                    await updateProductMatrixChart(startDate, endDate, days);
                    console.log('[GlobalDateRange] Brand matrix chart updated');
                }
            } catch (error) {
                console.error('[GlobalDateRange] Failed to update brand matrix:', error);
            }
        }

        // 할인율 추이 차트 업데이트
        async function updateDiscountTrendWithGlobalRange(startDate, endDate) {
            try {
                const days = Math.ceil((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24)) + 1;
                if (typeof updateDiscountTrendChartWithRange === 'function') {
                    await updateDiscountTrendChartWithRange(startDate, endDate, days);
                    console.log('[GlobalDateRange] Discount trend chart updated');
                }
            } catch (error) {
                console.error('[GlobalDateRange] Failed to update discount trend:', error);
            }
        }

        // ===== 글로벌 날짜 범위 적용 버튼 핸들러 =====
        // 이 함수를 개별 차트의 "적용" 버튼에서 호출하면 글로벌 범위도 함께 업데이트됨
        function applyGlobalDateRange(startInputId, endInputId) {
            const startInput = document.getElementById(startInputId);
            const endInput = document.getElementById(endInputId);

            if (!startInput || !endInput) return false;

            const startDate = startInput.value;
            const endDate = endInput.value;

            if (!startDate || !endDate) {
                showToast('시작일과 종료일을 모두 선택해주세요.', 'error');
                return false;
            }

            if (new Date(startDate) > new Date(endDate)) {
                showToast('시작일이 종료일보다 늦을 수 없습니다.', 'error');
                return false;
            }

            // 글로벌 날짜 범위 업데이트 (이벤트 자동 발송됨)
            return globalDateRange.set(startDate, endDate);
        }

        // CSS 애니메이션 추가
        const pulseStyle = document.createElement('style');
        pulseStyle.textContent = '@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }';
        document.head.appendChild(pulseStyle);

        function toggleChatbot() {
            chatbotOpen = !chatbotOpen;
            document.getElementById('chatbotPanel').classList.toggle('open', chatbotOpen);
            document.getElementById('chatFab').classList.toggle('hidden', chatbotOpen);
            // 태블릿/모바일에서 오버레이 토글
            const overlay = document.querySelector('.chatbot-overlay');
            if (overlay) {
                overlay.classList.toggle('active', chatbotOpen);
            }
            if (chatbotOpen) {
                lucide.createIcons();
            }
        }

        // ===== 모바일 사이드바 토글 =====
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            sidebar.classList.toggle('open');
            if (overlay) {
                overlay.classList.toggle('active');
            }
        }

        // ===== 추천 질문 접기/펼치기 =====
        function toggleSuggestions() {
            const container = document.getElementById('chatSuggestions');
            container.classList.toggle('collapsed');
        }

        // ===== 챗봇 패널 크기 조절 (드래그) =====
        (function initChatResize() {
            const panel = document.getElementById('chatbotPanel');
            const handle = document.getElementById('chatResizeHandle');
            let isResizing = false;
            let startX, startWidth;

            handle.addEventListener('mousedown', (e) => {
                isResizing = true;
                startX = e.clientX;
                startWidth = panel.offsetWidth;
                panel.classList.add('resizing');
                handle.classList.add('active');
                document.body.style.cursor = 'ew-resize';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                // 왼쪽으로 드래그 = 너비 증가
                const diff = startX - e.clientX;
                const newWidth = Math.min(600, Math.max(320, startWidth + diff));
                panel.style.width = newWidth + 'px';
            });

            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    panel.classList.remove('resizing');
                    handle.classList.remove('active');
                    document.body.style.cursor = '';
                }
            });
        })();

        // 챗봇 메시지 전송 - LLM Orchestrator v2 API 연동
        async function sendChatMessage(msg) {
            const chatBody = document.getElementById('chatBody');

            // 사용자 메시지 표시 (XSS 방지)
            chatBody.innerHTML += `<div class="chat-message user"><div class="bubble">${escapeHtml(msg)}</div></div>`;
            chatBody.innerHTML += `<div class="chat-message bot" id="typing"><div class="typing-indicator"><span></span><span></span><span></span></div></div>`;
            chatBody.scrollTop = chatBody.scrollHeight;

            try {
                // v3 API 호출 (Simple LLM Chat)
                const response = await fetch(`${API_BASE}/api/v3/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: msg })
                });

                // 타이핑 인디케이터 제거
                const typingEl = document.getElementById('typing');
                if (typingEl) typingEl.remove();

                if (response.ok) {
                    const data = await response.json();

                    // 크롤링 시작 감지 시 폴링 시작
                    if (data.text.includes('백그라운드에서 오늘 데이터 수집')) {
                        startCrawlStatusPolling();
                    }

                    // 응답 표시 (마크다운 변환)
                    let formattedResponse = data.text
                        .replace(/\n/g, '<br>')
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*(.*?)\*/g, '<em>$1</em>');

                    // 사용된 도구 표시 (있으면)
                    if (data.tools_used && data.tools_used.length > 0) {
                        const toolBadges = data.tools_used.map(t =>
                            `<span style="background:#e0f2fe;color:#0369a1;padding:2px 6px;border-radius:4px;font-size:9px;">🔧 ${t}</span>`
                        ).join(' ');
                        formattedResponse = toolBadges + '<br><br>' + formattedResponse;
                    }

                    // AI 출처 표기 추가
                    const sourceCitation = renderSourceCitation(data.sources);
                    formattedResponse += sourceCitation;

                    chatBody.innerHTML += `<div class="chat-message bot"><div class="bubble">${formattedResponse}</div></div>`;

                    // 후속 질문 제안 업데이트
                    updateSuggestions(data.suggestions);
                } else {
                    throw new Error('API 응답 오류');
                }
            } catch (error) {
                console.error('Chat API error:', error);

                // 타이핑 인디케이터 제거
                const typingEl = document.getElementById('typing');
                if (typingEl) typingEl.remove();

                // 폴백 응답 (API 연결 실패 시) - 자동 재연결 시도
                let res = `<strong>💡 안내:</strong><br><br>현재 API 서버에 연결할 수 없습니다.<br><br>`;

                if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                    res += `<span style="color:#f59e0b;">🔄 자동 재연결 시도 중... (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})</span><br><br>`;
                    res += `<button onclick="retryLastMessage('${msg.replace(/'/g, "\\'")}')" style="background:#3b82f6;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;margin-right:8px;">🔁 재시도</button>`;
                    // 재연결 시도
                    if (!serverConnected) autoReconnect();
                } else {
                    res += `서버 실행 명령:<br><code>python dashboard_api.py</code><br><br>`;
                    res += `<button onclick="location.reload()" style="background:#10b981;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;">🔄 페이지 새로고침</button>`;
                }

                chatBody.innerHTML += `<div class="chat-message bot"><div class="bubble">${res}</div></div>`;
            }

            chatBody.scrollTop = chatBody.scrollHeight;
        }

        // AI 출처 표기 렌더링
        function renderSourceCitation(sources) {
            if (!sources || sources.length === 0) {
                // 기본 AI 출처 표기
                return `<div class="ai-source-citation">
                    <div class="source-header" onclick="this.parentElement.classList.toggle('expanded')">
                        <span class="source-toggle">▶</span>
                        <span class="source-label">🤖 AI 분석 결과</span>
                    </div>
                    <div class="source-details">
                        <div class="source-item">
                            <span class="source-icon">🤖</span>
                            <span class="source-text">AI 모델: GPT-4.1-mini</span>
                        </div>
                        <div class="source-disclaimer">※ AI가 생성한 분석 결과입니다. 중요한 의사결정 시 추가 검증을 권장합니다.</div>
                    </div>
                </div>`;
            }

            let sourceItems = sources.map(src => {
                const icon = src.icon || '📄';
                const name = src.name || 'Unknown';
                const desc = src.description || '';
                return `<div class="source-item">
                    <span class="source-icon">${icon}</span>
                    <span class="source-text"><strong>${name}</strong>${desc ? ' - ' + desc : ''}</span>
                </div>`;
            }).join('');

            // 면책조항 찾기
            const aiSource = sources.find(s => s.type === 'ai_model');
            const disclaimer = aiSource?.disclaimer || 'AI가 생성한 분석 결과입니다.';

            return `<div class="ai-source-citation">
                <div class="source-header" onclick="this.parentElement.classList.toggle('expanded')">
                    <span class="source-toggle">▶</span>
                    <span class="source-label">📋 출처 (${sources.length}개)</span>
                </div>
                <div class="source-details">
                    ${sourceItems}
                    <div class="source-disclaimer">※ ${disclaimer}</div>
                </div>
            </div>`;
        }

        // 후속 질문 제안 업데이트 (XSS 방지)
        function updateSuggestions(suggestions) {
            const chipsContainer = document.querySelector('.suggestion-chips');
            if (!chipsContainer || !suggestions) return;

            // 기존 칩 제거
            chipsContainer.innerHTML = '';

            // 안전하게 이벤트 리스너 방식으로 추가
            suggestions.forEach(s => {
                const chip = document.createElement('div');
                chip.className = 'suggestion-chip';
                chip.textContent = s;  // textContent 사용으로 XSS 방지
                chip.addEventListener('click', () => sendChatMessage(s));
                chipsContainer.appendChild(chip);
            });
        }

        // 마지막 메시지 재시도
        function retryLastMessage(msg) {
            // 마지막 에러 메시지 제거
            const chatBody = document.getElementById('chatBody');
            const lastBotMsg = chatBody.querySelector('.chat-message.bot:last-child');
            if (lastBotMsg) lastBotMsg.remove();
            // 재전송
            sendChatMessage(msg);
        }

        function sendChatFromInput() { const input = document.getElementById('chatInput'); if (input.value.trim()) { sendChatMessage(input.value); input.value = ''; } }
        function handleChatKeypress(e) { if (e.key === 'Enter') sendChatFromInput(); }
        function openAIDrawer() { document.getElementById('aiDrawer').classList.add('open'); }
        function closeAIDrawer() { document.getElementById('aiDrawer').classList.remove('open'); }

        // AI Strategy Report 복사 기능
        async function copyStrategyReport() {
            const drawerContent = document.querySelector('.drawer-content');
            if (!drawerContent) {
                alert('❌ 복사할 내용이 없습니다.');
                return;
            }

            // 리포트 텍스트 추출
            const sections = drawerContent.querySelectorAll('.insight-section');
            let reportText = '📊 AI Strategy Report - Laneige Amazon US Analysis\n';
            reportText += '=' .repeat(50) + '\n\n';

            sections.forEach(section => {
                const header = section.querySelector('.insight-section-header h4');
                const content = section.querySelector('.insight-box, .inference-path');

                if (header) {
                    reportText += `▶ ${header.textContent}\n`;
                }

                if (content) {
                    // HTML을 텍스트로 변환 (br -> 줄바꿈, 태그 제거)
                    let text = content.innerHTML
                        .replace(/<br\s*\/?>/gi, '\n')
                        .replace(/<strong>(.*?)<\/strong>/gi, '**$1**')
                        .replace(/<em>(.*?)<\/em>/gi, '"$1"')
                        .replace(/<[^>]+>/g, '')
                        .replace(/&nbsp;/g, ' ')
                        .trim();
                    reportText += text + '\n\n';
                }
            });

            reportText += '-'.repeat(50) + '\n';
            reportText += `📅 Generated: ${new Date().toLocaleString('ko-KR')}\n`;
            reportText += '🤖 AMORE INSIGHT AI Intelligence v2.0';

            try {
                await navigator.clipboard.writeText(reportText);

                // 버튼 피드백
                const btn = document.querySelector('.drawer-btn.secondary');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i data-lucide="check" style="width: 16px; height: 16px;"></i>복사됨!';
                btn.style.background = '#10b981';
                btn.style.color = 'white';

                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.style.background = '';
                    btn.style.color = '';
                    lucide.createIcons();
                }, 2000);

            } catch (err) {
                // Fallback: 구형 브라우저 지원
                const textArea = document.createElement('textarea');
                textArea.value = reportText;
                textArea.style.position = 'fixed';
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('✅ 리포트가 클립보드에 복사되었습니다!');
            }
        }

        // AI Strategy Report 공유 기능
        async function shareStrategyReport() {
            const drawerContent = document.querySelector('.drawer-content');
            if (!drawerContent) {
                alert('❌ 공유할 내용이 없습니다.');
                return;
            }

            // 리포트 요약 텍스트 생성
            const summaryBox = drawerContent.querySelector('.insight-box');
            const summary = summaryBox ? summaryBox.textContent.trim() : 'Laneige Amazon US 전략 분석 리포트';

            const reportTitle = 'AMORE INSIGHT - AI Strategy Report';
            const reportDate = new Date().toLocaleDateString('ko-KR');

            // Web Share API 지원 확인
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: reportTitle,
                        text: `📊 ${reportTitle}\n\n${summary}\n\n📅 ${reportDate}`,
                        url: window.location.href
                    });
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        // 사용자가 취소한 게 아니면 이메일 폴백
                        openEmailShare(reportTitle, summary);
                    }
                }
            } else {
                // Web Share API 미지원 시 이메일로 공유
                openEmailShare(reportTitle, summary);
            }
        }

        // 이메일 공유 (폴백)
        function openEmailShare(title, content) {
            const subject = encodeURIComponent(title);
            const body = encodeURIComponent(
                `📊 AI Strategy Report - Laneige Amazon US Analysis\n\n` +
                `${content}\n\n` +
                `-`.repeat(40) + `\n` +
                `📅 생성일: ${new Date().toLocaleString('ko-KR')}\n` +
                `🔗 대시보드: ${window.location.href}\n\n` +
                `🤖 AMORE INSIGHT AI Intelligence v2.0`
            );

            window.open(`mailto:?subject=${subject}&body=${body}`, '_blank');

            // 버튼 피드백
            const btn = document.querySelector('.drawer-btn.primary');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i data-lucide="check" style="width: 16px; height: 16px;"></i>메일 열림!';

            setTimeout(() => {
                btn.innerHTML = originalHTML;
                lucide.createIcons();
            }, 2000);
        }
        function openExportModal() {
            document.getElementById('exportModal').classList.add('open');
            // 글로벌 날짜 범위 사용
            const { startDate, endDate } = globalDateRange.get();
            document.getElementById('exportEndDate').value = endDate;
            document.getElementById('exportStartDate').value = startDate;
        }
        function closeExportModal() { document.getElementById('exportModal').classList.remove('open'); }

        // DOCX/Excel 내보내기 - 백엔드 API 연동
        async function executeExport() {
            const exportBtn = document.querySelector('.modal-btn.confirm');
            const originalText = exportBtn.textContent;
            exportBtn.textContent = '⏳ 생성 중...';
            exportBtn.disabled = true;

            try {
                // 선택된 형식 확인
                const formatRadio = document.querySelector('input[name="exportFormat"]:checked');
                const format = formatRadio ? formatRadio.value : 'docx';

                // 날짜 값 가져오기
                const startDate = document.getElementById('exportStartDate').value;
                const endDate = document.getElementById('exportEndDate').value;

                let response;
                let filename;

                if (format === 'excel') {
                    // Excel 내보내기
                    response = await fetch(`${API_BASE}/api/export/excel`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            start_date: startDate || null,
                            end_date: endDate || null,
                            include_metrics: true
                        })
                    });
                    filename = `AMORE_Data_${new Date().toISOString().slice(0,10)}.xlsx`;
                } else {
                    // DOCX 내보내기
                    response = await fetch(`${API_BASE}/api/export/docx`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            include_strategy: true
                        })
                    });
                    filename = `AMORE_Insight_Report_${new Date().toISOString().slice(0,10)}.docx`;
                }

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error || 'Export failed');
                }

                // 파일 다운로드
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // 성공 알림
                closeExportModal();
                alert(`✅ ${format === 'excel' ? 'Excel' : 'DOCX'} 파일이 다운로드되었습니다.`);

            } catch (error) {
                console.error('Export error:', error);
                alert(`❌ 내보내기 실패: ${error.message}`);
            } finally {
                exportBtn.textContent = originalText;
                exportBtn.disabled = false;
            }
        }

        // ============== SoS 차트 관련 함수들 ==============

        // SoS 차트 전역 변수
        let sosChartInstance = null;
        let sosBrandsData = [];

        // 날짜 필터 초기화 (글로벌 날짜 범위 사용)
        function initSosDateFilters() {
            let { startDate, endDate } = globalDateRange.get();

            // globalDateRange가 아직 초기화되지 않은 경우 fallback
            if (!startDate || !endDate) {
                console.warn('[initSosDateFilters] globalDateRange not initialized, using fallback');
                // dashboardData에서 가져오기 시도
                if (dashboardData?.charts?.sos_trend?.['30d']?.labels) {
                    const labels = dashboardData.charts.sos_trend['30d'].labels;
                    if (labels.length > 0) {
                        // MM-DD 형식을 YYYY-MM-DD로 변환
                        const year = new Date().getFullYear();
                        endDate = `${year}-${labels[labels.length - 1].replace('/', '-')}`;
                        startDate = `${year}-${labels[0].replace('/', '-')}`;
                    }
                }
                // 그래도 없으면 최근 14일
                if (!startDate || !endDate) {
                    const today = new Date();
                    endDate = today.toISOString().split('T')[0];
                    const start = new Date(today);
                    start.setDate(start.getDate() - 13);
                    startDate = start.toISOString().split('T')[0];
                }
                console.log('[initSosDateFilters] Fallback dates:', startDate, '~', endDate);
            }

            const sosEndInput = document.getElementById('sosEndDate');
            const sosStartInput = document.getElementById('sosStartDate');
            if (sosEndInput && sosStartInput) {
                sosEndInput.value = endDate;
                sosStartInput.value = startDate;
                console.log('[initSosDateFilters] Set dates:', startDate, '~', endDate);
            }
        }

        // 선택된 브랜드 저장
        let selectedCompareBrands = [];

        // 비교 브랜드 드롭다운 로드
        async function loadSosBrands() {
            try {
                const response = await fetch('/api/sos/brands?min_count=2');
                const data = await response.json();

                if (data.success && data.brands) {
                    sosBrandsData = data.brands.filter(b => !b.is_laneige);
                    renderBrandCheckboxList();
                }
            } catch (error) {
                console.error('Failed to load brands:', error);
            }
        }

        // 브랜드 체크박스 목록 렌더링
        function renderBrandCheckboxList(filter = '') {
            const container = document.getElementById('brandCheckboxList');
            if (!container) return;

            const filtered = sosBrandsData
                .filter(b => !filter || b.name.toLowerCase().includes(filter.toLowerCase()))
                .slice(0, 30);

            container.innerHTML = filtered.map(b => `
                <label style="display: flex; align-items: center; gap: 8px; padding: 6px 4px; cursor: pointer; font-size: 12px; border-radius: 4px; transition: background 0.15s;"
                       onmouseover="this.style.background='var(--bg-subtle)'" onmouseout="this.style.background='transparent'">
                    <input type="checkbox" value="${b.name}" onchange="toggleBrandSelection('${b.name}')"
                           ${selectedCompareBrands.includes(b.name) ? 'checked' : ''}
                           style="margin: 0;">
                    <span>${b.name}</span>
                    <span style="color: var(--text-secondary); margin-left: auto;">${b.product_count}개</span>
                </label>
            `).join('');
        }

        // 브랜드 선택 토글
        function toggleBrandSelection(brandName) {
            const idx = selectedCompareBrands.indexOf(brandName);
            if (idx > -1) {
                selectedCompareBrands.splice(idx, 1);
            } else {
                if (selectedCompareBrands.length < 5) {  // 최대 5개
                    selectedCompareBrands.push(brandName);
                } else {
                    alert('최대 5개까지 선택 가능합니다.');
                    renderBrandCheckboxList(document.getElementById('brandSearchInput')?.value || '');
                    return;
                }
            }
            updateSelectedBrandTags();
            updateBrandDropdownLabel();
        }

        // 선택된 브랜드 태그 업데이트
        function updateSelectedBrandTags() {
            const container = document.getElementById('selectedBrandTags');
            if (!container) return;

            container.innerHTML = selectedCompareBrands.map(brand => `
                <span style="display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; background: var(--amore-blue); color: white; border-radius: 12px; font-size: 10px;">
                    ${brand.length > 10 ? brand.substring(0, 10) + '...' : brand}
                    <span onclick="removeBrandSelection('${brand}')" style="cursor: pointer; font-weight: bold;">×</span>
                </span>
            `).join('');
        }

        // 브랜드 선택 제거
        function removeBrandSelection(brandName) {
            const idx = selectedCompareBrands.indexOf(brandName);
            if (idx > -1) {
                selectedCompareBrands.splice(idx, 1);
                updateSelectedBrandTags();
                updateBrandDropdownLabel();
                renderBrandCheckboxList(document.getElementById('brandSearchInput')?.value || '');
            }
        }

        // 드롭다운 라벨 업데이트
        function updateBrandDropdownLabel() {
            const label = document.getElementById('brandDropdownLabel');
            if (label) {
                label.textContent = selectedCompareBrands.length > 0
                    ? `${selectedCompareBrands.length}개 선택됨`
                    : '브랜드 선택';
            }
        }

        // 드롭다운 토글
        function toggleBrandDropdown() {
            const menu = document.getElementById('brandDropdownMenu');
            if (menu) {
                menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
            }
        }

        // 카테고리 트리 토글 함수
        function toggleCategoryTree(nodeElement) {
            const toggleIcon = nodeElement.querySelector('.category-tree-toggle');
            const parentItem = nodeElement.closest('.category-tree-item');
            const childrenContainer = parentItem.querySelector('.category-tree-children');

            if (childrenContainer) {
                const isExpanded = childrenContainer.classList.contains('expanded');
                childrenContainer.classList.toggle('expanded');
                toggleIcon.classList.toggle('expanded');
            }
        }

        // 브랜드 목록 필터링
        function filterBrandList() {
            const input = document.getElementById('brandSearchInput');
            renderBrandCheckboxList(input?.value || '');
        }

        // 드롭다운 외부 클릭 시 닫기
        document.addEventListener('click', function(e) {
            const container = document.querySelector('.brand-dropdown-container');
            const menu = document.getElementById('brandDropdownMenu');
            if (container && menu && !container.contains(e.target)) {
                menu.style.display = 'none';
            }
        });

        // SoS 차트 툴팁 호버 이벤트
        document.addEventListener('DOMContentLoaded', function() {
            const sosTooltipTrigger = document.getElementById('sosChartHelpIcon');
            const sosTooltip = document.getElementById('sosChartTooltip');
            if (sosTooltipTrigger && sosTooltip) {
                sosTooltipTrigger.addEventListener('mouseenter', () => sosTooltip.style.display = 'block');
                sosTooltipTrigger.addEventListener('mouseleave', () => sosTooltip.style.display = 'none');
            }
        });

        // SoS 막대그래프 초기화
        function initSosBarChart(colors, chartColors, brandColors) {
            // 초기 차트 생성 (빈 데이터)
            const ctx = document.getElementById('sosChart').getContext('2d');

            sosChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',  // 수평 막대그래프
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { font: { size: 11 }, padding: 10, usePointStyle: true }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw.toFixed(1)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            min: 0,
                            max: 15,  // 동적으로 업데이트됨
                            ticks: {
                                stepSize: 2.5,
                                callback: function(value) { return value + '%'; }
                            },
                            title: { display: true, text: '시장점유율 (%)', font: { size: 11 } },
                            grid: { color: 'rgba(0, 28, 88, 0.06)' }
                        },
                        y: {
                            grid: { display: false }
                        }
                    }
                },
                plugins: [{
                    // 막대 끝에 값 표시
                    afterDatasetsDraw: function(chart) {
                        const ctx = chart.ctx;
                        chart.data.datasets.forEach((dataset, i) => {
                            if (dataset.type === 'line') return;  // 라인 차트는 제외
                            const meta = chart.getDatasetMeta(i);
                            meta.data.forEach((bar, index) => {
                                const value = dataset.data[index];
                                if (value > 0) {
                                    ctx.fillStyle = '#333';
                                    ctx.font = '10px Arial';
                                    ctx.textAlign = 'left';
                                    ctx.textBaseline = 'middle';
                                    ctx.fillText(value.toFixed(1) + '%', bar.x + 4, bar.y);
                                }
                            });
                        });
                    }
                }]
            });

            // 초기 데이터 로드
            updateSosChart();
        }

        // SoS 차트 업데이트 (API 호출)
        async function updateSosChart() {
            const startDate = document.getElementById('sosStartDate').value;
            const endDate = document.getElementById('sosEndDate').value;
            const selectedBrands = selectedCompareBrands.join(',');

            const noDataMsg = document.getElementById('sosNoDataMessage');
            const chartCanvas = document.getElementById('sosChart');

            try {
                let url = `/api/sos/category?start_date=${startDate}&end_date=${endDate}`;
                if (selectedBrands) {
                    url += `&compare_brands=${encodeURIComponent(selectedBrands)}`;
                }

                const response = await fetch(url);
                const result = await response.json();

                if (!result.success || !result.data || result.data.length === 0) {
                    // 데이터 없음 표시
                    chartCanvas.style.display = 'none';
                    noDataMsg.style.display = 'block';
                    return;
                }

                chartCanvas.style.display = 'block';
                noDataMsg.style.display = 'none';

                // 카테고리 라벨 (꺽쇠 없이 깔끔하게)
                const labels = result.data.map(d => d.category_name);

                // LANEIGE 데이터
                const laneigeSos = result.data.map(d => d.laneige_sos);

                // 평균 SoS 데이터
                const avgSos = result.data.map(d => d.avg_sos);

                // 데이터셋 구성
                const datasets = [
                    {
                        label: 'LANEIGE',
                        data: laneigeSos,
                        backgroundColor: '#1F5795',
                        borderColor: '#1F5795',
                        borderWidth: 1,
                        barPercentage: 0.6
                    },
                    {
                        label: '평균 (Top 100)',
                        data: avgSos,
                        backgroundColor: 'rgba(125, 125, 125, 0.3)',
                        borderColor: '#7D7D7D',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        type: 'line',
                        fill: false,
                        pointRadius: 0
                    }
                ];

                // 비교 브랜드 추가
                const compareBrandColors = ['#C4A962', '#4A7DB8', '#FF6B6B', '#4ECDC4', '#45B7D1'];
                if (result.compare_brands && result.compare_brands.length > 0) {
                    result.compare_brands.forEach((brand, idx) => {
                        const brandSos = result.data.map(d => d.compare_brands[brand] || 0);
                        datasets.push({
                            label: brand,
                            data: brandSos,
                            backgroundColor: compareBrandColors[idx % compareBrandColors.length],
                            borderColor: compareBrandColors[idx % compareBrandColors.length],
                            borderWidth: 1,
                            barPercentage: 0.6
                        });
                    });
                }

                // X축 최대값 동적 계산 (데이터 기반)
                const allValues = [...laneigeSos, ...avgSos];
                if (result.compare_brands && result.compare_brands.length > 0) {
                    result.compare_brands.forEach(brand => {
                        const brandSos = result.data.map(d => d.compare_brands[brand] || 0);
                        allValues.push(...brandSos);
                    });
                }
                const maxValue = Math.max(...allValues, 1);  // 최소 1%
                // 최대값을 5% 단위로 올림 (여유 공간 포함)
                const xMax = Math.ceil((maxValue * 1.3) / 5) * 5;  // 30% 여유 + 5% 단위 올림
                const adjustedMax = Math.max(xMax, 10);  // 최소 10%

                // 차트 업데이트
                sosChartInstance.data.labels = labels;
                sosChartInstance.data.datasets = datasets;
                sosChartInstance.options.scales.x.max = adjustedMax;
                sosChartInstance.options.scales.x.ticks.stepSize = adjustedMax / 5;  // 5등분

                sosChartInstance.update();

                // 카테고리별 상세 정보 표시 (계층적 트리 구조)
                const detailContent = document.getElementById('sosCategoryDetailContent');
                if (detailContent) {
                    // API 데이터를 카테고리별로 매핑
                    const categoryDataMap = {};
                    result.data.forEach(d => {
                        categoryDataMap[d.category_id] = d;
                    });

                    // 카테고리 계층 구조 정의 (category_hierarchy.json 기반)
                    const categoryHierarchy = {
                        beauty: {
                            name: 'Beauty & Personal Care',
                            level: 0,
                            children: ['skin_care', 'makeup']
                        },
                        skin_care: {
                            name: 'Skin Care',
                            level: 1,
                            parent: 'beauty',
                            children: ['lip_care']
                        },
                        lip_care: {
                            name: 'Lip Care',
                            level: 2,
                            parent: 'skin_care',
                            children: []
                        },
                        makeup: {
                            name: 'Makeup',
                            level: 1,
                            parent: 'beauty',
                            children: ['lip_makeup', 'face_makeup'],
                            isIntermediate: true  // 모니터링 안 함
                        },
                        lip_makeup: {
                            name: 'Lip Makeup',
                            level: 2,
                            parent: 'makeup',
                            children: []
                        },
                        face_makeup: {
                            name: 'Face Makeup',
                            level: 2,
                            parent: 'makeup',
                            children: ['face_powder'],
                            isIntermediate: true  // 모니터링 안 함
                        },
                        face_powder: {
                            name: 'Face Powder',
                            level: 3,
                            parent: 'face_makeup',
                            children: []
                        }
                    };

                    // 계층적 트리 렌더링 함수
                    function renderCategoryTree(categoryId, expanded = true) {
                        const cat = categoryHierarchy[categoryId];
                        if (!cat) return '';

                        const data = categoryDataMap[categoryId];
                        const hasLaneige = data && data.laneige_count > 0;
                        const hasChildren = cat.children && cat.children.length > 0;
                        const isIntermediate = cat.isIntermediate;

                        // 노드 클래스 결정
                        let nodeClass = 'category-tree-node';
                        if (isIntermediate) {
                            nodeClass += ' intermediate';
                        } else if (hasLaneige) {
                            nodeClass += ' has-laneige';
                        } else {
                            nodeClass += ' no-laneige';
                        }

                        // 통계 정보
                        let statsHtml = '';
                        if (data && !isIntermediate) {
                            statsHtml = `
                                <div class="category-tree-stats">
                                    <div class="category-tree-sos">${data.laneige_sos.toFixed(1)}%</div>
                                    <div class="category-tree-count">LANEIGE ${data.laneige_count}개</div>
                                </div>
                            `;
                        } else if (isIntermediate) {
                            statsHtml = '<div class="category-tree-stats" style="font-size: 10px; color: #999;">모니터링 안 함</div>';
                        }

                        // 자식 노드 렌더링
                        let childrenHtml = '';
                        if (hasChildren) {
                            const childNodes = cat.children.map(childId => renderCategoryTree(childId, false)).join('');
                            childrenHtml = `<div class="category-tree-children ${expanded ? 'expanded' : ''}">${childNodes}</div>`;
                        }

                        // 토글 아이콘
                        const toggleClass = hasChildren ? (expanded ? 'expanded' : '') : 'empty';
                        const toggleIcon = hasChildren ? '▶' : '';

                        return `
                            <div class="category-tree-item">
                                <div class="${nodeClass}" onclick="toggleCategoryTree(this)" data-category="${categoryId}">
                                    <div class="category-tree-toggle ${toggleClass}">${toggleIcon}</div>
                                    <div class="category-tree-content">
                                        <div>
                                            <span class="category-tree-name">${cat.name}</span>
                                            <span class="category-tree-level">L${cat.level}</span>
                                        </div>
                                        ${statsHtml}
                                    </div>
                                </div>
                                ${childrenHtml}
                            </div>
                        `;
                    }

                    // 루트(Beauty & Personal Care)부터 시작하여 트리 렌더링
                    detailContent.innerHTML = renderCategoryTree('beauty', true);

                    // Lucide 아이콘 새로고침
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                }

            } catch (error) {
                console.error('SoS chart update error:', error);
                chartCanvas.style.display = 'none';
                noDataMsg.style.display = 'block';
            }
        }

        // ============== END SoS 차트 관련 함수들 ==============

        function initChartsForPage(pageId) {
            Object.values(charts).forEach(c => c.destroy()); charts = {};
            // AMOREPACIFIC CI Colors - Harmony of Contrast
            const colors = {
                laneige: '#1F5795',      // Amore Blue - 부드러움
                pacific: '#001C58',       // Pacific Blue - 강함
                competitor: '#7D7D7D',    // AP Gray
                others: '#D0D0D0',
                grid: 'rgba(0, 28, 88, 0.06)',
                warning: '#C4A962'        // Gold accent
            };
            // 차트 색상 - Amore Blue 기반 그라데이션
            const chartColors = ['#001C58', '#1F5795', '#4A7DB8', '#7DA3CC', '#B0C9E0'];
            // 브랜드 비교 색상 - Pacific Blue, Gray 톤
            const brandColors = ['#1F5795', '#001C58', '#7D7D7D', '#4A7DB8', '#A0A0A0', '#2E4A6E', '#5C5C5C', '#3D6B99', '#8B8B8B', '#1A3D66'];

            if (pageId === 'home') {
                // SoS 날짜 필터 먼저 초기화 (updateSosChart가 날짜 값을 필요로 함)
                initSosDateFilters();
                // SoS 막대그래프 초기화 - API 연동 (내부에서 updateSosChart 호출)
                initSosBarChart(colors, chartColors, brandColors);
                loadSosBrands();  // 비교 브랜드 드롭다운 로드

                // SoS 트렌드 차트 - JSON 데이터 사용
                // 동적 fallback 날짜 생성
                window.generateRecentDates = (days = 7) => {
                    const dates = [];
                    for (let i = days - 1; i >= 0; i--) {
                        const d = new Date();
                        d.setDate(d.getDate() - i);
                        dates.push((d.getMonth() + 1).toString().padStart(2, '0') + '/' + d.getDate().toString().padStart(2, '0'));
                    }
                    return dates;
                };

                // SoS 트렌드 데이터 가져오기 (기간별)
                window.getSosTrendData = (days) => {
                    const fallbackLabels = generateRecentDates(days);
                    const fallbackData = new Array(days).fill(0);

                    // 기간별 데이터 키 확인 (7d, 14d, 30d)
                    const periodKey = days + 'd';
                    if (dashboardData?.charts?.sos_trend?.[periodKey]) {
                        return {
                            labels: dashboardData.charts.sos_trend[periodKey].labels || fallbackLabels,
                            data: dashboardData.charts.sos_trend[periodKey].data || fallbackData
                        };
                    }

                    // 레거시 형식 지원 (단일 데이터)
                    if (dashboardData?.charts?.sos_trend?.labels) {
                        const rawLabels = dashboardData.charts.sos_trend.labels;
                        const rawData = dashboardData.charts.sos_trend.data;

                        // 데이터가 요청 기간보다 적으면 fallback 날짜로 채움
                        if (rawLabels.length < days) {
                            // 기존 데이터를 날짜 맵으로 변환
                            const dataMap = {};
                            rawLabels.forEach((label, idx) => {
                                dataMap[label] = rawData[idx];
                            });

                            // fallback 날짜에 매칭
                            const mergedData = fallbackLabels.map(label => {
                                // MM/DD 형식으로 변환하여 매칭
                                const mmdd = label.replace('/', '-');
                                return dataMap[mmdd] || dataMap[label] || 0;
                            });

                            return { labels: fallbackLabels, data: mergedData };
                        }

                        // 최근 N일만 추출
                        return {
                            labels: rawLabels.slice(-days),
                            data: rawData.slice(-days)
                        };
                    }

                    return { labels: fallbackLabels, data: fallbackData };
                };

                // 초기 7일 데이터로 차트 생성
                const initialData = getSosTrendData(7);

                charts.trend = new Chart(document.getElementById('trendChart').getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: initialData.labels,
                        datasets: [{
                            label: 'Laneige 시장점유율',
                            data: initialData.data,
                            borderColor: colors.laneige,
                            backgroundColor: 'rgba(31, 87, 149, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3,
                            pointRadius: 4,
                            pointBackgroundColor: colors.laneige,
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => `점유율: ${ctx.parsed.y.toFixed(1)}%`
                                }
                            }
                        },
                        scales: {
                            y: {
                                grid: { color: colors.grid },
                                ticks: {
                                    callback: (value) => value + '%'
                                },
                                beginAtZero: true
                            },
                            x: { grid: { display: false } }
                        }
                    }
                });
            }

            if (pageId === 'brand') {
                // 브랜드 매트릭스 버블 차트 - JSON 데이터 사용
                let brandDatasets = [
                    { label: 'Laneige', data: [{x: 44, y: 53.6, r: 18}], backgroundColor: colors.laneige },
                    { label: 'Summer Fridays', data: [{x: 32, y: 42, r: 14}], backgroundColor: colors.competitor },
                    { label: 'Burt\'s Bees', data: [{x: 22, y: 48, r: 12}], backgroundColor: '#ffd700' },
                    { label: 'EOS', data: [{x: 18, y: 55, r: 10}], backgroundColor: '#ff69b4' }
                ];

                if (dashboardData?.charts?.brand_matrix && dashboardData.charts.brand_matrix.length > 0) {
                    brandDatasets = dashboardData.charts.brand_matrix.map((brand, idx) => ({
                        label: brand.brand,
                        data: [{ x: brand.sos, y: brand.avg_rank, r: Math.min(Math.max(brand.bubble_size, 6), 12) }],
                        backgroundColor: brand.is_laneige
                            ? 'rgba(0, 28, 88, 0.75)'  // Pacific Blue 75% 투명도
                            : brandColors[idx % brandColors.length].replace(')', ', 0.65)').replace('rgb', 'rgba'),
                        borderColor: brand.is_laneige ? '#001C58' : 'rgba(255,255,255,0.9)',
                        borderWidth: brand.is_laneige ? 3 : 2
                    }));
                }

                // 동적 축 범위 계산 (데이터 분포에 맞게 + 10% 여유)
                const allSoS = brandDatasets.flatMap(d => d.data.map(p => p.x));
                const allRanks = brandDatasets.flatMap(d => d.data.map(p => p.y));
                const sosMin = Math.max(0, Math.min(...allSoS) - 2);
                const sosMax = Math.min(100, Math.max(...allSoS) * 1.3);  // 30% 여유
                const rankMin = Math.max(1, Math.min(...allRanks) - 5);
                const rankMax = Math.min(100, Math.max(...allRanks) + 10);

                // stepSize 계산 (범위에 맞게)
                const sosRange = sosMax - sosMin;
                const sosStep = sosRange <= 20 ? 2 : sosRange <= 50 ? 5 : 10;
                const rankRange = rankMax - rankMin;
                const rankStep = rankRange <= 30 ? 5 : 10;

                charts.brandMatrix = new Chart(document.getElementById('brandMatrixChart').getContext('2d'), {
                    type: 'bubble',
                    data: { datasets: brandDatasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: { top: 20, right: 30, bottom: 20, left: 20 }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    font: { size: 11 },
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    padding: 12
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const data = context.raw;
                                        return `${context.dataset.label}: 점유율 ${data.x.toFixed(1)}%, 순위 ${data.y.toFixed(1)}위`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                reverse: true,
                                title: { display: true, text: '평균순위', font: { weight: 'bold' } },
                                grid: { color: colors.grid },
                                min: Math.floor(rankMin),
                                max: Math.ceil(rankMax),
                                ticks: {
                                    stepSize: rankStep,
                                    callback: function(value) {
                                        return Number.isInteger(value) ? value + '위' : '';
                                    }
                                }
                            },
                            x: {
                                title: { display: true, text: '시장점유율 (%)', font: { weight: 'bold' } },
                                grid: { color: colors.grid },
                                min: Math.floor(sosMin),
                                max: Math.ceil(sosMax),
                                ticks: {
                                    stepSize: sosStep,
                                    callback: function(value) {
                                        return Number.isInteger(value) ? value + '%' : '';
                                    }
                                }
                            }
                        },
                        elements: {
                            point: {
                                hoverRadius: 10
                            }
                        }
                    }
                });
            }

            if (pageId === 'category') {
                // CPI 추이 차트 - JSON 데이터 사용
                // 동적 fallback 날짜 생성 (최근 7일)
                const generateRecentDatesForCPI = (days = 7) => {
                    const dates = [];
                    for (let i = days - 1; i >= 0; i--) {
                        const d = new Date();
                        d.setDate(d.getDate() - i);
                        dates.push((d.getMonth() + 1).toString().padStart(2, '0') + '/' + d.getDate().toString().padStart(2, '0'));
                    }
                    return dates;
                };
                let cpiLabels = generateRecentDatesForCPI(7);
                let cpiData = [100, 100, 100, 100, 100, 100, 100]; // 기준선 100으로 초기화

                if (dashboardData?.charts?.cpi_trend) {
                    cpiLabels = dashboardData.charts.cpi_trend.labels || cpiLabels;
                    cpiData = dashboardData.charts.cpi_trend.data || cpiData;
                }

                // 기준선 데이터 생성
                const baselineData = cpiLabels.map(() => 100);

                charts.cpi = new Chart(document.getElementById('cpiChart').getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: cpiLabels,
                        datasets: [
                            {
                                label: 'Laneige 가격경쟁지수',
                                data: cpiData,
                                borderColor: colors.laneige,
                                backgroundColor: 'rgba(32,128,128,0.1)',
                                tension: 0.4,
                                fill: true,
                                borderWidth: 3
                            },
                            {
                                label: '기준선 (100)',
                                data: baselineData,
                                borderColor: '#94a3b8',
                                borderDash: [5, 5],
                                borderWidth: 2,
                                pointRadius: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'top', labels: { font: { size: 11 } } } },
                        scales: { y: { min: 90, max: 250, grid: { color: colors.grid } }, x: { grid: { display: false } } }
                    }
                });
            }

            if (pageId === 'product') {
                // 제품 순위 추이 차트 - JSON 데이터 사용
                // 동적 fallback 날짜 생성 (최근 7일)
                const generateRecentDatesForRank = (days = 7) => {
                    const dates = [];
                    for (let i = days - 1; i >= 0; i--) {
                        const d = new Date();
                        d.setDate(d.getDate() - i);
                        dates.push((d.getMonth() + 1).toString().padStart(2, '0') + '/' + d.getDate().toString().padStart(2, '0'));
                    }
                    return dates;
                };
                let rankLabels = generateRecentDatesForRank(7);
                let rankDatasets = [
                    { label: '데이터 로딩 중...', data: rankLabels.map(() => null), borderColor: colors.laneige, backgroundColor: 'rgba(32,128,128,0.1)', tension: 0.4, fill: true, borderWidth: 3 },
                    { label: '1위 기준선', data: rankLabels.map(() => 1), borderColor: colors.competitor, borderDash: [5, 5], tension: 0, borderWidth: 2 }
                ];

                let rankYMax = 20; // 기본값
                if (dashboardData?.charts?.product_rank_trend) {
                    const prt = dashboardData.charts.product_rank_trend;
                    rankLabels = prt.labels || rankLabels;

                    if (prt.products && Object.keys(prt.products).length > 0) {
                        // 모든 순위 데이터에서 최대값 계산
                        const allRanks = Object.values(prt.products)
                            .flatMap(p => p.ranks)
                            .filter(r => r !== null && r !== undefined);
                        if (allRanks.length > 0) {
                            rankYMax = Math.max(...allRanks, 20) + 10; // 여유 공간 추가
                        }

                        rankDatasets = Object.entries(prt.products).map(([asin, product], idx) => ({
                            label: product.name,
                            data: product.ranks.map(r => r || null),
                            borderColor: chartColors[idx % chartColors.length],
                            backgroundColor: idx === 0 ? 'rgba(32,128,128,0.1)' : 'transparent',
                            tension: 0.4,
                            fill: idx === 0,
                            borderWidth: 3
                        }));
                        // 1위 기준선 추가
                        rankDatasets.push({
                            label: '1위 기준선',
                            data: rankLabels.map(() => 1),
                            borderColor: colors.competitor,
                            borderDash: [5, 5],
                            tension: 0,
                            borderWidth: 2,
                            pointRadius: 0
                        });
                    }
                }

                charts.rankTrend = new Chart(document.getElementById('rankTrendChart').getContext('2d'), {
                    type: 'line',
                    data: { labels: rankLabels, datasets: rankDatasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    font: { size: 10 },
                                    boxWidth: 12,
                                    padding: 8,
                                    generateLabels: function(chart) {
                                        const datasets = chart.data.datasets;
                                        return datasets.map((ds, i) => {
                                            const fullLabel = ds.label || '';
                                            const shortLabel = fullLabel.length > 30 ? fullLabel.substring(0, 30) + '...' : fullLabel;
                                            return {
                                                text: shortLabel,
                                                fullText: fullLabel,
                                                fillStyle: ds.borderColor || ds.backgroundColor,
                                                strokeStyle: ds.borderColor,
                                                lineWidth: ds.borderWidth || 2,
                                                hidden: !chart.isDatasetVisible(i),
                                                datasetIndex: i
                                            };
                                        });
                                    }
                                },
                                onHover: function(event, legendItem) {
                                    if (legendItem && legendItem.fullText) {
                                        event.native.target.title = legendItem.fullText;
                                        event.native.target.style.cursor = 'pointer';
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        return context[0].dataset.label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: { reverse: true, title: { display: true, text: 'Rank' }, min: 1, max: rankYMax, grid: { color: colors.grid } },
                            x: { grid: { display: false } }
                        }
                    }
                });

                // 제품 매트릭스 버블 차트 - JSON 데이터 사용
                let matrixDatasets = [
                    { label: 'Lip Mask Berry', data: [{x: 2, y: 12, r: 16}], backgroundColor: 'rgba(16,185,129,0.7)' },
                    { label: 'Lip Mask Original', data: [{x: 5, y: 8, r: 14}], backgroundColor: colors.laneige },
                    { label: 'Lip Glowy Balm', data: [{x: 12, y: 22, r: 10}], backgroundColor: 'rgba(245,158,11,0.7)' },
                    { label: 'Water Bank', data: [{x: 8, y: 18, r: 12}], backgroundColor: 'rgba(231,76,60,0.7)' }
                ];

                if (dashboardData?.charts?.product_matrix && dashboardData.charts.product_matrix.length > 0) {
                    matrixDatasets = dashboardData.charts.product_matrix.map(product => ({
                        label: product.name,
                        data: [{ x: product.rank, y: product.volatility, r: product.bubble_size }],
                        backgroundColor: product.color
                    }));
                }

                charts.productMatrix = new Chart(document.getElementById('productMatrixChart').getContext('2d'), {
                    type: 'bubble',
                    data: { datasets: matrixDatasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        clip: false, // 버블 클리핑 방지
                        layout: {
                            padding: { top: 35, right: 35, bottom: 20, left: 25 }
                        },
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    font: { size: 10 },
                                    boxWidth: 10,
                                    padding: 6,
                                    generateLabels: function(chart) {
                                        const datasets = chart.data.datasets;
                                        return datasets.map((ds, i) => {
                                            // 데이터에서 fullName 가져오기
                                            const fullName = ds.data?.[0]?.fullName || ds.label || '';
                                            const shortLabel = fullName.length > 25 ? fullName.substring(0, 25) + '...' : fullName;
                                            return {
                                                text: shortLabel,
                                                fullText: fullName,
                                                fillStyle: ds.backgroundColor,
                                                strokeStyle: ds.borderColor || ds.backgroundColor,
                                                lineWidth: 1,
                                                hidden: !chart.isDatasetVisible(i),
                                                datasetIndex: i
                                            };
                                        });
                                    }
                                },
                                onHover: function(event, legendItem, legend) {
                                    event.native.target.style.cursor = 'pointer';
                                    if (legendItem && typeof legendItem.datasetIndex === 'number') {
                                        const dataset = legend.chart.data.datasets[legendItem.datasetIndex];
                                        const fullName = dataset?.data?.[0]?.fullName || legendItem.fullText || '';
                                        event.native.target.title = fullName;
                                    }
                                },
                                onLeave: function(event) {
                                    event.native.target.style.cursor = 'default';
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        const raw = context[0].raw;
                                        return raw.fullName || context[0].dataset.label;
                                    },
                                    label: function(context) {
                                        const raw = context.raw;
                                        const lines = [
                                            `평균 순위: ${context.parsed.x}위`,
                                            `변동성: ${context.parsed.y.toFixed(1)}`
                                        ];
                                        if (raw.reviewsCount) {
                                            lines.push(`리뷰 수: ${raw.reviewsCount.toLocaleString()}개`);
                                        }
                                        if (raw.avgPrice) {
                                            lines.push(`평균 가격: $${raw.avgPrice.toFixed(2)}`);
                                        }
                                        return lines;
                                    },
                                    afterLabel: function(context) {
                                        // 4분면 해석 추가
                                        const x = context.parsed.x;
                                        const y = context.parsed.y;
                                        let quadrant = '';
                                        if (x <= 25 && y <= 15) quadrant = '📍 King: 안정적 상위권';
                                        else if (x <= 25 && y > 15) quadrant = '🚀 Rising: 급부상 중';
                                        else if (x > 25 && y <= 15) quadrant = '⚠️ Lagging: 정체';
                                        else quadrant = '🔴 Risk: 위험';
                                        return quadrant;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: { title: { display: true, text: '순위변동성 ↑' }, min: 0, max: 45, ticks: { stepSize: 5 }, grid: { color: colors.grid } },
                            x: { title: { display: true, text: '순위 (← 우수)' }, min: 0, max: 50, ticks: { stepSize: 5 }, grid: { color: colors.grid } }
                        }
                    }
                });

                // 할인율 추이 차트 초기화
                initDiscountTrendChart();
            }
        }

        // Product View 초기 데이터 로드
        async function loadInitialProductChartData() {
            const rankStartInput = document.getElementById('rankTrendStartDate');
            const rankEndInput = document.getElementById('rankTrendEndDate');

            if (rankStartInput && rankEndInput && rankStartInput.value && rankEndInput.value) {
                const startDate = rankStartInput.value;
                const endDate = rankEndInput.value;
                console.log('[Init] Loading initial product chart data:', startDate, '~', endDate);

                try {
                    // 순위 추이 차트 업데이트
                    await updateRankTrendChart(startDate, endDate);

                    // 제품 매트릭스 차트 업데이트
                    await updateProductMatrixChart(startDate, endDate);

                    // 할인율 추이 차트 업데이트
                    await updateDiscountTrendChartWithRange(startDate, endDate);

                    const daysDiff = Math.ceil((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24));

                    // 성장 유형 분류 데이터 로드
                    await updateGrowthTypeDataWithRange(startDate, endDate, daysDiff);

                    // 경쟁사 프로모션 비교 데이터 로드
                    await updateCompetitorPromoDataWithRange(startDate, endDate, daysDiff);
                } catch (error) {
                    console.error('[Init] Error loading initial chart data:', error);
                }
            }
        }

        // 할인율 추이 차트 초기화
        function initDiscountTrendChart() {
            const ctx = document.getElementById('discountTrendChart');
            if (!ctx) return;

            // 기존 차트가 있으면 제거
            if (charts.discountTrend) {
                charts.discountTrend.destroy();
            }

            // 기본 데이터 (JSON에서 로드하거나 fallback)
            let discountLabels = ['D-6', 'D-5', 'D-4', 'D-3', 'D-2', 'D-1', '오늘'];
            let priceData = [24.00, 24.00, 22.00, 22.00, 22.00, 22.00, 22.00];
            let discountData = [0, 0, 8.3, 8.3, 8.3, 8.3, 8.3];
            let currentDiscount = 8.3;

            // JSON 데이터에서 로드
            if (dashboardData?.charts?.discount_trend) {
                const trend = dashboardData.charts.discount_trend;
                if (trend.labels && trend.labels.length > 0) {
                    discountLabels = trend.labels;
                    priceData = trend.prices || priceData;
                    discountData = trend.discounts || trend.data || discountData;
                    currentDiscount = discountData[discountData.length - 1] || 0;
                }
            }

            // 할인율 배지 업데이트
            const discountBadge = document.getElementById('discount-badge');
            if (discountBadge) {
                discountBadge.textContent = `현재 할인율: ${currentDiscount}%`;
                if (currentDiscount > 10) {
                    discountBadge.style.background = 'rgba(139, 38, 53, 0.1)';
                    discountBadge.style.color = '#8B2635';
                } else if (currentDiscount > 0) {
                    discountBadge.style.background = 'rgba(196, 169, 98, 0.1)';
                    discountBadge.style.color = '#C4A962';
                }
            }

            // 인사이트 메시지
            const insightEl = document.getElementById('discount-insight');
            if (insightEl) {
                if (currentDiscount > 10) {
                    insightEl.textContent = '⚠️ 높은 할인율 - 마진 압박 주의';
                } else if (currentDiscount > 0) {
                    insightEl.textContent = '✓ 적정 할인율 유지 중';
                } else {
                    insightEl.textContent = '📍 정가 판매 중';
                }
            }

            charts.discountTrend = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: discountLabels,
                    datasets: [
                        {
                            label: '판매가 ($)',
                            data: priceData,
                            borderColor: '#1F5795',
                            backgroundColor: 'rgba(31, 87, 149, 0.1)',
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y'
                        },
                        {
                            label: '할인율 (%)',
                            data: discountData,
                            borderColor: '#C4A962',
                            backgroundColor: 'rgba(196, 169, 98, 0.1)',
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.3,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { position: 'top', labels: { font: { size: 11 } } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.dataset.label.includes('가격') || context.dataset.label.includes('판매가')) {
                                        return `${context.dataset.label}: $${context.parsed.y.toFixed(2)}`;
                                    }
                                    return `${context.dataset.label}: ${context.parsed.y}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: '판매가 ($)' },
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: '할인율 (%)' },
                            min: 0,
                            max: 50,
                            grid: { drawOnChartArea: false }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // ============================================
        // 날짜 범위 선택 기능
        // ============================================

        // 날짜 범위 선택 버튼 이벤트 리스너 초기화
        function initDateRangeSelectors() {
            document.querySelectorAll('.date-range-selector').forEach(selector => {
                const chartType = selector.dataset.chart;
                selector.querySelectorAll('.date-btn').forEach(btn => {
                    btn.addEventListener('click', async function(e) {
                        e.preventDefault();
                        const days = parseInt(this.dataset.days);

                        // 로딩 상태 표시
                        selector.querySelectorAll('.date-btn').forEach(b => b.classList.remove('active'));
                        this.classList.add('active', 'loading');

                        try {
                            await updateChartWithDateRange(chartType, days);
                        } catch (error) {
                            console.error(`Failed to update ${chartType} chart:`, error);
                            showToast(`차트 업데이트 실패: ${error.message}`, 'error');
                        } finally {
                            this.classList.remove('loading');
                        }
                    });
                });
            });
        }

        // 날짜 범위 계산 (YYYY-MM-DD 형식)
        function getDateRange(days) {
            const end = new Date();
            const start = new Date();
            start.setDate(start.getDate() - days + 1);

            const formatDate = (d) => {
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            return {
                start_date: formatDate(start),
                end_date: formatDate(end)
            };
        }

        // Historical API 호출
        async function fetchHistoricalData(startDate, endDate, brand = 'LANEIGE') {
            const url = `${API_BASE}/api/historical?start_date=${startDate}&end_date=${endDate}&brand=${brand}`;
            const response = await fetch(url);

            if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
            }

            const data = await response.json();
            if (!data.success) {
                throw new Error(data.error || 'Unknown error');
            }

            // rank_history와 data를 병합하여 반환
            return {
                ...data.data,
                rank_history: data.rank_history,
                available_dates: data.available_dates,
                available_date_range: data.available_date_range,
                data_source: data.data_source,
                brand_metrics: data.brand_metrics
            };
        }

        // 차트별 업데이트 함수
        async function updateChartWithDateRange(chartType, days) {
            const { start_date, end_date } = getDateRange(days);

            switch (chartType) {
                case 'rankTrend':
                    await updateRankTrendChart(start_date, end_date, days);
                    break;
                case 'productMatrix':
                    await updateProductMatrixChart(start_date, end_date, days);
                    break;
                case 'discountTrend':
                    await updateDiscountTrendChartWithRange(start_date, end_date, days);
                    break;
                default:
                    console.warn(`Unknown chart type: ${chartType}`);
            }
        }

        // 전역 변수: 현재 LANEIGE 제품 목록과 선택된 제품
        let currentLaneigeProducts = {};
        let selectedProductNames = [];
        let currentRankHistoryData = null;
        let currentRankLabels = [];

        // 순위 추이 차트 업데이트
        async function updateRankTrendChart(startDate, endDate, days) {
            try {
                console.log('[RankTrend] Fetching data for:', startDate, '~', endDate);
                const historicalData = await fetchHistoricalData(startDate, endDate);

                if (!historicalData || !historicalData.rank_history) {
                    showToast('해당 기간의 순위 데이터가 없습니다.', 'info');
                    return;
                }

                const rankHistory = historicalData.rank_history;
                const labels = Object.keys(rankHistory).sort();
                console.log('[RankTrend] Labels from API:', labels);

                // 데이터 저장 (필터링에서 재사용)
                currentRankHistoryData = rankHistory;
                currentRankLabels = labels;

                // LANEIGE 제품만 필터링하여 제품별 데이터 구성
                const productRanks = {};
                labels.forEach(date => {
                    const dayData = rankHistory[date];
                    if (dayData && dayData.products) {
                        dayData.products
                            .filter(p => p.brand && p.brand.toLowerCase() === 'laneige')
                            .forEach(product => {
                                const name = product.name || product.product_name;
                                if (!name) return;
                                if (!productRanks[name]) {
                                    productRanks[name] = [];
                                }
                                productRanks[name].push({ date, rank: product.rank, price: product.price });
                            });
                    }
                });

                // 전역에 저장
                currentLaneigeProducts = productRanks;

                // LANEIGE 제품이 없으면 경고
                if (Object.keys(productRanks).length === 0) {
                    showToast('해당 기간에 LANEIGE 제품 데이터가 없습니다.', 'warning');
                    return;
                }

                // 제품 선택기 업데이트
                updateProductSelector(productRanks);

                // 선택된 제품이 없으면 전체 표시
                const productsToShow = selectedProductNames.length > 0
                    ? Object.fromEntries(Object.entries(productRanks).filter(([name]) => selectedProductNames.includes(name)))
                    : productRanks;

                // 차트 렌더링
                renderRankTrendChart(labels, productsToShow);

            } catch (error) {
                console.error('Error updating rank trend chart:', error);
                throw error;
            }
        }

        // 제품 선택기 업데이트 (체크박스 드롭다운)
        function updateProductSelector(productRanks) {
            const checkboxList = document.getElementById('productCheckboxList');
            if (!checkboxList) return;

            checkboxList.innerHTML = '';

            // 제품명을 평균 순위로 정렬
            const sortedProducts = Object.entries(productRanks)
                .map(([name, data]) => {
                    const avgRank = data.reduce((sum, d) => sum + d.rank, 0) / data.length;
                    return { name, avgRank };
                })
                .sort((a, b) => a.avgRank - b.avgRank);

            // 체크박스 항목 추가
            sortedProducts.forEach(({ name, avgRank }, idx) => {
                const shortName = name.length > 40 ? name.substring(0, 40) + '...' : name;
                const itemDiv = document.createElement('div');
                itemDiv.className = 'dropdown-item';
                itemDiv.style.cssText = 'padding: 6px 12px; border-bottom: 1px solid #f0f0f0;';
                itemDiv.innerHTML = `
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 12px;">
                        <input type="checkbox" class="product-checkbox" value="${name}" checked onchange="onProductCheckboxChange()" style="width: 14px; height: 14px;">
                        <span style="color: ${chartColors[idx % chartColors.length]}; font-weight: 500;">●</span>
                        <span title="${name}">${shortName}</span>
                        <span style="color: #888; margin-left: auto; font-size: 11px;">${Math.round(avgRank)}위</span>
                    </label>
                `;
                checkboxList.appendChild(itemDiv);
            });

            // 드롭다운 라벨 업데이트
            updateDropdownLabel();
        }

        // 드롭다운 토글
        function toggleProductDropdown() {
            const menu = document.getElementById('productDropdownMenu');
            if (menu) {
                menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
            }
        }

        // 드롭다운 외부 클릭 시 닫기
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('productDropdown');
            if (dropdown && !dropdown.contains(e.target)) {
                const menu = document.getElementById('productDropdownMenu');
                if (menu) menu.style.display = 'none';
            }
        });

        // 전체 선택/해제
        function toggleAllProducts(checked) {
            const checkboxes = document.querySelectorAll('.product-checkbox');
            checkboxes.forEach(cb => cb.checked = checked);
            onProductCheckboxChange();
        }

        // 체크박스 변경 시
        function onProductCheckboxChange() {
            updateDropdownLabel();
            applyProductFilter();
        }

        // 드롭다운 라벨 업데이트
        function updateDropdownLabel() {
            const label = document.getElementById('productDropdownLabel');
            const checkboxes = document.querySelectorAll('.product-checkbox');
            const checkedCount = document.querySelectorAll('.product-checkbox:checked').length;
            const totalCount = checkboxes.length;

            if (checkedCount === 0) {
                label.textContent = '선택 없음';
            } else if (checkedCount === totalCount) {
                label.textContent = `전체 제품 (${totalCount}개)`;
                document.getElementById('productSelectAll').checked = true;
            } else {
                label.textContent = `${checkedCount}개 선택됨`;
                document.getElementById('productSelectAll').checked = false;
            }
        }

        // 차트 렌더링 함수 (동적 축)
        function renderRankTrendChart(labels, productRanks) {
            const numDays = labels.length;

            // X축 틱 간격 계산 (동적)
            let tickStepSize = 1;
            if (numDays > 21) {
                tickStepSize = 3;
            } else if (numDays > 14) {
                tickStepSize = 2;
            }

            // 날짜 레이블 포맷팅
            const formattedLabels = labels.map(d => {
                const date = new Date(d);
                return `${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
            });

            // 데이터셋 생성
            const datasets = Object.entries(productRanks).map(([name, data], idx) => {
                const ranks = labels.map(date => {
                    const found = data.find(d => d.date === date);
                    return found ? found.rank : null;
                });

                return {
                    label: name.length > 45 ? name.substring(0, 45) + '...' : name,
                    data: ranks,
                    borderColor: chartColors[idx % chartColors.length],
                    backgroundColor: idx === 0 ? 'rgba(32,128,128,0.1)' : 'transparent',
                    tension: 0.3,
                    fill: idx === 0,
                    borderWidth: 2.5,
                    pointRadius: numDays <= 14 ? 4 : 2,
                    pointHoverRadius: 6,
                    spanGaps: true // null 값이 있어도 선 연결
                };
            });

            // Y축 범위 동적 계산
            const allRanks = Object.values(productRanks)
                .flat()
                .map(d => d.rank)
                .filter(r => r !== null && r !== undefined);

            let rankYMin = 1;
            let rankYMax = 100;
            if (allRanks.length > 0) {
                const minRank = Math.min(...allRanks);
                const maxRank = Math.max(...allRanks);
                // 여유 공간 추가 (상하 10%)
                const range = maxRank - minRank;
                const padding = Math.max(5, Math.ceil(range * 0.15));
                rankYMin = Math.max(1, minRank - padding);
                rankYMax = maxRank + padding;
            }

            // 기준선 추가 (1위)
            if (rankYMin <= 1) {
                datasets.push({
                    label: '1위 기준선',
                    data: formattedLabels.map(() => 1),
                    borderColor: 'rgba(100, 100, 100, 0.4)',
                    borderDash: [5, 5],
                    tension: 0,
                    borderWidth: 1.5,
                    pointRadius: 0
                });
            }

            // 차트 업데이트
            if (charts.rankTrend) {
                charts.rankTrend.data.labels = formattedLabels;
                charts.rankTrend.data.datasets = datasets;

                // Y축 동적 설정
                charts.rankTrend.options.scales.y.min = rankYMin;
                charts.rankTrend.options.scales.y.max = rankYMax;

                // X축 동적 설정
                charts.rankTrend.options.scales.x.ticks = {
                    ...charts.rankTrend.options.scales.x.ticks,
                    maxTicksLimit: Math.ceil(numDays / tickStepSize) + 1,
                    autoSkip: true,
                    maxRotation: numDays > 14 ? 45 : 0
                };

                charts.rankTrend.update('none');
            }
        }

        // 제품 필터 적용 (체크박스 기반)
        function applyProductFilter() {
            const checkboxes = document.querySelectorAll('.product-checkbox:checked');
            selectedProductNames = Array.from(checkboxes).map(cb => cb.value);

            // 현재 데이터로 차트 다시 렌더링
            if (currentLaneigeProducts && Object.keys(currentLaneigeProducts).length > 0) {
                const productsToShow = selectedProductNames.length > 0
                    ? Object.fromEntries(Object.entries(currentLaneigeProducts).filter(([name]) => selectedProductNames.includes(name)))
                    : currentLaneigeProducts;

                renderRankTrendChart(currentRankLabels, productsToShow);
            }
        }

        // 제품 매트릭스 차트 업데이트
        async function updateProductMatrixChart(startDate, endDate, days) {
            try {
                const historicalData = await fetchHistoricalData(startDate, endDate);

                if (!historicalData || !historicalData.rank_history) {
                    showToast('해당 기간의 데이터가 없습니다.', 'info');
                    return;
                }

                // 버블 차트용 색상 (HEX 형식)
                const bubbleColors = [
                    '#208080', // LANEIGE teal
                    '#1F5795', // Amore blue
                    '#C4A962', // Gold
                    '#8B2635', // Deep red
                    '#4BC0C0', // Teal light
                    '#001C58', // Pacific blue
                    '#9966FF', // Purple
                    '#FF9F40'  // Orange
                ];

                // LANEIGE 제품만 필터링하여 제품별 평균 순위, 변동성, 리뷰 수 계산
                const rankHistory = historicalData.rank_history;
                const productStats = {};

                Object.values(rankHistory).forEach(dayData => {
                    if (dayData && dayData.products) {
                        dayData.products
                            .filter(p => p.brand && p.brand.toLowerCase() === 'laneige')
                            .forEach(product => {
                                const name = product.name || product.product_name;
                                if (!name) return;
                                if (!productStats[name]) {
                                    productStats[name] = { ranks: [], name, reviewsCounts: [], prices: [] };
                                }
                                if (product.rank) {
                                    productStats[name].ranks.push(product.rank);
                                }
                                // 리뷰 수 수집 (최신 값 사용)
                                if (product.reviews_count) {
                                    productStats[name].reviewsCounts.push(product.reviews_count);
                                }
                                // 가격 수집
                                if (product.price) {
                                    productStats[name].prices.push(product.price);
                                }
                            });
                    }
                });

                // LANEIGE 제품이 없으면 경고
                if (Object.keys(productStats).length === 0) {
                    showToast('해당 기간에 LANEIGE 제품 데이터가 없습니다.', 'warning');
                    return;
                }

                // 데이터 계산 (리뷰 수, 가격 포함)
                const bubbleData = Object.values(productStats)
                    .filter(p => p.ranks.length > 0)
                    .map((product, idx) => {
                        const avgRank = product.ranks.reduce((a, b) => a + b, 0) / product.ranks.length;
                        const volatility = product.ranks.length > 1
                            ? Math.sqrt(product.ranks.map(r => Math.pow(r - avgRank, 2)).reduce((a, b) => a + b, 0) / product.ranks.length)
                            : 0;
                        // 최신 리뷰 수 (가장 마지막 값)
                        const reviewsCount = product.reviewsCounts.length > 0
                            ? product.reviewsCounts[product.reviewsCounts.length - 1]
                            : 0;
                        // 평균 가격
                        const avgPrice = product.prices.length > 0
                            ? product.prices.reduce((a, b) => a + b, 0) / product.prices.length
                            : null;
                        return { name: product.name, avgRank, volatility, reviewsCount, avgPrice, idx };
                    });

                // 동적 축 범위 계산 (버블 크기 고려)
                const allRanks = bubbleData.map(d => d.avgRank);
                const allVolatilities = bubbleData.map(d => d.volatility);

                const minRank = Math.min(...allRanks);
                const maxRank = Math.max(...allRanks);
                const maxVolatility = Math.max(...allVolatilities);

                // 버블 크기를 축 범위 기준으로 계산하여 패딩 적용
                // 버블이 그래프 영역 안에 완전히 들어오도록 축 범위 확장
                const dataXRange = maxRank - minRank || 10;
                const dataYRange = maxVolatility || 10;

                // 전체 축 범위 예측 (데이터 + 여유)
                const estimatedXRange = dataXRange + 20;
                const estimatedYRange = dataYRange + 15;

                // 버블 반지름(최대 25px)이 축 범위에서 차지하는 비율
                // 차트 너비 약 500px, 높이 약 350px 기준
                const bubbleRadiusInXUnits = (25 / 500) * estimatedXRange * 1.2;
                const bubbleRadiusInYUnits = (25 / 350) * estimatedYRange * 1.2;

                // 패딩: 버블 반지름 + 추가 여유
                const rankPadding = Math.max(5, bubbleRadiusInXUnits + 2);
                const volPadding = Math.max(5, bubbleRadiusInYUnits + 2);

                // x축: 음수 허용하여 좌측 버블도 완전히 표시
                const xMin = Math.floor(minRank - rankPadding);
                const xMax = Math.ceil(maxRank + rankPadding);
                const yMax = Math.ceil(maxVolatility + volPadding);

                // 버블 차트 데이터셋 생성 (작은 점으로 고정)
                const matrixDatasets = bubbleData.map((item, idx) => {
                    return {
                        label: item.name.length > 40 ? item.name.substring(0, 40) + '...' : item.name,
                        data: [{
                            x: Math.round(item.avgRank * 10) / 10,
                            y: Math.round(item.volatility * 10) / 10,
                            r: 6, // 작은 점 크기 고정
                            reviewsCount: item.reviewsCount,
                            avgPrice: item.avgPrice,
                            fullName: item.name
                        }],
                        backgroundColor: bubbleColors[idx % bubbleColors.length],
                        borderColor: bubbleColors[idx % bubbleColors.length],
                        borderWidth: 1,
                        hoverBackgroundColor: bubbleColors[idx % bubbleColors.length],
                        hoverBorderWidth: 2,
                        hoverRadius: 8
                    };
                });

                // 차트 업데이트
                if (charts.productMatrix && matrixDatasets.length > 0) {
                    charts.productMatrix.data.datasets = matrixDatasets;

                    // 동적 축 설정 (y축은 0부터 시작)
                    charts.productMatrix.options.scales.x.min = Math.max(0, xMin);
                    charts.productMatrix.options.scales.x.max = xMax;
                    charts.productMatrix.options.scales.y.min = 0;
                    charts.productMatrix.options.scales.y.max = Math.max(45, yMax);

                    // y축 간격 정리 (5 단위)
                    charts.productMatrix.options.scales.y.ticks = { stepSize: 5 };
                    charts.productMatrix.options.scales.x.ticks = { stepSize: 5 };

                    // 클리핑 비활성화 + 패딩으로 버블 잘림 방지
                    charts.productMatrix.options.clip = false;
                    charts.productMatrix.options.layout = {
                        padding: { top: 20, right: 25, bottom: 10, left: 15 }
                    };

                    charts.productMatrix.update('none');
                }

            } catch (error) {
                console.error('Error updating product matrix chart:', error);
                throw error;
            }
        }

        // 할인율 추이 차트 업데이트
        async function updateDiscountTrendChartWithRange(startDate, endDate, days) {
            try {
                const historicalData = await fetchHistoricalData(startDate, endDate);

                if (!historicalData) {
                    showToast('해당 기간의 데이터가 없습니다.', 'info');
                    return;
                }

                const rankHistory = historicalData.rank_history || {};
                const dates = Object.keys(rankHistory).sort();

                // LANEIGE 제품 목록 수집 (드롭다운용)
                const productSet = new Set();
                dates.forEach(date => {
                    const dayData = rankHistory[date];
                    if (dayData && dayData.products) {
                        dayData.products
                            .filter(p => p.brand && p.brand.toLowerCase() === 'laneige')
                            .forEach(p => {
                                const name = p.name || p.product_name;
                                if (name) productSet.add(name);
                            });
                    }
                });

                // 드롭다운 업데이트
                const productSelect = document.getElementById('discountProductSelect');
                if (productSelect) {
                    const currentValue = productSelect.value;
                    productSelect.innerHTML = '<option value="">전체 LANEIGE 평균</option>';
                    Array.from(productSet).sort().forEach(name => {
                        const shortName = name.length > 50 ? name.substring(0, 50) + '...' : name;
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = shortName;
                        option.title = name;
                        productSelect.appendChild(option);
                    });
                    // 이전 선택 유지
                    if (currentValue && productSet.has(currentValue)) {
                        productSelect.value = currentValue;
                    }
                }

                // 선택된 제품 가져오기
                const selectedProduct = productSelect ? productSelect.value : '';

                const priceData = [];
                const discountData = [];
                const formattedLabels = [];

                dates.forEach(date => {
                    const dayData = rankHistory[date];
                    if (dayData && dayData.products && dayData.products.length > 0) {
                        // LANEIGE 제품 필터링
                        let targetProducts = dayData.products.filter(p =>
                            p.brand && p.brand.toLowerCase() === 'laneige'
                        );

                        // 특정 제품 선택 시 해당 제품만 필터링
                        if (selectedProduct) {
                            targetProducts = targetProducts.filter(p =>
                                (p.name || p.product_name) === selectedProduct
                            );
                        }

                        if (targetProducts.length === 0) return;

                        // 가격과 할인율 계산
                        const prices = targetProducts.map(p => p.price).filter(p => p !== null && p !== undefined);
                        const discounts = targetProducts.map(p => p.discount_percent || 0);

                        const avgPrice = prices.length > 0
                            ? prices.reduce((a, b) => a + b, 0) / prices.length
                            : null;
                        const avgDiscount = discounts.length > 0
                            ? discounts.reduce((a, b) => a + b, 0) / discounts.length
                            : 0;

                        priceData.push(avgPrice);
                        discountData.push(Math.round(avgDiscount * 10) / 10);

                        const d = new Date(date);
                        formattedLabels.push(`${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getDate().toString().padStart(2, '0')}`);
                    }
                });

                // 차트 업데이트
                if (charts.discountTrend && formattedLabels.length > 0) {
                    charts.discountTrend.data.labels = formattedLabels;
                    charts.discountTrend.data.datasets[0].data = priceData;
                    charts.discountTrend.data.datasets[1].data = discountData;
                    charts.discountTrend.update('none');

                    // 현재 할인율 배지 업데이트
                    const latestDiscount = discountData[discountData.length - 1] || 0;
                    const latestPrice = priceData[priceData.length - 1];
                    const discountBadge = document.getElementById('discount-badge');
                    if (discountBadge) {
                        const priceText = latestPrice ? ` ($${latestPrice.toFixed(2)})` : '';
                        discountBadge.textContent = `현재 할인율: ${latestDiscount}%${priceText}`;
                    }

                    // 인사이트 업데이트
                    const insightEl = document.getElementById('discount-insight');
                    if (insightEl && discountData.length > 1) {
                        const trend = discountData[discountData.length - 1] > discountData[0] ? '상승' :
                                      discountData[discountData.length - 1] < discountData[0] ? '하락' : '유지';
                        insightEl.textContent = `추세: ${trend}`;
                    }
                } else if (formattedLabels.length === 0) {
                    showToast('선택한 제품의 가격 데이터가 없습니다.', 'info');
                }

            } catch (error) {
                console.error('Error updating discount trend chart:', error);
                throw error;
            }
        }

        // 순위 추이 차트 업데이트
        async function updateRankTrendChartWithRange(startDate, endDate, days) {
            try {
                console.log('[DateRange] updateRankTrendChartWithRange:', { startDate, endDate, days });

                // fetchHistoricalData를 직접 호출하는 대신 updateRankTrendChart 사용
                await updateRankTrendChart(startDate, endDate, days);

                console.log(`[DateRange] Rank trend chart updated for ${startDate} to ${endDate}`);
            } catch (error) {
                console.error('[DateRange] Error updating rank trend chart:', error);
                showToast('순위 추이 차트 업데이트 중 오류가 발생했습니다.', 'error');
            }
        }

        // 제품 매트릭스 차트 업데이트
        async function updateProductMatrixChartWithRange(startDate, endDate, days) {
            try {
                console.log('[DateRange] updateProductMatrixChartWithRange:', { startDate, endDate, days });

                // updateProductMatrixChart 함수 호출
                await updateProductMatrixChart(startDate, endDate, days);

                console.log(`[DateRange] Product matrix chart updated for ${startDate} to ${endDate}`);
            } catch (error) {
                console.error('[DateRange] Error updating product matrix chart:', error);
                showToast('제품 매트릭스 차트 업데이트 중 오류가 발생했습니다.', 'error');
            }
        }

        // 성장 유형 데이터 업데이트
        async function updateGrowthTypeDataWithRange(startDate, endDate, days) {
            try {
                console.log('[DateRange] updateGrowthTypeDataWithRange:', { startDate, endDate, days });

                const historicalData = await fetchHistoricalData(startDate, endDate);

                if (!historicalData) {
                    showToast('해당 기간의 데이터가 없습니다.', 'info');
                    return;
                }

                const rankHistory = historicalData.rank_history || {};
                const dates = Object.keys(rankHistory).sort();

                // Top 100에서 모든 제품 수집 (제품별 통계)
                const productStats = {};
                dates.forEach(date => {
                    const dayData = rankHistory[date];
                    if (dayData && dayData.products) {
                        dayData.products.forEach(p => {
                            const name = p.name || p.product_name;
                            if (!name) return;
                            if (!productStats[name]) {
                                productStats[name] = {
                                    name,
                                    brand: p.brand || 'Unknown',
                                    ranks: [],
                                    discounts: [],
                                    hasCoupon: false,
                                    hasDeal: false
                                };
                            }
                            if (p.rank) productStats[name].ranks.push(p.rank);
                            if (p.discount_percent) productStats[name].discounts.push(p.discount_percent);
                            if (p.coupon_text) productStats[name].hasCoupon = true;
                            if (p.deal_badge) productStats[name].hasDeal = true;
                        });
                    }
                });

                // 제품 목록 (평균 순위 기준 정렬, LANEIGE 우선)
                const sortedProducts = Object.values(productStats)
                    .filter(p => p.ranks.length > 0)
                    .map(p => ({
                        ...p,
                        avgRank: p.ranks.reduce((a, b) => a + b, 0) / p.ranks.length,
                        avgDiscount: p.discounts.length > 0 ? p.discounts.reduce((a, b) => a + b, 0) / p.discounts.length : 0
                    }))
                    .sort((a, b) => {
                        const aIsLaneige = a.brand.toLowerCase() === 'laneige';
                        const bIsLaneige = b.brand.toLowerCase() === 'laneige';
                        if (aIsLaneige && !bIsLaneige) return -1;
                        if (!aIsLaneige && bIsLaneige) return 1;
                        return a.avgRank - b.avgRank;
                    });

                // 드롭다운 업데이트
                const productSelect = document.getElementById('growthTypeProductSelect');
                if (productSelect) {
                    const currentSelection = productSelect.value;
                    productSelect.innerHTML = '<option value="">전체 LANEIGE 제품</option>';

                    const laneigProducts = sortedProducts.filter(p => p.brand.toLowerCase() === 'laneige');
                    const otherProducts = sortedProducts.filter(p => p.brand.toLowerCase() !== 'laneige');

                    if (laneigProducts.length > 0) {
                        const laneigGroup = document.createElement('optgroup');
                        laneigGroup.label = '🏆 LANEIGE';
                        laneigProducts.forEach((p) => {
                            const option = document.createElement('option');
                            option.value = p.name;
                            const shortName = p.name.length > 40 ? p.name.substring(0, 40) + '...' : p.name;
                            option.textContent = shortName;
                            option.title = p.name;
                            laneigGroup.appendChild(option);
                        });
                        productSelect.appendChild(laneigGroup);
                    }

                    if (otherProducts.length > 0) {
                        const otherGroup = document.createElement('optgroup');
                        otherGroup.label = '📊 경쟁사 (Top 100)';
                        otherProducts.slice(0, 50).forEach((p) => {
                            const option = document.createElement('option');
                            option.value = p.name;
                            const shortName = p.name.length > 35 ? p.name.substring(0, 35) + '...' : p.name;
                            option.textContent = `[${p.brand}] ${shortName}`;
                            option.title = p.name;
                            otherGroup.appendChild(option);
                        });
                        productSelect.appendChild(otherGroup);
                    }

                    if (currentSelection) {
                        productSelect.value = currentSelection;
                    }
                }

                // 선택된 제품 가져오기 (빈 값이면 LANEIGE 전체)
                let selectedProducts;
                if (productSelect && productSelect.value) {
                    selectedProducts = sortedProducts.filter(p => p.name === productSelect.value);
                } else {
                    selectedProducts = sortedProducts.filter(p => p.brand.toLowerCase() === 'laneige');
                }

                // 성장 유형 분류 계산
                let organicCount = 0;
                let discountBasedCount = 0;

                selectedProducts.forEach(p => {
                    const isDiscountBased = p.avgDiscount > 15 || p.hasCoupon || p.hasDeal;
                    if (isDiscountBased) {
                        discountBasedCount++;
                    } else {
                        organicCount++;
                    }
                });

                // UI 업데이트
                const organicEl = document.getElementById('organic-count');
                const discountEl = document.getElementById('discount-count');
                if (organicEl) organicEl.textContent = organicCount > 0 ? `${organicCount}개` : '-';
                if (discountEl) discountEl.textContent = discountBasedCount > 0 ? `${discountBasedCount}개` : '-';

                console.log(`[DateRange] Growth type data updated for ${startDate} to ${endDate}`, { organicCount, discountBasedCount });
            } catch (error) {
                console.error('[DateRange] Error updating growth type data:', error);
                showToast('성장 유형 데이터 업데이트 중 오류가 발생했습니다.', 'error');
            }
        }

        // 경쟁사 프로모션 데이터 업데이트
        async function updateCompetitorPromoDataWithRange(startDate, endDate, days) {
            try {
                console.log('[DateRange] updateCompetitorPromoDataWithRange:', { startDate, endDate, days });

                const historicalData = await fetchHistoricalData(startDate, endDate);

                if (!historicalData) {
                    showToast('해당 기간의 데이터가 없습니다.', 'info');
                    return;
                }

                const rankHistory = historicalData.rank_history || {};
                const dates = Object.keys(rankHistory).sort();

                // Top 100에서 모든 제품 수집 (제품별 통계)
                const productStats = {};
                dates.forEach(date => {
                    const dayData = rankHistory[date];
                    if (dayData && dayData.products) {
                        dayData.products.forEach(p => {
                            const name = p.name || p.product_name;
                            if (!name) return;
                            const key = name; // 제품명을 키로 사용
                            if (!productStats[key]) {
                                productStats[key] = {
                                    name,
                                    brand: p.brand || 'Unknown',
                                    ranks: [],
                                    discounts: [],
                                    hasCoupon: false,
                                    hasSns: false,
                                    couponText: ''
                                };
                            }
                            if (p.rank) productStats[key].ranks.push(p.rank);
                            if (p.discount_percent) productStats[key].discounts.push(p.discount_percent);
                            if (p.coupon_text) {
                                productStats[key].hasCoupon = true;
                                productStats[key].couponText = p.coupon_text;
                            }
                            if (p.is_subscribe_save) productStats[key].hasSns = true;
                        });
                    }
                });

                // 제품 목록 (평균 순위 기준 정렬, LANEIGE 우선)
                const sortedProducts = Object.values(productStats)
                    .filter(p => p.ranks.length > 0)
                    .map(p => ({
                        ...p,
                        avgRank: p.ranks.reduce((a, b) => a + b, 0) / p.ranks.length,
                        avgDiscount: p.discounts.length > 0
                            ? p.discounts.reduce((a, b) => a + b, 0) / p.discounts.length
                            : 0
                    }))
                    .sort((a, b) => {
                        // LANEIGE 제품 우선
                        const aIsLaneige = a.brand.toLowerCase() === 'laneige';
                        const bIsLaneige = b.brand.toLowerCase() === 'laneige';
                        if (aIsLaneige && !bIsLaneige) return -1;
                        if (!aIsLaneige && bIsLaneige) return 1;
                        return a.avgRank - b.avgRank;
                    });

                // 드롭다운 업데이트
                const productSelect = document.getElementById('competitorProductSelect');
                if (productSelect) {
                    const currentSelection = productSelect.value;
                    productSelect.innerHTML = '<option value="">전체 LANEIGE 제품</option>';

                    // LANEIGE 제품 그룹
                    const laneigProducts = sortedProducts.filter(p => p.brand.toLowerCase() === 'laneige');
                    const otherProducts = sortedProducts.filter(p => p.brand.toLowerCase() !== 'laneige');

                    // LANEIGE 옵션 그룹
                    if (laneigProducts.length > 0) {
                        const laneigGroup = document.createElement('optgroup');
                        laneigGroup.label = '🏆 LANEIGE';
                        laneigProducts.forEach((p) => {
                            const option = document.createElement('option');
                            option.value = p.name;
                            const shortName = p.name.length > 40 ? p.name.substring(0, 40) + '...' : p.name;
                            option.textContent = shortName;
                            option.title = p.name;
                            laneigGroup.appendChild(option);
                        });
                        productSelect.appendChild(laneigGroup);
                    }

                    // 경쟁사 옵션 그룹
                    if (otherProducts.length > 0) {
                        const otherGroup = document.createElement('optgroup');
                        otherGroup.label = '📊 경쟁사 (Top 100)';
                        otherProducts.slice(0, 50).forEach((p) => { // 상위 50개만
                            const option = document.createElement('option');
                            option.value = p.name;
                            const shortName = p.name.length > 35 ? p.name.substring(0, 35) + '...' : p.name;
                            option.textContent = `[${p.brand}] ${shortName}`;
                            option.title = p.name;
                            otherGroup.appendChild(option);
                        });
                        productSelect.appendChild(otherGroup);
                    }

                    // 이전 선택 복원
                    if (currentSelection) {
                        productSelect.value = currentSelection;
                    }
                }

                // 선택된 제품 가져오기 (빈 값이면 LANEIGE 전체)
                let selectedProducts;
                if (productSelect && productSelect.value) {
                    selectedProducts = [productSelect.value];
                } else {
                    selectedProducts = sortedProducts.filter(p => p.brand.toLowerCase() === 'laneige').map(p => p.name);
                }

                // 선택된 제품의 프로모션 데이터
                const promoData = selectedProducts.map(productName => {
                    const stats = productStats[productName];
                    if (!stats) return null;
                    const avgRank = stats.ranks.length > 0
                        ? (stats.ranks.reduce((a, b) => a + b, 0) / stats.ranks.length).toFixed(1)
                        : '-';
                    const avgDiscount = stats.discounts.length > 0
                        ? (stats.discounts.reduce((a, b) => a + b, 0) / stats.discounts.length).toFixed(1)
                        : '0.0';
                    return {
                        name: stats.name,
                        brand: stats.brand,
                        avg_rank: parseFloat(avgRank) || 0,
                        avg_discount: parseFloat(avgDiscount),
                        has_coupon: stats.hasCoupon,
                        coupon_text: stats.couponText,
                        has_sns: stats.hasSns
                    };
                }).filter(Boolean);

                // 테이블 업데이트
                updateCompetitorPromoDisplay(promoData);

                console.log(`[DateRange] Competitor promo data updated for ${startDate} to ${endDate}`);
            } catch (error) {
                console.error('[DateRange] Error updating competitor promo data:', error);
                showToast('경쟁사 프로모션 데이터 업데이트 중 오류가 발생했습니다.', 'error');
            }
        }

        // 경쟁사 프로모션 테이블 표시 함수 (제품 단위)
        function updateCompetitorPromoDisplay(promoData) {
            const tbody = document.getElementById('competitor-promo-tbody');
            if (!tbody) return;

            tbody.innerHTML = '';

            if (!promoData || promoData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-secondary);">선택된 제품이 없습니다.</td></tr>';
                return;
            }

            promoData.forEach(product => {
                const row = document.createElement('tr');
                const isLaneige = product.brand && product.brand.toLowerCase() === 'laneige';
                if (isLaneige) row.classList.add('is-laneige');

                const nameClass = isLaneige ? 'brand-name laneige' : 'brand-name';
                const discountDisplay = product.avg_discount > 0 ? product.avg_discount.toFixed(1) + '%' : '-';
                const rankDisplay = product.avg_rank ? '#' + product.avg_rank.toFixed(1) : '-';

                const discountBadge = product.avg_discount > 15 ?
                    `<span class="discount-badge" style="font-size: 9px; padding: 2px 6px; margin-left: 4px;">🔥</span>` : '';

                const couponDisplay = product.has_coupon
                    ? `<span title="${product.coupon_text || '쿠폰'}">🎟️</span>`
                    : '-';

                const snsDisplay = product.has_sns ? '✓' : '-';

                // 제품명 줄임 (20자)
                const shortName = product.name.length > 25
                    ? product.name.substring(0, 25) + '...'
                    : product.name;

                row.innerHTML = `
                    <td class="${nameClass}" title="${product.name}" style="max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${shortName}</td>
                    <td class="num-cell" style="font-size: 11px;">${product.brand}</td>
                    <td class="num-cell">${rankDisplay}</td>
                    <td class="num-cell discount-cell">${discountDisplay}${discountBadge}</td>
                    <td class="num-cell">${couponDisplay}</td>
                    <td class="num-cell">${snsDisplay}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // 차트 색상 정의
        const chartColors = [
            'rgba(32, 128, 128, 0.9)',   // LANEIGE teal
            'rgba(31, 87, 149, 0.9)',    // Amore blue
            'rgba(196, 169, 98, 0.9)',   // Gold
            'rgba(139, 38, 53, 0.9)',    // Deep red
            'rgba(75, 192, 192, 0.9)',   // Teal light
            'rgba(54, 162, 235, 0.9)',   // Blue
            'rgba(255, 159, 64, 0.9)',   // Orange
            'rgba(153, 102, 255, 0.9)'   // Purple
        ];

        // 시간 포맷 함수 (KST 기준)
        function formatDateTime(isoString) {
            if (!isoString) return '없음';

            // 타임존 정보가 없으면 KST(+09:00)로 간주
            let dateStr = isoString;
            if (!isoString.includes('+') && !isoString.includes('Z')) {
                dateStr = isoString + '+09:00';
            }

            const date = new Date(dateStr);

            // KST로 표시 (UTC+9)
            const kstOffset = 9 * 60; // 분 단위
            const localOffset = date.getTimezoneOffset(); // 분 단위 (UTC - 로컬)
            const kstDate = new Date(date.getTime() + (kstOffset + localOffset) * 60 * 1000);

            const year = kstDate.getFullYear();
            const month = String(kstDate.getMonth() + 1).padStart(2, '0');
            const day = String(kstDate.getDate()).padStart(2, '0');
            const hours = String(kstDate.getHours()).padStart(2, '0');
            const minutes = String(kstDate.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }

        function formatCurrentTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        // 실시간 시계 시작
        function startClock() {
            function updateClock() {
                document.getElementById('current-time').textContent = `🕐 현재: ${formatCurrentTime()}`;
            }
            updateClock(); // 즉시 실행
            setInterval(updateClock, 1000); // 1초마다 업데이트
        }

        // 데이터 업데이트 시간 표시
        function updateDataTime() {
            if (dashboardData && dashboardData.metadata) {
                const generatedAt = dashboardData.metadata.generated_at;
                document.getElementById('date-display').textContent = `📅 데이터: ${formatDateTime(generatedAt)}`;
            } else {
                document.getElementById('date-display').textContent = '📅 데이터: 없음';
            }
        }

        window.onload = async function() {
            startClock(); // 실시간 시계 시작
            await loadDashboardData();
            updateDataTime(); // 데이터 시간 업데이트
            switchPage('home');
            loadAlertSettings(); // 알림 설정 로드
            initDateRangeSelectors(); // 날짜 범위 선택 초기화

            // 글로벌 날짜 범위로 초기 차트 데이터 로드
            await loadInitialChartDataWithGlobalRange();
        };

        // 글로벌 날짜 범위로 초기 차트 데이터 로드
        async function loadInitialChartDataWithGlobalRange() {
            const { startDate, endDate } = globalDateRange.get();

            if (!startDate || !endDate) {
                console.log('[GlobalDateRange] No initial date range set, skipping initial load');
                return;
            }

            console.log('[GlobalDateRange] Loading initial chart data:', startDate, '~', endDate);

            try {
                // Home 페이지 차트 (SoS 추이) 초기 로드
                await updateSosTrendWithGlobalRange(startDate, endDate);

                console.log('[GlobalDateRange] Initial chart data loaded successfully');
            } catch (error) {
                console.error('[GlobalDateRange] Error loading initial chart data:', error);
            }
        }

        // ============================
        // Alert Settings (알림 설정)
        // ============================
        function openAlertSettings() {
            const modal = document.getElementById('alert-settings-modal');
            if (modal) {
                modal.style.display = 'flex';
                loadAlertSettings();
            }
        }

        function closeAlertSettings() {
            const modal = document.getElementById('alert-settings-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        async function loadAlertSettings() {
            try {
                const response = await fetch(`${API_BASE}/api/v3/alert-settings`);
                if (response.ok) {
                    const data = await response.json();

                    // 이메일 입력
                    document.getElementById('alert-email').value = data.email || '';

                    // 동의 체크박스
                    document.getElementById('alert-consent').checked = data.consent || false;

                    // 알림 유형 체크박스
                    const alertTypes = data.alert_types || [];
                    document.getElementById('alert-rank-change').checked = alertTypes.includes('rank_change');
                    document.getElementById('alert-insight').checked = alertTypes.includes('important_insight');
                    document.getElementById('alert-error').checked = alertTypes.includes('error');
                    document.getElementById('alert-daily').checked = alertTypes.includes('daily_summary');

                    // 동의 상태에 따라 체크박스 활성화/비활성화
                    toggleAlertOptions();
                }
            } catch (error) {
                console.error('Failed to load alert settings:', error);
            }
        }

        function toggleAlertOptions() {
            const consent = document.getElementById('alert-consent').checked;
            const options = document.querySelectorAll('.alert-type-option input');
            options.forEach(opt => {
                opt.disabled = !consent;
            });
        }

        async function saveAlertSettings() {
            const email = document.getElementById('alert-email').value;
            const consent = document.getElementById('alert-consent').checked;

            // 이메일 형식 검증
            if (consent && email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    alert('올바른 이메일 주소를 입력해주세요.');
                    return;
                }
            }

            // 알림 유형 수집
            const alertTypes = [];
            if (document.getElementById('alert-rank-change').checked) alertTypes.push('rank_change');
            if (document.getElementById('alert-insight').checked) alertTypes.push('important_insight');
            if (document.getElementById('alert-error').checked) alertTypes.push('error');
            if (document.getElementById('alert-daily').checked) alertTypes.push('daily_summary');

            try {
                const response = await fetch(`${API_BASE}/api/v3/alert-settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: email,
                        consent: consent,
                        alert_types: alertTypes
                    })
                });

                if (response.ok) {
                    alert('알림 설정이 저장되었습니다.');
                    closeAlertSettings();
                } else {
                    const error = await response.json();
                    alert('저장 실패: ' + (error.detail || '알 수 없는 오류'));
                }
            } catch (error) {
                console.error('Failed to save alert settings:', error);
                alert('저장 중 오류가 발생했습니다.');
            }
        }

        async function revokeConsent() {
            if (!confirm('이메일 알림 수신 동의를 철회하시겠습니까?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/v3/alert-settings/revoke`, {
                    method: 'POST'
                });

                if (response.ok) {
                    alert('동의가 철회되었습니다.');
                    loadAlertSettings();
                }
            } catch (error) {
                console.error('Failed to revoke consent:', error);
            }
        }

        // =====================================================================
        // DEALS MONITOR FUNCTIONS
        // =====================================================================

        let dealsData = null;
        let dealsSummary = null;
        let dealsCharts = {};

        // Deals 데이터 로드
        async function loadDealsData() {
            try {
                // API에서 deals 데이터 가져오기
                const [dealsResponse, summaryResponse, alertsResponse] = await Promise.all([
                    fetch(`${API_BASE}/api/deals?hours=24`),
                    fetch(`${API_BASE}/api/deals/summary?days=7`),
                    fetch(`${API_BASE}/api/deals/alerts?limit=20`)
                ]);

                if (dealsResponse.ok) {
                    const data = await dealsResponse.json();
                    dealsData = data;
                    updateDealsTable(data.deals);
                    updateDealsKPIs(data);
                }

                if (summaryResponse.ok) {
                    const summary = await summaryResponse.json();
                    dealsSummary = summary;
                    initDealsCharts(summary);
                }

                if (alertsResponse.ok) {
                    const alerts = await alertsResponse.json();
                    updateDealsAlerts(alerts.alerts);
                }

                lucide.createIcons();

            } catch (error) {
                console.error('Deals data load error:', error);
                showDealsError();
            }
        }

        // Deals KPI 업데이트
        function updateDealsKPIs(data) {
            const summary = data.summary || {};
            const byBrand = summary.by_brand || [];

            // 총 딜 수
            const totalDeals = data.count || byBrand.reduce((sum, b) => sum + (b.total_deals || 0), 0);
            document.getElementById('deals-total-count').innerHTML = `${totalDeals}<span class="unit">개</span>`;

            // Lightning Deal 수
            const lightningDeals = byBrand.reduce((sum, b) => sum + (b.lightning_deals || 0), 0);
            document.getElementById('deals-lightning-count').innerHTML = `${lightningDeals}<span class="unit">개</span>`;

            // 평균 할인율
            const avgDiscount = byBrand.length > 0
                ? (byBrand.reduce((sum, b) => sum + (b.avg_discount || 0), 0) / byBrand.length).toFixed(1)
                : '--';
            document.getElementById('deals-avg-discount').innerHTML = `${avgDiscount}<span class="unit">%</span>`;

            // 최대 할인율
            const maxDiscount = byBrand.length > 0
                ? Math.max(...byBrand.map(b => b.max_discount || 0))
                : '--';
            document.getElementById('deals-max-discount').innerHTML = `${maxDiscount}<span class="unit">%</span>`;

            // 인사이트 메시지 업데이트
            if (totalDeals > 20) {
                document.getElementById('deals-insight-message').textContent =
                    `⚠️ 현재 ${totalDeals}개의 경쟁사 딜이 활성화되어 있습니다. Lightning Deal ${lightningDeals}개 진행 중. LANEIGE 순위에 영향을 줄 수 있으니 모니터링이 필요합니다.`;
            } else if (totalDeals > 10) {
                document.getElementById('deals-insight-message').textContent =
                    `경쟁사 딜 ${totalDeals}개 진행 중 (Lightning ${lightningDeals}개). 평균 할인율 ${avgDiscount}%로 보통 수준입니다.`;
            } else {
                document.getElementById('deals-insight-message').textContent =
                    `현재 경쟁사 딜 활동이 적습니다 (${totalDeals}개). LANEIGE에 대한 직접적인 가격 압박은 낮은 상태입니다.`;
            }
        }

        // Deals 테이블 업데이트
        function updateDealsTable(deals) {
            const tbody = document.getElementById('deals-tbody');
            if (!tbody) return;

            if (!deals || deals.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: var(--text-secondary); padding: 40px;">
                    현재 활성화된 경쟁사 딜이 없습니다.<br>
                    <small>새로고침 버튼을 눌러 최신 데이터를 가져오세요</small>
                </td></tr>`;
                return;
            }

            tbody.innerHTML = deals.slice(0, 30).map(deal => {
                const dealTypeBadge = getDealTypeBadge(deal.deal_type);
                const discountClass = (deal.discount_percent || 0) >= 30 ? 'style="color: #ef4444; font-weight: 600;"' : '';
                const timeRemaining = deal.time_remaining || '-';
                const claimedPercent = deal.claimed_percent ? `${deal.claimed_percent}%` : '-';

                return `
                <tr>
                    <td class="brand-name" title="${deal.brand}">${deal.brand || 'Unknown'}</td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${deal.product_name}">${truncateText(deal.product_name, 40)}</td>
                    <td>${dealTypeBadge}</td>
                    <td class="num-cell" ${discountClass}>${deal.discount_percent ? deal.discount_percent + '%' : '-'}</td>
                    <td class="num-cell">$${(deal.deal_price || 0).toFixed(2)}</td>
                    <td>${timeRemaining}</td>
                    <td class="num-cell">${claimedPercent}</td>
                </tr>
                `;
            }).join('');
        }

        // 딜 타입 배지 생성
        function getDealTypeBadge(dealType) {
            const badges = {
                'lightning': '<span style="background: #fef3c7; color: #d97706; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">⚡ Lightning</span>',
                'deal_of_day': '<span style="background: #fee2e2; color: #dc2626; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">🔥 Deal of Day</span>',
                'best_deal': '<span style="background: #dbeafe; color: #2563eb; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">⭐ Best Deal</span>',
                'coupon': '<span style="background: #dcfce7; color: #16a34a; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">🎟️ Coupon</span>',
                'regular': '<span style="background: #f3f4f6; color: #6b7280; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 500;">Regular</span>'
            };
            return badges[dealType] || badges['regular'];
        }

        // 텍스트 자르기
        function truncateText(text, maxLength) {
            if (!text) return '';
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        // Deals 차트 초기화
        function initDealsCharts(summary) {
            // 브랜드별 딜 차트
            initDealsByBrandChart(summary.by_brand || []);

            // 일별 추이 차트
            initDealsTrendChart(summary.by_date || []);
        }

        // 브랜드별 딜 차트
        function initDealsByBrandChart(byBrand) {
            const ctx = document.getElementById('dealsByBrandChart');
            if (!ctx) return;

            if (dealsCharts.byBrand) {
                dealsCharts.byBrand.destroy();
            }

            const labels = byBrand.slice(0, 10).map(b => b.brand);
            const totalDeals = byBrand.slice(0, 10).map(b => b.total_deals || 0);
            const lightningDeals = byBrand.slice(0, 10).map(b => b.lightning_deals || 0);

            dealsCharts.byBrand = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Total Deals',
                            data: totalDeals,
                            backgroundColor: 'rgba(31, 87, 149, 0.8)',
                            borderRadius: 4
                        },
                        {
                            label: 'Lightning Deals',
                            data: lightningDeals,
                            backgroundColor: 'rgba(245, 158, 11, 0.8)',
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // 일별 딜 추이 차트
        function initDealsTrendChart(byDate) {
            const ctx = document.getElementById('dealsTrendChart');
            if (!ctx) return;

            if (dealsCharts.trend) {
                dealsCharts.trend.destroy();
            }

            const labels = byDate.map(d => d.date).reverse();
            const totalDeals = byDate.map(d => d.total_deals || 0).reverse();
            const lightningDeals = byDate.map(d => d.lightning_deals || 0).reverse();
            const avgDiscount = byDate.map(d => d.avg_discount || 0).reverse();

            dealsCharts.trend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Total Deals',
                            data: totalDeals,
                            borderColor: '#1F5795',
                            backgroundColor: 'rgba(31, 87, 149, 0.1)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Lightning Deals',
                            data: lightningDeals,
                            borderColor: '#f59e0b',
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.3
                        },
                        {
                            label: 'Avg Discount (%)',
                            data: avgDiscount,
                            borderColor: '#ef4444',
                            borderDash: [2, 2],
                            fill: false,
                            tension: 0.3,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Deals Count' }
                        },
                        y1: {
                            beginAtZero: true,
                            position: 'right',
                            title: { display: true, text: 'Discount (%)' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        // Deals 알림 업데이트
        function updateDealsAlerts(alerts) {
            const container = document.getElementById('deals-alerts-list');
            const countBadge = document.getElementById('alerts-count-badge');

            if (!container) return;

            if (!alerts || alerts.length === 0) {
                container.innerHTML = `<div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                    아직 알림이 없습니다. 경쟁사가 큰 할인을 시작하면 알림이 표시됩니다.
                </div>`;
                if (countBadge) countBadge.textContent = '0개의 새 알림';
                return;
            }

            const unsentCount = alerts.filter(a => !a.is_sent).length;
            if (countBadge) countBadge.textContent = `${unsentCount}개의 새 알림`;

            container.innerHTML = alerts.map(alert => `
                <div style="padding: 12px; border-bottom: 1px solid var(--border-light); display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 20px;">${alert.alert_type === 'BIG_DISCOUNT' ? '🔥' : '📢'}</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 500; color: var(--text-primary);">${alert.brand} - ${alert.discount_percent}% 할인</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">${truncateText(alert.product_name, 50)}</div>
                        <div style="font-size: 11px; color: var(--ap-gray); margin-top: 4px;">${new Date(alert.alert_datetime).toLocaleString('ko-KR')}</div>
                    </div>
                    ${!alert.is_sent ? '<span style="background: #fef3c7; color: #d97706; padding: 2px 6px; border-radius: 4px; font-size: 10px;">NEW</span>' : ''}
                </div>
            `).join('');
        }

        // Deals 테이블 필터링
        function filterDealsTable() {
            const brand = document.getElementById('dealsFilterBrand').value;
            if (!dealsData || !dealsData.deals) return;

            let filtered = dealsData.deals;
            if (brand) {
                filtered = filtered.filter(d => d.brand && d.brand.toLowerCase().includes(brand.toLowerCase()));
            }

            updateDealsTable(filtered);
        }

        // Deals 데이터 새로고침
        async function refreshDealsData() {
            const btn = document.querySelector('[onclick="refreshDealsData()"]');
            if (btn) {
                btn.textContent = '⏳ 로딩 중...';
                btn.disabled = true;
            }

            await loadDealsData();

            if (btn) {
                btn.textContent = '🔄 새로고침';
                btn.disabled = false;
            }
        }

        // Deals 추이 차트 업데이트
        async function updateDealsTrendChart() {
            const period = document.getElementById('dealsTrendPeriod').value;

            try {
                const response = await fetch(`${API_BASE}/api/deals/summary?days=${period}`);
                if (response.ok) {
                    const summary = await response.json();
                    initDealsTrendChart(summary.by_date || []);
                }
            } catch (error) {
                console.error('Deals trend update error:', error);
            }
        }

        // Deals 에러 표시
        function showDealsError() {
            const tbody = document.getElementById('deals-tbody');
            if (tbody) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: #ef4444; padding: 40px;">
                    ⚠️ Deals 데이터를 불러오는데 실패했습니다.<br>
                    <small>API 서버 연결을 확인하고 새로고침 버튼을 눌러주세요.</small>
                </td></tr>`;
            }
        }

        // 알림 서비스 상태 확인
        async function checkAlertServiceStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/alerts/status`);
                if (response.ok) {
                    const status = await response.json();
                    const statusDiv = document.getElementById('alert-service-status');
                    const statusText = document.getElementById('alert-status-text');

                    if (statusDiv && statusText) {
                        statusDiv.style.display = 'block';

                        const channels = [];
                        if (status.slack_enabled) channels.push('Slack ✓');
                        if (status.email_enabled) channels.push(`Email (${status.email_recipients}명) ✓`);

                        if (channels.length > 0) {
                            statusText.innerHTML = `🟢 알림 채널: ${channels.join(', ')} | 최소 할인율: ${status.min_discount_threshold}%`;
                            statusDiv.style.background = 'rgba(34, 197, 94, 0.1)';
                        } else {
                            statusText.innerHTML = '⚠️ 알림 채널이 설정되지 않았습니다. 환경변수(SLACK_WEBHOOK_URL, SMTP_*)를 설정하세요.';
                            statusDiv.style.background = 'rgba(245, 158, 11, 0.1)';
                        }
                    }
                    return status;
                }
            } catch (error) {
                console.error('Alert service status error:', error);
            }
            return null;
        }

        // 미발송 알림 발송
        async function sendPendingAlerts() {
            const btn = document.querySelector('[onclick="sendPendingAlerts()"]');
            if (btn) {
                btn.textContent = '📤 발송 중...';
                btn.disabled = true;
            }

            try {
                const response = await fetch(`${API_BASE}/api/alerts/send`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const result = await response.json();

                    if (result.sent_count > 0) {
                        alert(`✅ ${result.sent_count}개의 알림이 발송되었습니다!`);
                    } else {
                        alert('📭 발송할 미발송 알림이 없습니다.');
                    }

                    // 알림 목록 새로고침
                    await loadDealsData();
                } else {
                    throw new Error('Send failed');
                }
            } catch (error) {
                console.error('Alert send error:', error);
                alert('❌ 알림 발송에 실패했습니다. 콘솔을 확인하세요.');
            } finally {
                if (btn) {
                    btn.textContent = '📤 알림 발송';
                    btn.disabled = false;
                }
            }
        }

        // 테스트 알림 발송
        async function testAlertService() {
            const btn = document.querySelector('[onclick="testAlertService()"]');
            if (btn) {
                btn.textContent = '🧪 테스트 중...';
                btn.disabled = true;
            }

            try {
                const response = await fetch(`${API_BASE}/api/alerts/test`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const result = await response.json();

                    if (result.send_result.slack || result.send_result.email) {
                        const channels = [];
                        if (result.send_result.slack) channels.push('Slack');
                        if (result.send_result.email) channels.push('Email');
                        alert(`✅ 테스트 알림 발송 성공!\n채널: ${channels.join(', ')}`);
                    } else {
                        alert('⚠️ 테스트 알림 생성됨, 하지만 발송 채널이 설정되지 않았습니다.\n환경변수를 확인하세요.');
                    }
                } else {
                    throw new Error('Test failed');
                }
            } catch (error) {
                console.error('Test alert error:', error);
                alert('❌ 테스트 알림 발송 실패');
            } finally {
                if (btn) {
                    btn.textContent = '🧪 테스트';
                    btn.disabled = false;
                }
            }
        }

        // 페이지 로드 시 알림 서비스 상태 확인
        document.addEventListener('DOMContentLoaded', function() {
            // 약간의 딜레이 후 알림 서비스 상태 확인 (Deals 페이지 로드 시)
            setTimeout(() => {
                if (document.getElementById('page-deals')?.classList.contains('active')) {
                    checkAlertServiceStatus();
                }
            }, 1000);
        });
    </script>

    <!-- Alert Settings Modal -->
    <div id="alert-settings-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i data-lucide="bell" style="width: 20px; height: 20px; display: inline;"></i> 알림 설정</h3>
                <button onclick="closeAlertSettings()" class="modal-close">&times;</button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <!-- 이메일 입력 -->
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #1e293b;">
                        이메일 주소
                    </label>
                    <input type="email" id="alert-email"
                           placeholder="your-email@example.com"
                           style="width: 100%; padding: 12px 16px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 14px;">
                </div>

                <!-- 동의 체크박스 (중요!) -->
                <div class="consent-box" style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                    <label style="display: flex; align-items: flex-start; gap: 12px; cursor: pointer;">
                        <input type="checkbox" id="alert-consent" onchange="toggleAlertOptions()"
                               style="width: 20px; height: 20px; margin-top: 2px; accent-color: #0284c7;">
                        <div>
                            <span style="font-weight: 600; color: #0369a1;">이메일 알림 수신에 동의합니다</span>
                            <p style="font-size: 12px; color: #64748b; margin-top: 4px;">
                                순위 변동, 중요 인사이트, 시스템 에러 등의 알림을 이메일로 받습니다.<br>
                                언제든지 동의를 철회할 수 있습니다.
                            </p>
                        </div>
                    </label>
                </div>

                <!-- 알림 유형 선택 -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 12px; color: #1e293b;">
                        알림 유형 선택
                    </label>
                    <div class="alert-type-options" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <label class="alert-type-option" style="display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: #f8fafc; border-radius: 8px; cursor: pointer;">
                            <input type="checkbox" id="alert-rank-change" disabled>
                            <span style="font-size: 13px;">순위 변동</span>
                        </label>
                        <label class="alert-type-option" style="display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: #f8fafc; border-radius: 8px; cursor: pointer;">
                            <input type="checkbox" id="alert-insight" disabled>
                            <span style="font-size: 13px;">중요 인사이트</span>
                        </label>
                        <label class="alert-type-option" style="display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: #f8fafc; border-radius: 8px; cursor: pointer;">
                            <input type="checkbox" id="alert-error" disabled>
                            <span style="font-size: 13px;">에러 알림</span>
                        </label>
                        <label class="alert-type-option" style="display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: #f8fafc; border-radius: 8px; cursor: pointer;">
                            <input type="checkbox" id="alert-daily" disabled>
                            <span style="font-size: 13px;">일일 요약</span>
                        </label>
                    </div>
                </div>

                <!-- 버튼 -->
                <div style="display: flex; gap: 12px;">
                    <button onclick="saveAlertSettings()"
                            style="flex: 1; padding: 12px 20px; background: linear-gradient(135deg, #0284c7, #0369a1); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        저장
                    </button>
                    <button onclick="revokeConsent()"
                            style="padding: 12px 20px; background: #fee2e2; color: #dc2626; border: none; border-radius: 10px; font-weight: 600; cursor: pointer;">
                        동의 철회
                    </button>
                    <button onclick="closeAlertSettings()"
                            style="padding: 12px 20px; background: #f1f5f9; color: #64748b; border: none; border-radius: 10px; font-weight: 600; cursor: pointer;">
                        취소
                    </button>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Alert Settings Modal - 별도 ID 선택자 사용 */
        #alert-settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(4px);
        }
        #alert-settings-modal .modal-content {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
        }
        @keyframes modalSlideIn {
            from { opacity: 0; transform: scale(0.95) translateY(-20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        #alert-settings-modal .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #e2e8f0;
        }
        #alert-settings-modal .modal-header h3 {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
        }
        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: #f1f5f9;
            border-radius: 8px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .modal-close:hover {
            background: #e2e8f0;
        }
    </style>
</body>
</html>
